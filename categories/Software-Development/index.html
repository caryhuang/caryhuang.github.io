<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Category: Software Development - Cary&#39;s Blog</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="Cary&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/categories/Software-Development/index.html">
<meta property="og:site_name" content="Cary&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta property="article:author" content="Cary Huang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/mini4more.png" alt="Cary&#39;s Blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
                <a class="navbar-item"
                href="/about/me.html">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/categories">Categories</a></li>
            
            <li class="is-active"><a href="#" aria-current="page">Software Development</a></li>
        </ul>
        </nav>
    </div>
</div>

    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/10/29/Steaming-Replication-Setup-in-PG12-How-to-do-it-right/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Steaming-Replication-Setup-in-PG12-How-to-do-it-right">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-10-30T06:36:39.000Z">2019-10-29</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 minutes read (About 1989 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/29/Steaming-Replication-Setup-in-PG12-How-to-do-it-right/">Steaming-Replication-Setup-in-PG12-How-to-do-it-right</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>PostgreSQL 12 has been considered as a major update consisting of major performance boost with partitioning enhancements, indexing improvements, optimized planner logics and several others. One of the major changes is noticeably the removal of <code>recovery.conf</code> in a standby cluster. For this reason, the procedure to set up a streaming replication clusters has changed, and in this blog, I will demonstrate how to properly setup a streaming replication setup in PG12.</p>
<p>Streaming replication setup requires a master cluster and one or more slave clusters that will replicate the data inserted to the master by streaming the archived WAL files generated by master. The master and slaves can reside on different machines connected via network but in this blog, we will use one master and one slave setup and both will be run on the same machine with different port number.</p>
<p>The procedures illustrated in this blog is based on Postgres version 12 built from source running on Ubuntu 18.04</p>
<h3 id="2-Master-Database-Cluster-Setup"><a href="#2-Master-Database-Cluster-Setup" class="headerlink" title="2. Master Database Cluster Setup"></a>2. Master Database Cluster Setup</h3><p>Create a master database cluster using initdb tool:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ initdb /home/caryh/streaming-replication/db-master</span><br><span class="line">$ <span class="built_in">cd</span> /home/caryh/streaming-replication</span><br></pre></td></tr></table></figure>

<p>/home/caryh/streaming-replication is the root folder to all the database clusters that we will be creating in this blog and db-master directory will be created here as a result of above commands. Let’s modify the default postgreql.conf and enable several important configuration options as shown below for streaming replication setup.</p>
<figure class="highlight bash"><figcaption><span>db-master/postgresql.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">wal_level = replica</span><br><span class="line">archive_mode = on</span><br><span class="line">max_wal_senders = 10 </span><br><span class="line">wal_keep_segments = 10</span><br><span class="line">hot_standby = on</span><br><span class="line">archive_command = <span class="string">'test ! -f /home/caryh/streaming-replication/archivedir/%f &amp;&amp; cp %p /home/caryh/streaming-replication/archivedir/%f'</span></span><br><span class="line">port = 5432</span><br><span class="line">wal_log_hints = on</span><br></pre></td></tr></table></figure>
<p>The configuration above enables Postgres to archive the WAL files in the directory /home/caryh/streaming-replication/archivedir/ when it has completed writing to a full block of WAL file or when pg_basebackup command has been issued. The %f and %p used within <code>archive_command</code> are internal to Postgres and %f will be replaced with the filename of the target WAL file and %p replaced with path to the targeted WAL file. </p>
<p>It is very important when setting the <code>archive_command</code> to ensure the WAL files are archived to a location where the slave cluster can access. </p>
<p>Please note that <code>wal_log_hints</code> must be enabled for pg_rewind tool to work properly. We will discuss more about pg_rewind in the next blog post.</p>
<p>Examine the client authentication file <code>db-master/pg_hba.conf</code> and make sure the master cluster allows replication connections from a slave cluster remotely. In my case, both my master and slave will be run on the same host, so I will leave the loopback IP address as it is. If your slave cluster is located in another machine, make sure to replace the loopback address with the right one.</p>
<figure class="highlight bash"><figcaption><span>db-master/pg_hba.conf </span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Allow replication connections from 127.0.0.1, by a user with the replication privilege.</span></span><br><span class="line"><span class="comment"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line">host    replication     all             127.0.0.1/32            trust</span><br></pre></td></tr></table></figure>

<p>Let’s go ahead and start the master database cluster with the above configuration files, create a super user with permission to do replication, and a database called clusterdb</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-master start</span><br><span class="line">$ createuser cary -s --replication</span><br><span class="line">$ createdb clusterdb</span><br></pre></td></tr></table></figure>

<p>Insert some test data to the master cluster. For simplicity, we will insert 100 integers to <code>test_table</code>.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c "<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_table(x <span class="built_in">integer</span>)<span class="string">"</span></span><br><span class="line"><span class="string">CREATE TABLE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ psql -d clusterdb -U cary -c "</span><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_table(x) <span class="keyword">SELECT</span> y <span class="keyword">FROM</span> generate_series(<span class="number">1</span>, <span class="number">100</span>) a(y)<span class="string">"</span></span><br><span class="line"><span class="string">INSERT 0 100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ psql -d clusterdb -U cary -c "</span><span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test_table<span class="string">"</span></span><br><span class="line"><span class="string"> count </span></span><br><span class="line"><span class="string">-------</span></span><br><span class="line"><span class="string">   100</span></span><br><span class="line"><span class="string">(1 row)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Slave-Database-Cluster-Setup"><a href="#3-Slave-Database-Cluster-Setup" class="headerlink" title="3. Slave Database Cluster Setup"></a>3. Slave Database Cluster Setup</h3><p>The goal of setting up the slave cluster is to make a backup of the current master and set it up as a standby server, meaning it will stream the WAL file updates from the master and perform replication of the data.</p>
<p>Postgres provides several tools and methods to perform physical database backup. Exclusive methods such as <code>pg_start_backup(&#39;label&#39;)</code> and <code>pg_stop_backup()</code> are quite common in earlier Postgres versions. In this blog, we will use the newer, and simpler non-exclusive <code>pg_basebackup</code> fronend tool to execute the backup. There are advantages and disadvantaged for both methods and this discussion is not within the scope of this blog. This article here provides very good explaination on both methods: <a href="https://www.cybertec-postgresql.com/en/exclusive-backup-deprecated-what-now/">https://www.cybertec-postgresql.com/en/exclusive-backup-deprecated-what-now/</a></p>
<p>Let’s use pg_basebackup to create the slave cluster.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_basebackup -h 127.0.0.1 -U cary -p 5432 -D db-slave -P -Xs -R</span><br><span class="line">31373/31373 kB (100%), 1/1 tablespace</span><br></pre></td></tr></table></figure>
<p>where:<br>-h is the IP of the master cluster<br>-U is the username that is permitted to do replication<br>-p is the port number of the running master cluster<br>-D is the directory where we want to set up the slave database cluster<br>-P to show the progress<br>-Xs to select WAL streaming method<br>-R to write a recovery.conf file.</p>
<p>This step is where it would differ from the previous PG versions. The -R command will no longer output a recovery.conf file in the db-slave directory. </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls db-slave</span><br><span class="line">backup_label  pg_dynshmem    pg_multixact  pg_snapshots  pg_tblspc    pg_xact</span><br><span class="line">base          pg_hba.conf    pg_notify     pg_stat       pg_twophase  postgresql.auto.conf</span><br><span class="line">global        pg_ident.conf  pg_replslot   pg_stat_tmp   PG_VERSION   postgresql.conf</span><br><span class="line">pg_commit_ts  pg_logical     pg_serial     pg_subtrans   pg_wal       standby.signal</span><br></pre></td></tr></table></figure>
<p>The contents of the old recovery.conf file are moved to <code>postgresql.conf</code> and <code>postgresql.auto.conf</code> instead.</p>
<p>Let’s examine <code>db-slave/postgresql.auto.conf</code> first, and we will see that pg_basebackup already created the <code>primary_conninfo</code> for us. This line used to be located in <code>recovery.conf</code> and it tells where and how a slave cluster should stream from the master cluster. Make sure this line is present in the <code>postgresql.auto.conf</code>. </p>
<figure class="highlight bash"><figcaption><span>db-slave/postgresql.auto.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Do not edit this file manually!</span></span><br><span class="line"><span class="comment"># It will be overwritten by the ALTER SYSTEM command.</span></span><br><span class="line">primary_conninfo = <span class="string">'user=cary passfile='</span><span class="string">'/home/caryh/.pgpass'</span><span class="string">' host=127.0.0.1 port=5432 sslmode=prefer sslcompression=0 gssencmode=disable target_session_attrs=any'</span></span><br></pre></td></tr></table></figure>

<p>Let’s examine <code>db-slave/postgresql.conf</code> and update some of the parameters.</p>
<figure class="highlight bash"><figcaption><span>db-slave/postgresql.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">wal_level = replica</span><br><span class="line">archive_mode = on</span><br><span class="line">max_wal_senders = 10 </span><br><span class="line">wal_keep_segments = 10</span><br><span class="line">hot_standby = on</span><br><span class="line">archive_command = <span class="string">'test ! -f /home/caryh/streaming-replication/archivedir/%f &amp;&amp; cp %p /home/caryh/streaming-replication/archivedir/%f'</span></span><br><span class="line">wal_log_hints = on</span><br><span class="line">port = 5433</span><br><span class="line">restore_command = <span class="string">'cp /home/caryh/streaming-replication/archivedir/%f %p'</span></span><br><span class="line">archive_cleanup_command = <span class="string">'pg_archivecleanup /home/caryh/streaming-replication/archivedir %r'</span></span><br></pre></td></tr></table></figure>

<p>Since <code>db-slave/postgresql.conf</code> is directly copied from master cluster via pg_basebackup, we will need to change the <code>port</code> to some port different (5433 in this case) from the master since both are running on the same machine. We will need to fill the <code>restore_command</code> and <code>archive_cleanup_command</code> so the slave cluster knows how to get the archived WAL files for streaming purposes. These two parameters used to be defined in <code>recovery.conf</code> and are moved to <code>postgresql.conf</code> in PG12.</p>
<p>In the db-slave directory, please note that a new <code>standby.signal</code> file is created automatically by <code>pg_basebackup</code> to indicate that this slave cluster will be run in <code>standby</code> mode. The <code>standby.signal</code> file is a new addition in PG12 to replace <code>standby_mode = &#39;on&#39;</code> that used to be defined in <code>recovery.conf</code>. If this file is not present, make sure it is created by:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ touch db-slave/standby.signal</span><br></pre></td></tr></table></figure>

<p>Now, let’s start the slave cluster:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-slave start</span><br></pre></td></tr></table></figure>

<h3 id="4-Verify-the-Streaming-Replication-Setup"><a href="#4-Verify-the-Streaming-Replication-Setup" class="headerlink" title="4. Verify the Streaming Replication Setup"></a>4. Verify the Streaming Replication Setup</h3><p>Once both master and slave clusters are setup and running, we should see from the <code>ps -ef</code> command that some of the backend processes are started to achieve the replication, namely, <code>walsender</code> and <code>walreceiver</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -ef | grep postgres</span><br><span class="line">caryh    12782  2921  0 16:12 ?        00:00:00 /usr/<span class="built_in">local</span>/pgsql/bin/postgres -D db-master</span><br><span class="line">caryh    12784 12782  0 16:12 ?        00:00:00 postgres: checkpointer   </span><br><span class="line">caryh    12785 12782  0 16:12 ?        00:00:00 postgres: background writer   </span><br><span class="line">caryh    12786 12782  0 16:12 ?        00:00:00 postgres: walwriter   </span><br><span class="line">caryh    12787 12782  0 16:12 ?        00:00:00 postgres: autovacuum launcher   </span><br><span class="line">caryh    12788 12782  0 16:12 ?        00:00:00 postgres: archiver   last was 000000010000000000000002.00000028.backup</span><br><span class="line">caryh    12789 12782  0 16:12 ?        00:00:00 postgres: stats collector   </span><br><span class="line">caryh    12790 12782  0 16:12 ?        00:00:00 postgres: logical replication launcher   </span><br><span class="line">caryh    15702  2921  0 17:06 ?        00:00:00 /usr/<span class="built_in">local</span>/pgsql/bin/postgres -D db-slave</span><br><span class="line">caryh    15703 15702  0 17:06 ?        00:00:00 postgres: startup   recovering 000000010000000000000003</span><br><span class="line">caryh    15708 15702  0 17:06 ?        00:00:00 postgres: checkpointer   </span><br><span class="line">caryh    15709 15702  0 17:06 ?        00:00:00 postgres: background writer   </span><br><span class="line">caryh    15711 15702  0 17:06 ?        00:00:00 postgres: stats collector   </span><br><span class="line">caryh    15713 15702  0 17:06 ?        00:00:00 postgres: walreceiver   streaming 0/3000148</span><br><span class="line">caryh    15714 12782  0 17:06 ?        00:00:00 postgres: walsender cary 127.0.0.1(59088) streaming 0/3000148</span><br><span class="line">caryh    15728 10962  0 17:06 pts/5    00:00:00 grep --color=auto post</span><br></pre></td></tr></table></figure>

<p>We can also check the replication status in details by issuing a query to the master cluster:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_stat_replication;"</span> -x -p 5432</span><br><span class="line">-[ RECORD 1 ]----+------------------------------</span><br><span class="line">pid              | 15714</span><br><span class="line">usesysid         | 16384</span><br><span class="line">usename          | cary</span><br><span class="line">application_name | walreceiver</span><br><span class="line">client_addr      | 127.0.0.1</span><br><span class="line">client_hostname  | </span><br><span class="line">client_port      | 59088</span><br><span class="line">backend_start    | 2019-10-29 17:06:49.072082-07</span><br><span class="line">backend_xmin     | </span><br><span class="line">state            | streaming</span><br><span class="line">sent_lsn         | 0/3000148</span><br><span class="line">write_lsn        | 0/3000148</span><br><span class="line">flush_lsn        | 0/3000148</span><br><span class="line">replay_lsn       | 0/3000148</span><br><span class="line">write_lag        | </span><br><span class="line">flush_lag        | </span><br><span class="line">replay_lag       | </span><br><span class="line">sync_priority    | 0</span><br><span class="line">sync_state       | async</span><br><span class="line">reply_time       | 2019-10-29 17:10:09.515563-07</span><br></pre></td></tr></table></figure>

<p>Lastly, we can insert additional data to the master cluster and verify that slave also has the data updated.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Query slave cluster</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5433</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   100</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Query master cluster</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5432</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   100</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Insert more data to master cluster</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"INSERT INTO test_table(x) SELECT y FROM generate_series(1, 100) a(y)"</span> -p 5432</span><br><span class="line">INSERT 0 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># Query slave cluster again</span></span><br><span class="line">psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5433</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   200</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>Both master and slave clusters are now in sync.</p>
<h3 id="5-Setup-Replication-Slots"><a href="#5-Setup-Replication-Slots" class="headerlink" title="5. Setup Replication Slots"></a>5. Setup Replication Slots</h3><p>The previous steps illustrate how to correctly setup streaming replication between a master and slave cluster. However, there may be a case where the slave can be disconnected for some reason for extended period of time and may fail to replicate with the master when some of the un-replicated WAL files are recycled or deleted from the master cluster controlled by <code>wal_keep_segments</code> parameter. </p>
<p>Replication slots ensure master can retain enough WAL segments for all slaves to receive them and prevent the master from removing rows that could cause a recovery conflict on the slaves.</p>
<p>Let’s create a replication slot on the master cluster called <code>slave</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_create_physical_replication_slot('slave')"</span> -p 5432</span><br><span class="line"> slot_name | lsn </span><br><span class="line">-----------+-----</span><br><span class="line"> slave     | </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_replication_slots"</span> -x -p 5432</span><br><span class="line">-[ RECORD 1 ]-------+---------</span><br><span class="line">slot_name           | slave</span><br><span class="line">plugin              | </span><br><span class="line">slot_type           | physical</span><br><span class="line">datoid              | </span><br><span class="line">database            | </span><br><span class="line">temporary           | f</span><br><span class="line">active              | f</span><br><span class="line">active_pid          | </span><br><span class="line">xmin                | </span><br><span class="line">catalog_xmin        | </span><br><span class="line">restart_lsn         | </span><br><span class="line">confirmed_flush_lsn |</span><br></pre></td></tr></table></figure>

<p>We have just created replication slot on master called <code>slave</code> and it is currently not active (active = f).</p>
<p>Let’s modify slave’s <code>postgresql.conf</code> and make it connect to the master’s replication slot</p>
<figure class="highlight bash"><figcaption><span>db-slave/postgresql.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">primary_slot_name = <span class="string">'slave'</span></span><br></pre></td></tr></table></figure>

<p>Please note that this argument <code>primary_slot_name</code> us also used to be defined in <code>recovery.conf</code> and moved to <code>postgresql.conf</code> in PG12. After the change, we are required to restart the slave.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-slave stop</span><br><span class="line">$ pg_ctl -D db-slave start</span><br></pre></td></tr></table></figure>

<p>If all is good, checking the replication slots on master should have the slot status as active.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_replication_slots"</span> -x -p 5432</span><br><span class="line">-[ RECORD 1 ]-------+----------</span><br><span class="line">slot_name           | slave</span><br><span class="line">plugin              | </span><br><span class="line">slot_type           | physical</span><br><span class="line">datoid              | </span><br><span class="line">database            | </span><br><span class="line">temporary           | f</span><br><span class="line">active              | t</span><br><span class="line">active_pid          | 16652</span><br><span class="line">xmin                | </span><br><span class="line">catalog_xmin        | </span><br><span class="line">restart_lsn         | 0/3003B98</span><br><span class="line">confirmed_flush_lsn |</span><br></pre></td></tr></table></figure>

<h3 id="6-Summary"><a href="#6-Summary" class="headerlink" title="6. Summary"></a>6. Summary</h3><p>In this blog, we have discussed the updated procedures to setup streaming replication clusters in PG12, in which several steps have been changed from the older versions, particularly the removal of <code>recovery.conf</code>. </p>
<p>Here is a short list of changes related to replication setup that have been moved from <code>recovery.conf</code></p>
<ul>
<li>restore_command             =&gt; moved to <code>postgresql.conf</code></li>
<li>recovery_target_timeline    =&gt; moved to <code>postgresql.conf</code></li>
<li>standby_mode                =&gt; replaced by <code>standby.signal</code></li>
<li>primary_conninfo            =&gt; moved to <code>postgresql.conf</code> or <code>postgresql.auto.conf</code></li>
<li>archive_cleanup_command     =&gt; moved to <code>postgresql.conf</code></li>
<li>primary_slot_name           =&gt; moved to <code>postgresql.conf</code></li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/09/27/Replication-Failover-with-pg-rewind-in-PG12/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Replication-Failover-with-pg_rewind-in-PG12">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-28T06:36:52.000Z">2019-09-27</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 minutes read (About 1480 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/27/Replication-Failover-with-pg-rewind-in-PG12/">Replication-Failover-with-pg_rewind-in-PG12</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>In the previous blog, we have discussed how to correctly set up streaming replication clusters between one master and one slave in Postgres version 12. In this blog, we will simulate a failover scenario on the master database, which causes the replica (or slave) database cluster to be promoted as new master and continue the operation. We will also simulate a failback scenario to reuse the old master cluster after the failover scenario with the help of pg_rewind. </p>
<p>Normally it is quite easy to do a failback to the old master after slave gets promoted to master but if there is data written to the old master after slave promotion, we will have an out-of-sync case between them both and we will have to use the pg_rewind tool to synchronize the two data directories in order to bring the old master to match the state of the new master. Please note that the pg_rewind tool will remove transactions from the old master in order to match up with the new, so certain pre-caution is needed to use this tool.</p>
<p>Here’s a brief overview of list of actions we are going to perform:</p>
<ul>
<li>simulate failover by promoting <code>slave</code> cluster, so it becomes a <code>new master</code></li>
<li>simulate data insertion to <code>master</code> cluster, also referred as <code>old master</code> after promotion</li>
<li>shutdown the <code>old master</code> cluster and set it up as a standby server</li>
<li>run pg_rewind on <code>old master</code> to synchronize transaction states with <code>new master</code></li>
<li>bring up <code>old master</code> as a standby server to synchronize with the <code>new master</code></li>
</ul>
<p>This blog assumes you already have streaming replication setup between one master and one slave from previous blog. If you have not checked out the previous blog titled “Streaming Replication Setup in PG12 - How to Do it Right”, it is recommended to give that a read first.</p>
<p>The procedures illustrated in this blog is based on Postgres version 12 built from source running on Ubuntu 18.04</p>
<h3 id="2-Simulate-a-Failover-Case"><a href="#2-Simulate-a-Failover-Case" class="headerlink" title="2. Simulate a Failover Case"></a>2. Simulate a Failover Case</h3><p>We will simply promote the slave database cluster to simulate a failover.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl promote -D db-slave</span><br><span class="line"></span><br><span class="line">2019-10-30 11:10:16.951 PDT [16643] LOG:  received promote request</span><br><span class="line">2019-10-30 11:10:16.951 PDT [16651] FATAL:  terminating walreceiver process due to administrator <span class="built_in">command</span></span><br><span class="line">2019-10-30 11:10:16.966 PDT [16643] LOG:  redo <span class="keyword">done</span> at 0/3003B60</span><br><span class="line">2019-10-30 11:10:16.991 PDT [16643] LOG:  selected new timeline ID: 2</span><br><span class="line">2019-10-30 11:10:17.030 PDT [16643] LOG:  archive recovery complete</span><br><span class="line">2019-10-30 11:10:17.051 PDT [16642] LOG:  database system is ready to accept connections</span><br></pre></td></tr></table></figure>

<p>As seen above, After <code>slave</code> gets promoted, it switches to a new timeline for future data operations. At this point the <code>master</code> and <code>slave</code> are no longer streaming WAL files from each other and we essentialyl have two independent database clusters running. We will call them <code>old master</code> and <code>new master</code> in the following sections instead so it is clear.</p>
<h3 id="3-Insert-Some-Data-to-the-Old-Master"><a href="#3-Insert-Some-Data-to-the-Old-Master" class="headerlink" title="3. Insert Some Data to the Old Master"></a>3. Insert Some Data to the Old Master</h3><p>We would like to create a data out-of-sync case by inserting some more data to the <code>old master</code> cluster.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"INSERT INTO test_table(x) SELECT y FROM generate_series(1, 100) a(y);"</span> -p 5432</span><br><span class="line">INSERT 0 100</span><br></pre></td></tr></table></figure>

<p>Check that both the <code>old master</code> and <code>new master</code> are clearly out of sync:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## new master ##</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5433</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   200</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="comment">## old master ##</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5432</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   300</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<h3 id="4-Configure-the-Old-Master-as-Standby-Server-to-Sync-with-New-Master"><a href="#4-Configure-the-Old-Master-as-Standby-Server-to-Sync-with-New-Master" class="headerlink" title="4. Configure the Old Master as Standby Server to Sync with New Master"></a>4. Configure the Old Master as Standby Server to Sync with New Master</h3><p>Now we would like to attempt a failover to make the <code>old master</code> as a standy server to syncrhonize with the <code>new master</code>.</p>
<p>Let’s shutdown the <code>old master</code> cluster.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-master stop</span><br><span class="line">waiting <span class="keyword">for</span> server to shut down.... <span class="keyword">done</span></span><br><span class="line">server stopped</span><br></pre></td></tr></table></figure>

<p>Let’s update postgresql.conf in the <code>old master</code>:</p>
<figure class="highlight bash"><figcaption><span>db-master/postgresql.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">recovery_target_timeline = <span class="string">'latest'</span></span><br><span class="line">archive_cleanup_command = <span class="string">'pg_archivecleanup /home/caryh/streaming-replication/archivedir %r'</span></span><br><span class="line">restore_command = <span class="string">'cp /home/caryh/streaming-replication/archivedir/%f %p'</span></span><br><span class="line">primary_slot_name = <span class="string">'main'</span></span><br><span class="line">primary_conninfo = <span class="string">'user=cary passfile='</span><span class="string">'/home/caryh/.pgpass'</span><span class="string">' host=127.0.0.1 port=5433 sslmode=prefer sslcompression=0 gssencmode=disable target_session_attrs=any'</span></span><br></pre></td></tr></table></figure>

<p>the <code>primary_conninfo</code> tells the <code>old master</code> to stream WAL files from the <code>new master</code> located at 127.0.0.1:5433.</p>
<p>Also, do not forget to touch the <code>standby.signal</code> file to tell the cluster to run in standby mode:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch db-master/standby.signal</span><br></pre></td></tr></table></figure>

<p>We specified in the <code>old master</code> to connect to <code>primary_slot_name</code> = <code>main</code>. Let’s create the matching replication slot on the <code>new master</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_create_physical_replication_slot('main');"</span> -p 5433</span><br><span class="line"> slot_name | lsn </span><br><span class="line">-----------+-----</span><br><span class="line"> main      | </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"select * from pg_replication_slots;"</span> -p 5433 -x</span><br><span class="line">-[ RECORD 1 ]-------+---------</span><br><span class="line">slot_name           | main</span><br><span class="line">plugin              | </span><br><span class="line">slot_type           | physical</span><br><span class="line">datoid              | </span><br><span class="line">database            | </span><br><span class="line">temporary           | f</span><br><span class="line">active              | f</span><br><span class="line">active_pid          | </span><br><span class="line">xmin                | </span><br><span class="line">catalog_xmin        | </span><br><span class="line">restart_lsn         | </span><br><span class="line">confirmed_flush_lsn |</span><br></pre></td></tr></table></figure>

<p>Now the <code>new master</code> has a matching replication slot called <code>main</code> and it is not active at the moment. Now we are ready to start the <code>old master</code> as standby server</p>
<h3 id="5-Start-the-Old-Master-as-Standby-Server"><a href="#5-Start-the-Old-Master-as-Standby-Server" class="headerlink" title="5. Start the Old Master as Standby Server"></a>5. Start the Old Master as Standby Server</h3><p>Now, we are ready to start the <code>old master</code> as a standby:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-master start</span><br><span class="line"></span><br><span class="line">2019-10-30 11:30:04.071 PDT [1610] HINT:  Future <span class="built_in">log</span> output will go to <span class="built_in">log</span> destination <span class="string">"syslog"</span>.</span><br><span class="line">2019-10-30 11:30:04.075 PDT [1611] LOG:  database system was shut down at 2019-10-30 11:29:13 PDT</span><br><span class="line">2019-10-30 11:30:04.079 PDT [1611] LOG:  restored <span class="built_in">log</span> file <span class="string">"00000002.history"</span> from archive</span><br><span class="line">2019-10-30 11:30:04.082 PDT [1611] LOG:  entering standby mode</span><br><span class="line">2019-10-30 11:30:04.084 PDT [1611] LOG:  restored <span class="built_in">log</span> file <span class="string">"00000002.history"</span> from archive</span><br><span class="line">2019-10-30 11:30:04.095 PDT [1611] FATAL:  requested timeline 2 is not a child of this server<span class="string">'s history</span></span><br><span class="line"><span class="string">2019-10-30 11:30:04.095 PDT [1611] DETAIL:  Latest checkpoint is at 0/4000028 on timeline 1, but in the history of the requested timeline, the server forked off from that timeline at 0/3003B98.</span></span><br><span class="line"><span class="string">2019-10-30 11:30:04.096 PDT [1610] LOG:  startup process (PID 1611) exited with exit code 1</span></span><br><span class="line"><span class="string">2019-10-30 11:30:04.096 PDT [1610] LOG:  aborting startup due to startup process failure</span></span><br><span class="line"><span class="string">2019-10-30 11:30:04.098 PDT [1610] LOG:  database system is shut down</span></span><br></pre></td></tr></table></figure>

<p>As you can see above, the <code>old master</code> refuses to start because there is a timeline difference between the <code>old master</code> and the <code>new master</code>. This is caused by the additional data insertions that happens to the <code>old master</code> after the promotion event in step number 3. </p>
<p>This is where pg_rewind comes handy in situation like this, to synchronize the two clusters.</p>
<h3 id="6-Use-pg-rewind-to-Synchronize-the-two-Clusters"><a href="#6-Use-pg-rewind-to-Synchronize-the-two-Clusters" class="headerlink" title="6. Use pg_rewind to Synchronize the two Clusters"></a>6. Use pg_rewind to Synchronize the two Clusters</h3><p>Now, let’s synchronize the two database clusters with pg_rewind.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_rewind --target-pgdata=db-master --<span class="built_in">source</span>-server=<span class="string">"port=5433 user=cary dbname=clusterdb"</span> --progress</span><br><span class="line">pg_rewind: connected to server</span><br><span class="line">pg_rewind: servers diverged at WAL location 0/3003E58 on timeline 1</span><br><span class="line">pg_rewind: rewinding from last common checkpoint at 0/2000060 on timeline 1</span><br><span class="line">pg_rewind: reading <span class="built_in">source</span> file list</span><br><span class="line">pg_rewind: reading target file list</span><br><span class="line">pg_rewind: reading WAL <span class="keyword">in</span> target</span><br><span class="line">pg_rewind: need to copy 53 MB (total <span class="built_in">source</span> directory size is 78 MB)</span><br><span class="line">54363/54363 kB (100%) copied</span><br><span class="line">pg_rewind: creating backup label and updating control file</span><br><span class="line">pg_rewind: syncing target data directory</span><br><span class="line">pg_rewind: Done!</span><br></pre></td></tr></table></figure>
<p>After pg_rewind is finished, we will have to edit once more the configuration of the <code>old master</code> because the tool copies most of the configuration settings from the <code>new master</code> to the <code>old master</code> as a synchronization process. Let’s examine both <code>db-master/postgresql.auto.conf</code> and <code>db-master/postgresql.conf</code> and make sure of the followings again.</p>
<figure class="highlight bash"><figcaption><span>db-master/postgresql.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">############# db-master/postgresql.conf #############</span></span><br><span class="line">primary_slot_name = <span class="string">'main'</span></span><br><span class="line">recovery_target_timeline = <span class="string">'latest'</span></span><br><span class="line">port = 5432</span><br><span class="line"></span><br><span class="line"><span class="comment">############# db-master/postgresql.auto.conf #############</span></span><br><span class="line">primary_conninfo = <span class="string">'user=cary passfile='</span><span class="string">'/home/caryh/.pgpass'</span><span class="string">' host=127.0.0.1 port=5433 sslmode=disable sslcompression=0 gssencmode=disable target_session_attrs=any'</span></span><br></pre></td></tr></table></figure>

<p>and also, don’t forget about this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch db-master/standby.signal</span><br></pre></td></tr></table></figure>
<p>Now, we should be ready to start the <code>old master</code> again.</p>
<h3 id="7-Start-the-Old-Master-Agian-as-Standby-Server"><a href="#7-Start-the-Old-Master-Agian-as-Standby-Server" class="headerlink" title="7. Start the Old Master Agian as Standby Server"></a>7. Start the Old Master Agian as Standby Server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pg_ctl -D db-master start</span><br><span class="line"></span><br><span class="line">2019-10-30 12:27:28.140 PDT [5095] LOG:  restored <span class="built_in">log</span> file <span class="string">"000000010000000000000002"</span> from archive</span><br><span class="line">2019-10-30 12:27:28.167 PDT [5095] LOG:  redo starts at 0/2000028</span><br><span class="line">2019-10-30 12:27:28.182 PDT [5095] LOG:  consistent recovery state reached at 0/3027258</span><br><span class="line">2019-10-30 12:27:28.183 PDT [5095] LOG:  invalid record length at 0/3027258: wanted 24, got 0</span><br><span class="line">2019-10-30 12:27:28.183 PDT [5095] LOG:  redo <span class="keyword">done</span> at 0/3027230</span><br><span class="line">2019-10-30 12:27:28.183 PDT [5095] LOG:  last completed transaction was at <span class="built_in">log</span> time 2019-10-30 12:20:34.056723-07</span><br><span class="line">019-10-30 12:27:28.226 PDT [5094] LOG:  database system is ready to accept connections</span><br></pre></td></tr></table></figure>

<p>The <code>old master</code> can now start as a streaming replication to the <code>new master</code> and we can observe that after using pg_rewind the additional data that was inserted to <code>old master</code> in step number 3 is now removed, as it has been <code>rewound</code> from 300 entries to 200 entries to match up with the <code>new master</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## new master ##</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5433</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   200</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="comment">## old master ##</span></span><br><span class="line">$ psql -d clusterdb -U cary -c <span class="string">"SELECT count(*) from test_table"</span> -p 5432</span><br><span class="line"> count </span><br><span class="line">-------</span><br><span class="line">   200</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<h3 id="8-Summary"><a href="#8-Summary" class="headerlink" title="8. Summary"></a>8. Summary</h3><p>In this blog, we have simulated a failover case and observe the effect of promoting a standby <code>slave</code> server while more data insertions happening to the original <code>master</code> server. We have demonstrated how to use <code>pg_rewind</code> tool to synchronize both <code>master</code> and <code>slave</code> after the <code>slave</code> promotion. Though it results some data deletion at the original <code>master</code>, in the end, we are able to resolve the timeline conflict with <code>pg_rewind</code> and complete the database failover scenario.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/09/27/Trace-Postgres-query-processing-internals-with-debugger/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Trace-Postgres-query-processing-internals-with-debugger">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-28T06:36:24.000Z">2019-09-27</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    32 minutes read (About 4768 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/27/Trace-Postgres-query-processing-internals-with-debugger/">Trace-Postgres-query-processing-internals-with-debugger</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>In this article we will use GDB debugger to trace the internals of Postgres and observe how an input query passes through several levels of transformation (Parser -&gt; Analyzer -&gt; Rewriter -&gt; Planner -&gt; Executor) and eventually produces an output. </p>
<p>This article is based on PG12 running on Ubuntu 18.04,  and we will use a simple <code>SELECT</code> query with <code>ORDER BY</code> , <code>GROUP BY</code>, and <code>LIMIT</code> keywords to go through the entire query processing tracing.</p>
<h3 id="2-Preparation"><a href="#2-Preparation" class="headerlink" title="2. Preparation"></a>2. Preparation</h3><p>GDB debugger is required to be installed to trace the internals of Postgres. Most recent distribution of Linux already comes with gdb pre-installed. If you do not have it, please install.</p>
<h4 id="2-1-Enable-Debugging-and-Disable-Compiler-Optimization-on-PG-Build"><a href="#2-1-Enable-Debugging-and-Disable-Compiler-Optimization-on-PG-Build" class="headerlink" title="2.1 Enable Debugging and Disable Compiler Optimization on PG Build"></a>2.1 Enable Debugging and Disable Compiler Optimization on PG Build</h4><p>For GDB to be useful, the postgres binaries have to be compiled with debugging symbols enabled (-g). In addition, I would suggest to turn off compiler optimization (-O0) such that while tracing we will be able to examine all memory blocks and values, and observe the execution flow properly.</p>
<p>Enable debugging using the ./configure utility in the Postgres source code repository</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> [PG_SOURCE_DIR]</span><br><span class="line">./configure --<span class="built_in">enable</span>-debug</span><br></pre></td></tr></table></figure>

<p>This will add the (-g) parameter to the CFLAGS in the main Makefile to include debugging symbols.</p>
<p>Once finished, let’s disable compiler optimization by editing </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">src/Makefile.global</span><br></pre></td></tr></table></figure>
<p>Find the line where CFLAGS is defined and changed -O2 to -O0 like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CFLAGS &#x3D; -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror&#x3D;vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision&#x3D;standard -Wno-format-truncation -g -O0</span><br></pre></td></tr></table></figure>
<p>Then we need to build and install with the new Makefile</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h4 id="2-2-Initialize-Postgres-Server"><a href="#2-2-Initialize-Postgres-Server" class="headerlink" title="2.2 Initialize Postgres Server"></a>2.2 Initialize Postgres Server</h4><p>For a new build, we will need to initialize a new database</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">initDb /home/caryh/postgresql</span><br><span class="line">create user caryh</span><br><span class="line">createdb carytest</span><br></pre></td></tr></table></figure>

<p>For referencing purposes, I would suggest enable debug log for the Postgres server by modifying postgres.conf located in database home directory. In this case it is located in </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/home/caryh/postgresql/postgres.conf</span><br></pre></td></tr></table></figure>

<p>Enable the following lines in postgres.conf</p>
<figure class="highlight bash"><figcaption><span>postgres.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">log_destination = <span class="string">'syslog'</span></span><br><span class="line">syslog_facility = <span class="string">'LOCAL0'</span></span><br><span class="line">syslog_ident = <span class="string">'postgres'</span></span><br><span class="line">syslog_sequence_numbers = on</span><br><span class="line">syslog_split_messages = on</span><br><span class="line"></span><br><span class="line">debug_print_parse = on</span><br><span class="line">debug_print_rewritten = on</span><br><span class="line">debug_print_plan = on</span><br><span class="line">debug_pretty_print = on</span><br><span class="line">log_checkpoints = on</span><br><span class="line">log_connections = on</span><br><span class="line">log_disconnections = on</span><br><span class="line">log_duration = on</span><br></pre></td></tr></table></figure>

<p>Why do we enable debug log when we will be tracing postgres with gdb? This is because the output at some of the stages of query processing is represented as a complex list of structures and it is not very straightforward to print this structure unless we have written a third party print script that can help us recursively print the content of the complex structure. Postgres already has this function built-in and presented in the form of a debugging log. </p>
<h4 id="2-3-Start-Postgres-Server-and-Connect-with-Client-Tool"><a href="#2-3-Start-Postgres-Server-and-Connect-with-Client-Tool" class="headerlink" title="2.3 Start Postgres Server and Connect with Client Tool"></a>2.3 Start Postgres Server and Connect with Client Tool</h4><p>Start the PG database</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pg_ctl -D /home/caryh/postgresql start</span><br></pre></td></tr></table></figure>
<p>Connect to PG database as user</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">psql -d carytest -U cary</span><br></pre></td></tr></table></figure>

<h4 id="2-4-Populate-Example-Tables-and-Values"><a href="#2-4-Populate-Example-Tables-and-Values" class="headerlink" title="2.4 Populate Example Tables and Values"></a>2.4 Populate Example Tables and Values</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> deviceinfo (</span><br><span class="line">  serial_number <span class="built_in">varchar</span>(<span class="number">45</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">  manufacturer <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">  device_type <span class="built_in">int</span>,</span><br><span class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">  registration_time <span class="built_in">timestamp</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> devicedata (</span><br><span class="line">  serial_number <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">REFERENCES</span> deviceinfo(serial_number),</span><br><span class="line">  record_time <span class="built_in">timestamp</span>,</span><br><span class="line">  uptime <span class="built_in">int</span>,</span><br><span class="line">  temperature <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  voltage <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  <span class="keyword">power</span> <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  firmware_version <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">  configuration_file <span class="built_in">varchar</span>(<span class="number">45</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> deviceinfo <span class="keyword">VALUES</span>( <span class="string">'X00001'</span>, <span class="string">'Highgo Inc'</span>, <span class="number">1</span>, <span class="string">'password'</span>, <span class="string">'2019-09-18 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> deviceinfo <span class="keyword">VALUES</span>( <span class="string">'X00002'</span>, <span class="string">'Highgo Inc'</span>, <span class="number">2</span>, <span class="string">'password'</span>, <span class="string">'2019-09-18 17:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> deviceinfo <span class="keyword">VALUES</span>( <span class="string">'X00003'</span>, <span class="string">'Highgo Inc'</span>, <span class="number">1</span>, <span class="string">'password'</span>, <span class="string">'2019-09-18 18:00:00'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00001'</span>, <span class="string">'2019-09-20 16:00:00'</span>, <span class="number">2000</span>, <span class="number">38.23</span>, <span class="number">189.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00001'</span>, <span class="string">'2019-09-20 17:00:00'</span>, <span class="number">3000</span>, <span class="number">68.23</span>, <span class="number">221.00</span>, <span class="number">675.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00001'</span>, <span class="string">'2019-09-20 18:00:00'</span>, <span class="number">4000</span>, <span class="number">70.23</span>, <span class="number">220.00</span>, <span class="number">333.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00001'</span>, <span class="string">'2019-09-20 19:00:00'</span>, <span class="number">5000</span>, <span class="number">124.23</span>, <span class="number">88.00</span>, <span class="number">678.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 11:00:00'</span>, <span class="number">8000</span>, <span class="number">234.23</span>, <span class="number">567.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 12:00:00'</span>, <span class="number">9000</span>, <span class="number">56.23</span>, <span class="number">234.00</span>, <span class="number">345.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 13:00:00'</span>, <span class="number">3000</span>, <span class="number">12.23</span>, <span class="number">56.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 14:00:00'</span>, <span class="number">4000</span>, <span class="number">56.23</span>, <span class="number">77.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 11:00:00'</span>, <span class="number">8000</span>, <span class="number">234.23</span>, <span class="number">567.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 12:00:00'</span>, <span class="number">9000</span>, <span class="number">56.23</span>, <span class="number">234.00</span>, <span class="number">345.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 13:00:00'</span>, <span class="number">3000</span>, <span class="number">12.23</span>, <span class="number">56.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00002'</span>, <span class="string">'2019-09-20 14:00:00'</span>, <span class="number">4000</span>, <span class="number">56.23</span>, <span class="number">77.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 07:00:00'</span>, <span class="number">25000</span>, <span class="number">68.23</span>, <span class="number">99.00</span>, <span class="number">43.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 08:00:00'</span>, <span class="number">20600</span>, <span class="number">178.23</span>, <span class="number">333.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 09:00:00'</span>, <span class="number">20070</span>, <span class="number">5.23</span>, <span class="number">33.00</span>, <span class="number">123.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 10:00:00'</span>, <span class="number">200043</span>, <span class="number">45.23</span>, <span class="number">45.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 09:00:00'</span>, <span class="number">20070</span>, <span class="number">5.23</span>, <span class="number">33.00</span>, <span class="number">123.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> devicedata <span class="keyword">VALUES</span> (<span class="string">'X00003'</span>, <span class="string">'2019-09-20 10:00:00'</span>, <span class="number">200043</span>, <span class="number">45.23</span>, <span class="number">45.00</span>, <span class="number">456.1</span>, <span class="string">'version01'</span>, <span class="string">'config01'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-Start-gdb-Debugger"><a href="#3-Start-gdb-Debugger" class="headerlink" title="3. Start gdb Debugger"></a>3. Start gdb Debugger</h3><p>Find the PID of the connecting client PG session</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -ef | grep postgres</span><br><span class="line">caryh     7072  1946  0 Sep26 ?        00:00:01 /usr/<span class="built_in">local</span>/pgsql/bin/postgres -D /home/caryh/postgresql</span><br><span class="line">caryh     7074  7072  0 Sep26 ?        00:00:00 postgres: checkpointer   </span><br><span class="line">caryh     7075  7072  0 Sep26 ?        00:00:01 postgres: background writer   </span><br><span class="line">caryh     7076  7072  0 Sep26 ?        00:00:01 postgres: walwriter   </span><br><span class="line">caryh     7077  7072  0 Sep26 ?        00:00:01 postgres: autovacuum launcher   </span><br><span class="line">caryh     7078  7072  0 Sep26 ?        00:00:03 postgres: stats collector   </span><br><span class="line">caryh     7079  7072  0 Sep26 ?        00:00:00 postgres: logical replication launcher   </span><br><span class="line">caryh     7082  7072  0 Sep26 ?        00:00:00 postgres: cary carytest [<span class="built_in">local</span>] idle</span><br></pre></td></tr></table></figure>

<p>In this case it is the last line of the ps output as both my client and server reside in the same machine. Yours may be different.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">caryh     7082  7072  0 Sep26 ?        00:00:00 postgres: cary carytest [<span class="built_in">local</span>] idle</span><br></pre></td></tr></table></figure>

<p>Now we can run gdb with the postgres binary </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo gdb /usr/<span class="built_in">local</span>/pgsql/bin/postgres</span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/<span class="built_in">local</span>/pgsql/bin/postgres...done.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Now, we can attach gdb to the PID identified in previous step</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) attach 7082</span><br><span class="line">Attaching to program: &#x2F;usr&#x2F;local&#x2F;pgsql&#x2F;bin&#x2F;postgres, process 7082</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libpthread.so.0...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;.build-id&#x2F;28&#x2F;c6aade70b2d40d1f0f3d0a1a0cad1ab816448f.debug...done.</span><br><span class="line">done.</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;librt.so.1...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;librt-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl.so.2...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libm.so.6...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libm-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">Reading symbols from &#x2F;lib64&#x2F;ld-linux-x86-64.so.2...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">Reading symbols from &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libnss_files.so.2...Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libnss_files-2.27.so...done.</span><br><span class="line">done.</span><br><span class="line">0x00007fce71eafb77 in epoll_wait (epfd&#x3D;4, events&#x3D;0x5633194c87e0, maxevents&#x3D;1, timeout&#x3D;-1)</span><br><span class="line">    at ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;epoll_wait.c:30</span><br><span class="line">30  ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;epoll_wait.c: No such file or directory.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>Upon attach, Postgres process will be put on a break and we are able to issue breakpoints command from here</p>
<h3 id="4-Start-Tracing-with-gdb"><a href="#4-Start-Tracing-with-gdb" class="headerlink" title="4. Start Tracing with gdb"></a>4. Start Tracing with gdb</h3><p><code>exec_simple_query</code> is the function that will trigger all stages of query processing. Let’s put a breakpoint here.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) b exec_simple_query</span><br><span class="line">Breakpoint 1 at 0x56331899a43b: file postgres.c, line 985.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>
<p>Now, let’s type in a SELECT query with ORDER BY keywords on the postgres client connection terminal to trigger break point</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">carytest=&gt; select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;</span><br></pre></td></tr></table></figure>
<p>Breakpoint should be triggered</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at postgres.c:985</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Let’s do a backtrace <code>bt</code> command to see how the control got here.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  exec_simple_query (query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at postgres.c:985</span><br><span class="line">#1  0x000056331899f01c in PostgresMain (argc&#x3D;1, argv&#x3D;0x5633194c89c8, dbname&#x3D;0x5633194c8890 &quot;carytest&quot;, username&#x3D;0x5633194c8878 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#2  0x00005633188fba97 in BackendRun (port&#x3D;0x5633194c0f60) at postmaster.c:4431</span><br><span class="line">#3  0x00005633188fb1ba in BackendStartup (port&#x3D;0x5633194c0f60) at postmaster.c:4122</span><br><span class="line">#4  0x00005633188f753e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#5  0x00005633188f6cd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5633194974c0) at postmaster.c:1377</span><br><span class="line">#6  0x000056331881a10f in main (argc&#x3D;3, argv&#x3D;0x5633194974c0) at main.c:228</span><br></pre></td></tr></table></figure>
<p>As you can see, PostmasterMain process is one of the early process to be started and this is where it will spawn all the backend processes and initialize the ‘ServerLoop’ to listen for client connections. When a client connets and issues some queries, the handle will be passed from the backend to <code>PostgresMain</code> and this is where the query processing will begine.</p>
<h3 id="5-Parser-Stage"><a href="#5-Parser-Stage" class="headerlink" title="5. Parser Stage"></a>5. Parser Stage</h3><p>Parser Stage is the first stage in query processing, which will take an input query string and produce a raw un-analyzed parse tree. The control will eventually come to the raw_parser function, so let’s set a break point there and do a backtrace:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb)  b raw_parser</span><br><span class="line">Breakpoint 2 at 0x5633186b5bae: file parser.c, line 37.</span><br><span class="line">(gdb)  c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, raw_parser (str&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at parser.c:37</span><br><span class="line"></span><br><span class="line">(gdb) bt</span><br><span class="line">#0  raw_parser (str&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at parser.c:37</span><br><span class="line">#1  0x000056331899a03e in pg_parse_query ( query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at postgres.c:641</span><br><span class="line">#2  0x000056331899a4c9 in exec_simple_query ( query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at postgres.c:1037</span><br><span class="line">#3  0x000056331899f01c in PostgresMain (argc&#x3D;1, argv&#x3D;0x5633194c89c8, dbname&#x3D;0x5633194c8890 &quot;carytest&quot;,  username&#x3D;0x5633194c8878 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#4  0x00005633188fba97 in BackendRun (port&#x3D;0x5633194c0f60) at postmaster.c:4431</span><br><span class="line">#5  0x00005633188fb1ba in BackendStartup (port&#x3D;0x5633194c0f60) at postmaster.c:4122</span><br><span class="line">#6  0x00005633188f753e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#7  0x00005633188f6cd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5633194974c0) at postmaster.c:1377</span><br><span class="line">#8  0x000056331881a10f in main (argc&#x3D;3, argv&#x3D;0x5633194974c0) at main.c:228</span><br></pre></td></tr></table></figure>

<p>In <code>raw_parser</code>, 2 things will happen, first to scan the query with flex-based scanner to check keyword validity and second to do the actual parsing with bison-based parser. In the end, it will return a parse tree for next stage.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">43    yyscanner &#x3D; scanner_init(str, &amp;yyextra.core_yy_extra,</span><br><span class="line">(gdb) n</span><br><span class="line">47    yyextra.have_lookahead &#x3D; false;</span><br><span class="line">(gdb) n</span><br><span class="line">50    parser_init(&amp;yyextra);</span><br><span class="line">(gdb) </span><br><span class="line">53    yyresult &#x3D; base_yyparse(yyscanner);</span><br><span class="line">(gdb) </span><br><span class="line">56    scanner_finish(yyscanner);</span><br><span class="line">(gdb) </span><br><span class="line">58    if (yyresult)       &#x2F;* error *&#x2F;</span><br><span class="line">(gdb) </span><br><span class="line">61    return yyextra.parsetree;</span><br></pre></td></tr></table></figure>

<p>It is not very straight-forward to examine the content of the parse tree stored in <code>yyextra.parsetree</code> as above. This is why we enabled postgres debug log so that we can utilize it to recursively print the content of the parse tree. The parse tree illustrated by <code>yyextra.parsetree</code> can be visualized as this image below:</p>
<p><img src="/images/parse_tree.png" alt="extension"></p>
<h3 id="6-0-Analyzer-Stage"><a href="#6-0-Analyzer-Stage" class="headerlink" title="6.0 Analyzer Stage"></a>6.0 Analyzer Stage</h3><p>Now we have a list of parse trees, size 1 in this example, PG will need to feed each item in the list into anaylzer and rewriter functions. Let’s set a break point at <code>parse_analyze</code> function</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb)  b parse_analyze</span><br><span class="line">Breakpoint 3 at 0x56331867d608: file analyze.c, line 104.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, parse_analyze (parseTree&#x3D;0x56331949dd50,  sourceText&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;, paramTypes&#x3D;0x0, numParams&#x3D;0, queryEnv&#x3D;0x0) at analyze.c:104</span><br><span class="line">104   ParseState *pstate &#x3D; make_parsestate(NULL);</span><br><span class="line">(gdb) bt</span><br><span class="line"></span><br><span class="line">#0  parse_analyze (parseTree&#x3D;0x56331949dd50, sourceText&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;, paramTypes&#x3D;0x0, numParams&#x3D;0, queryEnv&#x3D;0x0) at analyze.c:104</span><br><span class="line">#1  0x000056331899a0a8 in pg_analyze_and_rewrite (parsetree&#x3D;0x56331949dd50, </span><br><span class="line">    query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;, </span><br><span class="line">    paramTypes&#x3D;0x0, numParams&#x3D;0, queryEnv&#x3D;0x0) at postgres.c:695</span><br><span class="line">#2  0x000056331899a702 in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;)</span><br><span class="line">    at postgres.c:1140</span><br><span class="line">#3  0x000056331899f01c in PostgresMain (argc&#x3D;1, argv&#x3D;0x5633194c89c8, </span><br><span class="line">    dbname&#x3D;0x5633194c8890 &quot;carytest&quot;, username&#x3D;0x5633194c8878 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#4  0x00005633188fba97 in BackendRun (port&#x3D;0x5633194c0f60) at postmaster.c:4431</span><br><span class="line">#5  0x00005633188fb1ba in BackendStartup (port&#x3D;0x5633194c0f60) at postmaster.c:4122</span><br><span class="line">#6  0x00005633188f753e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#7  0x00005633188f6cd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5633194974c0) at postmaster.c:1377</span><br><span class="line">#8  0x000056331881a10f in main (argc&#x3D;3, argv&#x3D;0x5633194974c0) at main.c:228</span><br></pre></td></tr></table></figure>

<p>The above backtrace shows how the control gets to parse_analyze function, and 2 vital imputs are <code>parseTree</code> (type RawStmt) and (const char) <code>sourceText</code></p>
<p>Let’s traverse to the end of parse_analyze</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">109   pstate-&gt;p_sourcetext &#x3D; sourceText;</span><br><span class="line">(gdb) </span><br><span class="line">111   if (numParams &gt; 0)</span><br><span class="line">(gdb) </span><br><span class="line">114   pstate-&gt;p_queryEnv &#x3D; queryEnv;</span><br><span class="line">(gdb) </span><br><span class="line">116   query &#x3D; transformTopLevelStmt(pstate, parseTree);</span><br><span class="line">(gdb) </span><br><span class="line">118   if (post_parse_analyze_hook)</span><br><span class="line">(gdb) </span><br><span class="line">121   free_parsestate(pstate);</span><br><span class="line">(gdb) </span><br><span class="line">123   return query;</span><br></pre></td></tr></table></figure>

<p>At analyzer stage, it produces a result of type <code>Query</code> and it is in fact the data type return from the parser stage as a <code>List</code> of <code>Query</code>. This structure will be fed into the rewriter stage.</p>
<h3 id="7-0-Rewriter-Stage"><a href="#7-0-Rewriter-Stage" class="headerlink" title="7.0 Rewriter Stage"></a>7.0 Rewriter Stage</h3><p>Rewriter is the next stage following analyzer, let’s create a break point at <code>pg_rewrite_query</code> and do a backtrace:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) b pg_rewrite_query</span><br><span class="line">Breakpoint 4 at 0x56331899a1c1: file postgres.c, line 773</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 4, pg_rewrite_query (query&#x3D;0x56331949dee0) at postgres.c:773</span><br><span class="line">773   if (Debug_print_parse)</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  pg_rewrite_query (query&#x3D;0x56331949dee0) at postgres.c:773</span><br><span class="line">#1  0x000056331899a0cf in pg_analyze_and_rewrite (parsetree&#x3D;0x56331949dd50, </span><br><span class="line">    query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;, </span><br><span class="line">    paramTypes&#x3D;0x0, numParams&#x3D;0, queryEnv&#x3D;0x0) at postgres.c:704</span><br><span class="line">#2  0x000056331899a702 in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;)</span><br><span class="line">    at postgres.c:1140</span><br><span class="line">#3  0x000056331899f01c in PostgresMain (argc&#x3D;1, argv&#x3D;0x5633194c89c8, </span><br><span class="line">    dbname&#x3D;0x5633194c8890 &quot;carytest&quot;, username&#x3D;0x5633194c8878 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#4  0x00005633188fba97 in BackendRun (port&#x3D;0x5633194c0f60) at postmaster.c:4431</span><br><span class="line">#5  0x00005633188fb1ba in BackendStartup (port&#x3D;0x5633194c0f60) at postmaster.c:4122</span><br><span class="line">#6  0x00005633188f753e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#7  0x00005633188f6cd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5633194974c0) at postmaster.c:1377</span><br><span class="line">#8  0x000056331881a10f in main (argc&#x3D;3, argv&#x3D;0x5633194974c0) at main.c:228</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Rewriter takes the output of the previou stage and returns a querytree_list of type <code>List*</code>. Let’s trace the function to the end and print the output</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">773     if (Debug_print_parse)</span><br><span class="line">(gdb) n</span><br><span class="line">774     elog_node_display(LOG, &quot;parse tree&quot;, query,</span><br><span class="line">(gdb) </span><br><span class="line">777   if (log_parser_stats)</span><br><span class="line">(gdb) </span><br><span class="line">780   if (query-&gt;commandType &#x3D;&#x3D; CMD_UTILITY)</span><br><span class="line">(gdb) </span><br><span class="line">788     querytree_list &#x3D; QueryRewrite(query);</span><br><span class="line">(gdb) </span><br><span class="line">791   if (log_parser_stats)</span><br><span class="line">(gdb) </span><br><span class="line">848   if (Debug_print_rewritten)</span><br><span class="line">(gdb) </span><br><span class="line">849     elog_node_display(LOG, &quot;rewritten parse tree&quot;, querytree_list,</span><br><span class="line">(gdb) </span><br><span class="line">852   return querytree_list;</span><br></pre></td></tr></table></figure>

<p>the <code>line 774 elog_node_display</code> and <code>line 849 elog_node_display</code> are the debug print function provided by postgres to recursively print the content of <code>Query</code> before and after rewriter stage. After examining the output query tree, we found that in this example, the rewriter does not make much modification to the origianl query tree and it can be visualized as:</p>
<p><img src="/images/parse_tree.png" alt="extension"></p>
<h3 id="8-0-Planner-Stage"><a href="#8-0-Planner-Stage" class="headerlink" title="8.0 Planner Stage"></a>8.0 Planner Stage</h3><p>Planner is the next stage immediately following the previous. The main planner function entry point is <code>pg_plan_query</code> and it takes the output from previous stage as input. Let’s create a breakpoint and do a backtrace again</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) b pg_plan_queries</span><br><span class="line">Breakpoint 5 at 0x56331899a32d: file postgres.c, line 948.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 5, pg_plan_queries (querytrees&#x3D;0x563319558558, cursorOptions&#x3D;256, boundParams&#x3D;0x0)</span><br><span class="line">    at postgres.c:948</span><br><span class="line">948   List     *stmt_list &#x3D; NIL;</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  pg_plan_queries (querytrees&#x3D;0x563319558558, cursorOptions&#x3D;256, boundParams&#x3D;0x0) at postgres.c:948</span><br><span class="line">#1  0x000056331899a722 in exec_simple_query ( query_string&#x3D;0x56331949cf00 &quot;select * from devicedata order by serial_number desc;&quot;) at postgres.c:1143</span><br><span class="line">#2  0x000056331899f01c in PostgresMain (argc&#x3D;1, argv&#x3D;0x5633194c89c8, dbname&#x3D;0x5633194c8890 &quot;carytest&quot;, username&#x3D;0x5633194c8878 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#3  0x00005633188fba97 in BackendRun (port&#x3D;0x5633194c0f60) at postmaster.c:4431</span><br><span class="line">#4  0x00005633188fb1ba in BackendStartup (port&#x3D;0x5633194c0f60) at postmaster.c:4122</span><br><span class="line">#5  0x00005633188f753e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#6  0x00005633188f6cd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5633194974c0) at postmaster.c:1377</span><br><span class="line">#7  0x000056331881a10f in main (argc&#x3D;3, argv&#x3D;0x5633194974c0) at main.c:228</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>Now, we are here, let’s trace the function until the end. Please note that for each content block in the input querytree list, the function will call a helper plan function called <code>pg_plan_query</code> and it will  perform the real plan operation there and return the result in <code>plannedStmt</code> data type</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">951   foreach(query_list, querytrees)</span><br><span class="line">(gdb) n</span><br><span class="line">953     Query    *query &#x3D; lfirst_node(Query, query_list);</span><br><span class="line">(gdb) n</span><br><span class="line">956     if (query-&gt;commandType &#x3D;&#x3D; CMD_UTILITY)</span><br><span class="line">(gdb) n</span><br><span class="line">968       stmt &#x3D; pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">(gdb) s</span><br><span class="line">pg_plan_query (querytree&#x3D;0x56331949dee0, cursorOptions&#x3D;256, boundParams&#x3D;0x0) at postgres.c:866</span><br><span class="line">866   if (querytree-&gt;commandType &#x3D;&#x3D; CMD_UTILITY)</span><br><span class="line">(gdb) n</span><br><span class="line">874   if (log_planner_stats)</span><br><span class="line">(gdb) </span><br><span class="line">878   plan &#x3D; planner(querytree, cursorOptions, boundParams);</span><br><span class="line">(gdb) n</span><br><span class="line">880   if (log_planner_stats)</span><br><span class="line">(gdb) </span><br><span class="line">929   if (Debug_print_plan)</span><br><span class="line">(gdb) </span><br><span class="line">930     elog_node_display(LOG, &quot;plan&quot;, plan, Debug_pretty_print);</span><br><span class="line">(gdb) </span><br><span class="line">934   return plan;</span><br></pre></td></tr></table></figure>

<p>Line <code>930 elog_node_display</code> will print the content of <code>PlannedStmt</code> recursively to syslog and it can be visualized as:</p>
<p><img src="/images/plan-tree2.png" alt="extension"></p>
<p>The above plan tree corresponds to the output of <code>EXPLAIN ANALYZE</code> on the same query.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">carytest=&gt; EXPLAIN ANALYZE SELECT serial_number, COUNT(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;</span><br><span class="line">                                                       QUERY PLAN                             </span><br><span class="line">                          </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------</span></span><br><span class="line"> Limit  (cost=1.32..1.33 rows=2 width=15) (actual time=0.043..0.044 rows=2 loops=1)</span><br><span class="line">   -&gt;  Sort  (cost=1.32..1.33 rows=3 width=15) (actual time=0.042..0.042 rows=2 loops=1)</span><br><span class="line">         Sort Key: (count(serial_number)) DESC</span><br><span class="line">         Sort Method: quicksort  Memory: 25kB</span><br><span class="line">         -&gt;  HashAggregate  (cost=1.27..1.30 rows=3 width=15) (actual time=0.033..0.035 rows=3</span><br><span class="line"> loops=1)</span><br><span class="line">               Group Key: serial_number</span><br><span class="line">               -&gt;  Seq Scan on devicedata  (cost=0.00..1.18 rows=18 width=7) (actual time=0.01</span><br><span class="line">3..0.016 rows=18 loops=1)</span><br><span class="line"> Planning Time: 28.541 ms</span><br><span class="line"> Execution Time: 0.097 ms</span><br><span class="line">(9 rows)</span><br></pre></td></tr></table></figure>



<p>Line <code>878 plan = planner(querytree, cursorOptions, boundParams);</code> in the above trace is the real planner logic and it is a complex stage. Inside this function, it will compute the initial cost and run time cost of all possible queries and in the end, it will choose a plan that is the least expensive. </p>
<p>with the <code>plannedStmt</code> produced, we are ready to enter the next stage of query processing.</p>
<h3 id="9-0-Executor-Stage"><a href="#9-0-Executor-Stage" class="headerlink" title="9.0 Executor Stage"></a>9.0 Executor Stage</h3><p>In addition to planner, executor is also one of the complex stages of query processing. This module is responsible for executing the query plan produced from previous stage and sending the query results back to the connecting client. </p>
<p>Executor is invoked and managed with a wrapper called <code>portal</code> and portal is an object representing the execution state of a query and providing memory management services but it does not actually run the executor. In the end, the portal will invoke one of the four executor routines as below</p>
<p>-ExecutorStart()<br>-ExecutorRun()<br>-ExecutorFinish()<br>-ExecutorEnd()</p>
<p>Before we can use the above routines, the portal needs to be initialized first. In the previous stage, the control is left at <code>exec_simple_query</code> at line 1147, let’s continue tracing from here to enter portal initialization</p>
<p>Let’s create a break point for each executor routine and do a back trace on each as we continue</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) b ExecutorStart</span><br><span class="line">Breakpoint 6 at 0x5633187ad797: file execMain.c, line 146.</span><br><span class="line">(gdb) b ExecutorRun</span><br><span class="line">Breakpoint 7 at 0x5633187ada1e: file execMain.c, line 306.</span><br><span class="line">(gdb) b ExecutorFinish</span><br><span class="line">Breakpoint 8 at 0x5633187adc35: file execMain.c, line 405.</span><br><span class="line">(gdb) b ExecutorEnd</span><br><span class="line">Breakpoint 9 at 0x5633187add1e: file execMain.c, line 465.</span><br></pre></td></tr></table></figure>
<h4 id="9-1-Executor-Start"><a href="#9-1-Executor-Start" class="headerlink" title="9.1 Executor Start"></a>9.1 Executor Start</h4><p>The main purpose of ExecutorStart routine is to prepare the query plan, allocate storage and prepare rule manager. Let’s continue the tracing and do a backtrace.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Breakpoint 6, ExecutorStart (queryDesc&#x3D;0x5633195712e0, eflags&#x3D;0) at execMain.c:146</span><br><span class="line">146   if (ExecutorStart_hook)</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  ExecutorStart (queryDesc&#x3D;0x564977500190, eflags&#x3D;0) at execMain.c:146</span><br><span class="line">#1  0x0000564975eb87e0 in PortalStart (portal&#x3D;0x5649774a18d0, params&#x3D;0x0, eflags&#x3D;0, snapshot&#x3D;0x0)</span><br><span class="line">    at pquery.c:518</span><br><span class="line">#2  0x0000564975eb27b5 in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x564977439f00 &quot;select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;&quot;) at postgres.c:1176</span><br><span class="line">#3  0x0000564975eb701c in PostgresMain (argc&#x3D;1, argv&#x3D;0x564977465a08, </span><br><span class="line">    dbname&#x3D;0x5649774658d0 &quot;carytest&quot;, username&#x3D;0x5649774658b8 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#4  0x0000564975e13a97 in BackendRun (port&#x3D;0x56497745dfa0) at postmaster.c:4431</span><br><span class="line">#5  0x0000564975e131ba in BackendStartup (port&#x3D;0x56497745dfa0) at postmaster.c:4122</span><br><span class="line">#6  0x0000564975e0f53e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#7  0x0000564975e0ecd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5649774344c0) at postmaster.c:1377</span><br><span class="line">#8  0x0000564975d3210f in main (argc&#x3D;3, argv&#x3D;0x5649774344c0) at main.c:228</span><br><span class="line"></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="9-2-Executor-Run"><a href="#9-2-Executor-Run" class="headerlink" title="9.2 Executor Run"></a>9.2 Executor Run</h4><p>ExecutorRun is the main routine of executor module, and its main task is to execute the query plan, this routing will call the <code>ExecutePlan</code> function to actually execute the plan. In the end, before return, the result of query will be stored in <code>Estate</code> structure called <code>estate</code> and inside there is a count of how many tutples have been processed by the executor</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 7, ExecutorRun (queryDesc&#x3D;0x5633195712e0, direction&#x3D;ForwardScanDirection, count&#x3D;0, </span><br><span class="line">    execute_once&#x3D;true) at execMain.c:306</span><br><span class="line">306   if (ExecutorRun_hook)</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  ExecutorRun (queryDesc&#x3D;0x564977500190, direction&#x3D;ForwardScanDirection, count&#x3D;0, </span><br><span class="line">    execute_once&#x3D;true) at execMain.c:306</span><br><span class="line">#1  0x0000564975eb915c in PortalRunSelect (portal&#x3D;0x5649774a18d0, forward&#x3D;true, count&#x3D;0, </span><br><span class="line">    dest&#x3D;0x564977539460) at pquery.c:929</span><br><span class="line">#2  0x0000564975eb8db6 in PortalRun (portal&#x3D;0x5649774a18d0, count&#x3D;9223372036854775807, </span><br><span class="line">    isTopLevel&#x3D;true, run_once&#x3D;true, dest&#x3D;0x564977539460, altdest&#x3D;0x564977539460, </span><br><span class="line">    completionTag&#x3D;0x7ffff0b937d0 &quot;&quot;) at pquery.c:770</span><br><span class="line">#3  0x0000564975eb28ad in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x564977439f00 &quot;select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;&quot;) at postgres.c:1215</span><br><span class="line">#4  0x0000564975eb701c in PostgresMain (argc&#x3D;1, argv&#x3D;0x564977465a08, </span><br><span class="line">    dbname&#x3D;0x5649774658d0 &quot;carytest&quot;, username&#x3D;0x5649774658b8 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#5  0x0000564975e13a97 in BackendRun (port&#x3D;0x56497745dfa0) at postmaster.c:4431</span><br><span class="line">#6  0x0000564975e131ba in BackendStartup (port&#x3D;0x56497745dfa0) at postmaster.c:4122</span><br><span class="line">#7  0x0000564975e0f53e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#8  0x0000564975e0ecd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5649774344c0) at postmaster.c:1377</span><br><span class="line">#9  0x0000564975d3210f in main (argc&#x3D;3, argv&#x3D;0x5649774344c0) at main.c:228</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Continue tracing the <code>ExecutorRun</code> to the end.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">306   if (ExecutorRun_hook)</span><br><span class="line">(gdb) n</span><br><span class="line">309     standard_ExecutorRun(queryDesc, direction, count, execute_once);</span><br><span class="line">(gdb) s</span><br><span class="line">standard_ExecutorRun (queryDesc&#x3D;0x564977500190, direction&#x3D;ForwardScanDirection, count&#x3D;0, </span><br><span class="line">    execute_once&#x3D;true) at execMain.c:325</span><br><span class="line">325   estate &#x3D; queryDesc-&gt;estate;</span><br><span class="line">(gdb) n</span><br><span class="line">333   oldcontext &#x3D; MemoryContextSwitchTo(estate-&gt;es_query_cxt);</span><br><span class="line">(gdb) n</span><br><span class="line">336   if (queryDesc-&gt;totaltime)</span><br><span class="line">(gdb) n</span><br><span class="line">342   operation &#x3D; queryDesc-&gt;operation;</span><br><span class="line">(gdb) </span><br><span class="line">343   dest &#x3D; queryDesc-&gt;dest;</span><br><span class="line">(gdb) </span><br><span class="line">348   estate-&gt;es_processed &#x3D; 0;</span><br><span class="line">(gdb) </span><br><span class="line">350   sendTuples &#x3D; (operation &#x3D;&#x3D; CMD_SELECT ||</span><br><span class="line">(gdb) </span><br><span class="line">353   if (sendTuples)</span><br><span class="line">(gdb) </span><br><span class="line">354     dest-&gt;rStartup(dest, operation, queryDesc-&gt;tupDesc);</span><br><span class="line">(gdb) </span><br><span class="line">359   if (!ScanDirectionIsNoMovement(direction))</span><br><span class="line">(gdb) </span><br><span class="line">361     if (execute_once &amp;&amp; queryDesc-&gt;already_executed)</span><br><span class="line">(gdb) </span><br><span class="line">363     queryDesc-&gt;already_executed &#x3D; true;</span><br><span class="line">(gdb) </span><br><span class="line">365     ExecutePlan(estate,</span><br><span class="line">(gdb) </span><br><span class="line">367           queryDesc-&gt;plannedstmt-&gt;parallelModeNeeded,</span><br><span class="line">(gdb) </span><br><span class="line">365     ExecutePlan(estate,</span><br><span class="line">(gdb) </span><br><span class="line">379   if (sendTuples)</span><br><span class="line">(gdb) </span><br><span class="line">380     dest-&gt;rShutdown(dest);</span><br><span class="line">(gdb) </span><br><span class="line">382   if (queryDesc-&gt;totaltime)</span><br><span class="line">(gdb) </span><br><span class="line">385   MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) p estate</span><br><span class="line">$6 &#x3D; (EState *) 0x56497751fbb0</span><br><span class="line">(gdb) p estate-&gt;es_processed</span><br><span class="line">$7 &#x3D; 2</span><br></pre></td></tr></table></figure>

<h4 id="9-3-Executor-Finish"><a href="#9-3-Executor-Finish" class="headerlink" title="9.3 Executor Finish"></a>9.3 Executor Finish</h4><p>ExecutorFinish must be called after the last ExecutorRun, its main task is to perform necessary clearn up actions and also fire up after Triggers. Let’s trace a little further.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 8, ExecutorFinish (queryDesc&#x3D;0x5633195712e0) at execMain.c:405</span><br><span class="line">405   if (ExecutorFinish_hook)</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  ExecutorFinish (queryDesc&#x3D;0x564977500190) at execMain.c:405</span><br><span class="line">#1  0x0000564975c5b52c in PortalCleanup (portal&#x3D;0x5649774a18d0) at portalcmds.c:300</span><br><span class="line">#2  0x0000564976071ba4 in PortalDrop (portal&#x3D;0x5649774a18d0, isTopCommit&#x3D;false) at portalmem.c:499</span><br><span class="line">#3  0x0000564975eb28d3 in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x564977439f00 &quot;select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;&quot;) at postgres.c:1225</span><br><span class="line">#4  0x0000564975eb701c in PostgresMain (argc&#x3D;1, argv&#x3D;0x564977465a08, </span><br><span class="line">    dbname&#x3D;0x5649774658d0 &quot;carytest&quot;, username&#x3D;0x5649774658b8 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#5  0x0000564975e13a97 in BackendRun (port&#x3D;0x56497745dfa0) at postmaster.c:4431</span><br><span class="line">#6  0x0000564975e131ba in BackendStartup (port&#x3D;0x56497745dfa0) at postmaster.c:4122</span><br><span class="line">#7  0x0000564975e0f53e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#8  0x0000564975e0ecd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5649774344c0) at postmaster.c:1377</span><br><span class="line">#9  0x0000564975d3210f in main (argc&#x3D;3, argv&#x3D;0x5649774344c0) at main.c:228</span><br></pre></td></tr></table></figure>
<p>Continue tracing the <code>ExecutorFinish</code> to the end.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">405   if (ExecutorFinish_hook)</span><br><span class="line">(gdb) n</span><br><span class="line">408     standard_ExecutorFinish(queryDesc);</span><br><span class="line">(gdb) s</span><br><span class="line">standard_ExecutorFinish (queryDesc&#x3D;0x564977500190) at execMain.c:420</span><br><span class="line">420   estate &#x3D; queryDesc-&gt;estate;</span><br><span class="line">(gdb) n</span><br><span class="line">429   oldcontext &#x3D; MemoryContextSwitchTo(estate-&gt;es_query_cxt);</span><br><span class="line">(gdb) </span><br><span class="line">432   if (queryDesc-&gt;totaltime)</span><br><span class="line">(gdb) </span><br><span class="line">436   ExecPostprocessPlan(estate);</span><br><span class="line">(gdb) </span><br><span class="line">439   if (!(estate-&gt;es_top_eflags &amp; EXEC_FLAG_SKIP_TRIGGERS))</span><br><span class="line">(gdb) </span><br><span class="line">442   if (queryDesc-&gt;totaltime)</span><br><span class="line">(gdb) </span><br><span class="line">445   MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) </span><br><span class="line">447   estate-&gt;es_finished &#x3D; true;</span><br><span class="line">(gdb) </span><br><span class="line">448 &#125;</span><br></pre></td></tr></table></figure>

<h4 id="9-4-Executor-End"><a href="#9-4-Executor-End" class="headerlink" title="9.4 Executor End"></a>9.4 Executor End</h4><p>This routing basically resets and releases some of the state variables in <code>QueryDesc</code> used during execution. ExecutorEnd is the last routine to be called and before entry, the  <code>PortalCleanup</code> and  <code>PortalDrop</code> are invoked first. So as we are in this routine the outer <code>Portal</code> object is also performing the cleanup process.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 9, ExecutorEnd (queryDesc&#x3D;0x5633195712e0) at execMain.c:465</span><br><span class="line">465   if (ExecutorEnd_hook)</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  ExecutorEnd (queryDesc&#x3D;0x564977500190) at execMain.c:465</span><br><span class="line">#1  0x0000564975c5b538 in PortalCleanup (portal&#x3D;0x5649774a18d0) at portalcmds.c:301</span><br><span class="line">#2  0x0000564976071ba4 in PortalDrop (portal&#x3D;0x5649774a18d0, isTopCommit&#x3D;false) at portalmem.c:499</span><br><span class="line">#3  0x0000564975eb28d3 in exec_simple_query (</span><br><span class="line">    query_string&#x3D;0x564977439f00 &quot;select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;&quot;) at postgres.c:1225</span><br><span class="line">#4  0x0000564975eb701c in PostgresMain (argc&#x3D;1, argv&#x3D;0x564977465a08, </span><br><span class="line">    dbname&#x3D;0x5649774658d0 &quot;carytest&quot;, username&#x3D;0x5649774658b8 &quot;cary&quot;) at postgres.c:4249</span><br><span class="line">#5  0x0000564975e13a97 in BackendRun (port&#x3D;0x56497745dfa0) at postmaster.c:4431</span><br><span class="line">#6  0x0000564975e131ba in BackendStartup (port&#x3D;0x56497745dfa0) at postmaster.c:4122</span><br><span class="line">#7  0x0000564975e0f53e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#8  0x0000564975e0ecd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5649774344c0) at postmaster.c:1377</span><br><span class="line">#9  0x0000564975d3210f in main (argc&#x3D;3, argv&#x3D;0x5649774344c0) at main.c:228</span><br><span class="line"></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>Let’s Continue tracing <code>ExecutorEnd</code> to the end.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">465   if (ExecutorEnd_hook)</span><br><span class="line">(gdb) n</span><br><span class="line">468     standard_ExecutorEnd(queryDesc);</span><br><span class="line">(gdb) s</span><br><span class="line">standard_ExecutorEnd (queryDesc&#x3D;0x564977500190) at execMain.c:480</span><br><span class="line">480   estate &#x3D; queryDesc-&gt;estate;</span><br><span class="line">(gdb) n</span><br><span class="line">495   oldcontext &#x3D; MemoryContextSwitchTo(estate-&gt;es_query_cxt);</span><br><span class="line">(gdb) </span><br><span class="line">497   ExecEndPlan(queryDesc-&gt;planstate, estate);</span><br><span class="line">(gdb) </span><br><span class="line">500   UnregisterSnapshot(estate-&gt;es_snapshot);</span><br><span class="line">(gdb) </span><br><span class="line">501   UnregisterSnapshot(estate-&gt;es_crosscheck_snapshot);</span><br><span class="line">(gdb) </span><br><span class="line">506   MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) </span><br><span class="line">512   FreeExecutorState(estate);</span><br><span class="line">(gdb) </span><br><span class="line">515   queryDesc-&gt;tupDesc &#x3D; NULL;</span><br><span class="line">(gdb) </span><br><span class="line">516   queryDesc-&gt;estate &#x3D; NULL;</span><br><span class="line">(gdb) </span><br><span class="line">517   queryDesc-&gt;planstate &#x3D; NULL;</span><br><span class="line">(gdb) </span><br><span class="line">518   queryDesc-&gt;totaltime &#x3D; NULL;</span><br><span class="line">(gdb) </span><br><span class="line">519 &#125;</span><br></pre></td></tr></table></figure>

<p>This routine marks the end of the query processing stages, the control will be passed back to <code>exec_simple_query</code> to finish the transaction and present result back to the client.</p>
<h3 id="10-0-Presenting-the-Result-Back-to-Client"><a href="#10-0-Presenting-the-Result-Back-to-Client" class="headerlink" title="10.0 Presenting the Result Back to Client"></a>10.0 Presenting the Result Back to Client</h3><p>With the transaction ended, the  <code>send_ready_for_query</code> flag will be set, and the control is now able to enter <code>ReadyForQuery</code> to present the result to client.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) b ReadyForQuery</span><br><span class="line">Breakpoint 10 at 0x56331899811d: file dest.c, line 251.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 10, ReadyForQuery (dest&#x3D;DestRemote) at dest.c:251</span><br><span class="line">251 &#123;</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  ReadyForQuery (dest&#x3D;DestRemote) at dest.c:251</span><br><span class="line">#1  0x0000564975eb6eee in PostgresMain (argc&#x3D;1, argv&#x3D;0x564977465a08, </span><br><span class="line">    dbname&#x3D;0x5649774658d0 &quot;carytest&quot;, username&#x3D;0x5649774658b8 &quot;cary&quot;) at postgres.c:4176</span><br><span class="line">#2  0x0000564975e13a97 in BackendRun (port&#x3D;0x56497745dfa0) at postmaster.c:4431</span><br><span class="line">#3  0x0000564975e131ba in BackendStartup (port&#x3D;0x56497745dfa0) at postmaster.c:4122</span><br><span class="line">#4  0x0000564975e0f53e in ServerLoop () at postmaster.c:1704</span><br><span class="line">#5  0x0000564975e0ecd4 in PostmasterMain (argc&#x3D;3, argv&#x3D;0x5649774344c0) at postmaster.c:1377</span><br><span class="line">#6  0x0000564975d3210f in main (argc&#x3D;3, argv&#x3D;0x5649774344c0) at main.c:228</span><br><span class="line"></span><br><span class="line">(gdb) n</span><br><span class="line">252   switch (dest)</span><br><span class="line">(gdb) </span><br><span class="line">257       if (PG_PROTOCOL_MAJOR(FrontendProtocol) &gt;&#x3D; 3)</span><br><span class="line">(gdb) </span><br><span class="line">261         pq_beginmessage(&amp;buf, &#39;Z&#39;);</span><br><span class="line">(gdb) </span><br><span class="line">262         pq_sendbyte(&amp;buf, TransactionBlockStatusCode());</span><br><span class="line">(gdb) </span><br><span class="line">263         pq_endmessage(&amp;buf);</span><br><span class="line">(gdb) p dest</span><br><span class="line">$90 &#x3D; DestRemote</span><br><span class="line">(gdb)  n</span><br><span class="line">268       pq_flush();</span><br><span class="line">(gdb) </span><br><span class="line">269       break;</span><br><span class="line">(gdb) </span><br><span class="line">282 &#125;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>as <code>pq_flush()</code> is called, the result of the query will be returned back to the client at remote destination.</p>
<h4 id="10-1-Client-Results"><a href="#10-1-Client-Results" class="headerlink" title="10.1 Client Results"></a>10.1 Client Results</h4><p>Client will now see the output below as a result of the query</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">carytest=&gt; select serial_number, count(serial_number) from devicedata GROUP BY serial_number ORDER BY count DESC LIMIT 2;</span><br><span class="line"> serial_number | count </span><br><span class="line"><span class="comment">---------------+-------</span></span><br><span class="line"> X00002        |     8</span><br><span class="line"> X00003        |     6</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure>

<h3 id="11-Summary"><a href="#11-Summary" class="headerlink" title="11 Summary"></a>11 Summary</h3><p>So far, we have traced through severl stags of query processing. Namely</p>
<ul>
<li>Parser</li>
<li>Analyzer</li>
<li>Rewritter</li>
<li>Planner</li>
<li>Executor</li>
</ul>
<p>To summarize all the above, I have created a simple call hierarchy ( or a list of breakpoints) below that outlines the important core functions that will be called while stepping through the above stages. The ‘b’ in front of each function name corresponds to the break point command of gdb.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## Main Entry ##</span><br><span class="line">b exec_simple_query</span><br><span class="line"></span><br><span class="line">  ## Parser ##</span><br><span class="line">  b pg_parse_query            -&gt; returns (List* of Query)</span><br><span class="line">    b raw_parser              -&gt; returns (List* of Query)</span><br><span class="line">      b base_yyparse          -&gt; returns (List* of Query)</span><br><span class="line">  </span><br><span class="line">  ## Analzyer and Rewritter ##</span><br><span class="line">  b pg_analyze_and_rewrite    -&gt; returns (List*)</span><br><span class="line">    b parse_analyze           -&gt; returns (Query*)</span><br><span class="line">    b pg_rewrite_query        -&gt; returns (List* of Query)   </span><br><span class="line">      b QueryRewrite          -&gt; returns (List* of Query)   </span><br><span class="line"></span><br><span class="line">  ## Planner ##</span><br><span class="line">  b pg_plan_queries           -&gt; returns (List* of plannedStmt)</span><br><span class="line">    b pg_plan_query           -&gt; returns (PlannedStmt*)</span><br><span class="line">      b planner               -&gt; returns (PlannedStmt*)</span><br><span class="line"></span><br><span class="line">  ## Executor ##</span><br><span class="line">  b PortalStart               -&gt; returns void</span><br><span class="line">    b ExecutorStart           -&gt; returns void</span><br><span class="line"></span><br><span class="line">  b PortalRun                 -&gt; returns bool</span><br><span class="line">    b PortalRunSelect         -&gt; returns uint64 </span><br><span class="line">      b ExecutorRun           -&gt; returns void</span><br><span class="line"></span><br><span class="line">  b PortalDrop                -&gt; returns void</span><br><span class="line">    b PortalCleanup           -&gt; returns void</span><br><span class="line">      b ExecutorFinish        -&gt; returns void</span><br><span class="line">      b ExecutorEnd           -&gt; returns void</span><br><span class="line"></span><br><span class="line">  ## Present Result ##</span><br><span class="line">b ReadyForQuery               -&gt; returns void</span><br><span class="line">  b pq_flush                  -&gt; returns void</span><br></pre></td></tr></table></figure>
        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/09/25/A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-thumbnail.png" alt="A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-26T06:36:03.000Z">2019-09-25</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 minutes read (About 1939 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/25/A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres/">A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>Postgres is a huge database system consisting of a wide range of built-in data types, functions, features and operators that can be utilized to solve many common to complex problems. However, in the world full of complex problems, sometimes these are just not enough depending on the use case complexities.</p>
<p>Worry not, since Postgres version 9, it is possible to extend Postgres’s existing functionalities with the use of “extensions”</p>
<p>In this article, I will show you how to create your own extensions and add to Postgres.</p>
<p>Please note that this article is based on Postgres version 12 running on Ubuntu 18.04 and before you can create your own extensions, PG must have been built and installed first</p>
<h3 id="2-Built-in-Extensions"><a href="#2-Built-in-Extensions" class="headerlink" title="2. Built-in Extensions"></a>2. Built-in Extensions</h3><p>Before we jump into creating your own extensions, it is important to know that there is already a list of  extensions available from the PG community included in the Postgres software distribution. </p>
<p>The detailed information of community supplied extensions can be found in this link: <a href="https://www.postgresql.org/docs/9.1/contrib.html">https://www.postgresql.org/docs/9.1/contrib.html</a></p>
<h3 id="3-Build-and-Install-PG-Default-Extensions"><a href="#3-Build-and-Install-PG-Default-Extensions" class="headerlink" title="3. Build and Install PG Default Extensions"></a>3. Build and Install PG Default Extensions</h3><p>All the PG community extensions are located in the directory below. This is also where we will be adding our own extensions</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$PG_SOURCE_DIR</span>/postgres/contrib</span><br></pre></td></tr></table></figure>

<p>where [PG SOURCE DIR] is the directory to your PG source code</p>
<p>These modules are not built automatically unless you build the ‘world’ target. To Manually build and install them, use these commands.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> contrib</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>The above command will install the extensions to </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$SHAREDIR</span>/extension</span><br></pre></td></tr></table></figure>
<p>and required C shared libraries to </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$LIBDIR</span></span><br></pre></td></tr></table></figure>
<p>where $SHAREDIR and $LIBDIR are the values returned by pg_config</p>
<p>For the extensions that utilize the C language as implementation, there will be a C shared libraries (.so) being produced by the make command. This C shared library contains all the methods supported by the extension. </p>
<p>With default extensions and libraries installed, we can then see the installed extensions by the following queries</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_available_extensions();</span><br><span class="line"><span class="keyword">SELECT</span> pg_available_extension_versions();</span><br></pre></td></tr></table></figure>

<h3 id="4-Create-Extension-Using-plpqsql-Language"><a href="#4-Create-Extension-Using-plpqsql-Language" class="headerlink" title="4. Create Extension Using plpqsql Language"></a>4. Create Extension Using plpqsql Language</h3><p>For this example, we will create a very simple extension that will count the number of specified character of a given string. This extension takes 2 input arguments, first being the string, and second being the desired character. It will return an integer indicating the number of occurance of the desired characters presented in the string</p>
<p>first, let’s navigate to the contrib directory to add our extension</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> [PG SOURCE DIR]/contrib</span><br></pre></td></tr></table></figure>

<p>let’s create a new directory called char_count. This will be the name of the extension</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir char_count</span><br><span class="line"><span class="built_in">cd</span> char_count</span><br></pre></td></tr></table></figure>

<p>create the folders for defining testcases later</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir sql</span><br><span class="line">mkdir expected</span><br></pre></td></tr></table></figure>

<p>create and an extension control file using this naming convention:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Extension name].control</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><figcaption><span>char_count.control</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># char_count extension</span></span><br><span class="line">comment = <span class="string">'function to count number of specified characters'</span></span><br><span class="line">default_version = <span class="string">'1.0'</span></span><br><span class="line">module_pathname = <span class="string">'$libdir/char_count'</span></span><br><span class="line">relocatable = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>create a data sql file using this naming convention:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Extension name]--[Extension version].sql</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>char_count--1.0.sql</span></figcaption><table><tr><td class="code"><pre><span class="line">\echo <span class="keyword">Use</span> <span class="string">"CREATE EXTENSION char_count"</span> <span class="keyword">to</span> <span class="keyword">load</span> this file. \quit</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> char_count(<span class="built_in">TEXT</span>, <span class="built_in">CHAR</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">INTEGER</span></span><br><span class="line"><span class="keyword">LANGUAGE</span> plpgsql IMMUTABLE <span class="keyword">STRICT</span></span><br><span class="line">  <span class="keyword">AS</span> $$</span><br><span class="line">    <span class="keyword">DECLARE</span></span><br><span class="line">      charCount <span class="built_in">INTEGER</span> := <span class="number">0</span>;</span><br><span class="line">      i INTEGER := 0;</span><br><span class="line">      inputText TEXT := $1;</span><br><span class="line">      targetChar CHAR := $2;</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">WHILE</span> i &lt;= <span class="keyword">length</span>(inputText) <span class="keyword">LOOP</span></span><br><span class="line">      <span class="keyword">IF</span> <span class="keyword">substring</span>( inputText <span class="keyword">from</span> i <span class="keyword">for</span> <span class="number">1</span>) = targetChar <span class="keyword">THEN</span></span><br><span class="line">        charCount := charCount + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">        i := i + 1;</span><br><span class="line">      <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line">    RETURN(charCount);</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">  $$;</span><br></pre></td></tr></table></figure>

<p>Please note that the first echo line enforces the function to be loaded as extension</p>
<p>Create a Makefile</p>
<figure class="highlight bash"><figcaption><span>Makefile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># contrib/char_count/Makefile</span></span><br><span class="line"></span><br><span class="line">EXTENSION = char_count</span><br><span class="line">DATA = char_count--1.0.sql</span><br><span class="line">PGFILEDESC = <span class="string">"char_count - count number of specified character"</span></span><br><span class="line">REGRESS = char_count</span><br><span class="line"></span><br><span class="line">ifdef USE_PGXS</span><br><span class="line">PG_CONFIG = pg_config</span><br><span class="line">PGXS := $(shell $(PG_CONFIG) --pgxs)</span><br><span class="line">include $(PGXS)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">subdir = contrib/char_count</span><br><span class="line">top_builddir = ../..</span><br><span class="line">include $(top_builddir)/src/Makefile.global</span><br><span class="line">include $(top_srcdir)/contrib/contrib-global.mk</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>With the files in place ,we can go ahread and run within the char_count extension folder</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>This will install char_count extension to  $SHAREDIR</p>
<p>Now we can connect to the PG server and make use of the new extension that we have just added:</p>
<p><img src="/images/char_count-extension.png" alt="extension"></p>
<h3 id="5-Create-a-Test-Case-for-the-New-Extension"><a href="#5-Create-a-Test-Case-for-the-New-Extension" class="headerlink" title="5. Create a Test Case for the New Extension"></a>5. Create a Test Case for the New Extension</h3><p>We have already created a sql folder from previous steps, let’s create a new .sql file for our test case</p>
<figure class="highlight sql"><figcaption><span>char_count.sql</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION char_count;</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'b'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'x'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'b'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'5'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'0'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'asd'</span>);</span><br></pre></td></tr></table></figure>

<p>Please note that in the Makefile, we have to also specifiy the name of the regression tests with this line:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REGRESS = char_count</span><br></pre></td></tr></table></figure>

<p>Run the testcase and Obtain Results</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make installcheck</span><br></pre></td></tr></table></figure>

<p>For the first time, the regression test will fail, because we have not provided the expected output file (.out file) for the test case. A new folder “results” is created upon running the regression test, and there is a (.out) file inside containing all the output from the test case</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION char_count;</span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'a'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          4</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'b'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          7</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'c'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          2</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'x'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          0</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'c'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          2</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'b'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          7</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'5'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          5</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'3'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          7</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'2'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          7</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'1'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          4</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'0'</span>);</span><br><span class="line"> char_count </span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">          1</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> char_count(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'asd'</span>);</span><br><span class="line">ERROR:  value too long for type character(1)</span><br><span class="line">CONTEXT:  PL/pgSQL function char_count(text,character) line 7 during statement block local variable initialization</span><br></pre></td></tr></table></figure>

<p>We should examine this .out file and made sure the outputs are all correct and we will copy it over to the expected folder</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp char_count/results/char_count.out char_count/expected</span><br></pre></td></tr></table></figure>

<h3 id="6-Create-your-Own-Extension-Using-C-Language"><a href="#6-Create-your-Own-Extension-Using-C-Language" class="headerlink" title="6. Create your Own Extension Using C Language"></a>6. Create your Own Extension Using C Language</h3><p>In the previous section, we created a extension using plpgsql function language. This is in many ways very similar to the ‘CREATE FUNCTION’ commands except that in the above example, we specifically states that the function can only be loaded through the CREATE EXTENSION command.</p>
<p>In most cases, the custom extensions are mostly built in C codes because of its flexibility and performance benefits.</p>
<p>To demonstrate this, we will create a new extension called char_count_c. Let’s repeat some of the process above:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> [PG_SOURCE_DIR]/contrib</span><br><span class="line">mkdir char_count_c</span><br><span class="line"><span class="built_in">cd</span> char_count_c</span><br><span class="line">mkdir expected</span><br><span class="line">mkdir sql</span><br></pre></td></tr></table></figure>

<p>create a control file:</p>
<figure class="highlight bash"><figcaption><span>char_count_c.control</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># char_count_c extension</span></span><br><span class="line">comment = <span class="string">'c function to count number of specified characters'</span></span><br><span class="line">default_version = <span class="string">'1.0'</span></span><br><span class="line">module_pathname = <span class="string">'$libdir/char_count_c'</span></span><br><span class="line">relocatable = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>create a data sql file </p>
<figure class="highlight bash"><figcaption><span>char_count_c--1.0.sql</span></figcaption><table><tr><td class="code"><pre><span class="line">\<span class="built_in">echo</span> Use <span class="string">"CREATE EXTENSION char_count"</span> to load this file. \quit</span><br><span class="line">CREATE FUNCTION char_count_c(TEXT, TEXT) RETURNS INTEGER</span><br><span class="line">AS <span class="string">'$libdir/char_count_c'</span></span><br><span class="line">LANGUAGE C IMMUTABLE STRICT</span><br></pre></td></tr></table></figure>

<p>This is where it differs from the previous method to add extension. In here we specifically set the LANGUAGE to be C as oppose to plpgsql.</p>
<p>$libdir/char_count_c is important as this is the path in which the PG will try to find a corresponding C share library when char_count_c extension is loaded.</p>
<p>Now, create a Makefile</p>
<figure class="highlight bash"><figcaption><span>Makefile</span></figcaption><table><tr><td class="code"><pre><span class="line">MODULES = char_count_c</span><br><span class="line">EXTENSION = char_count_c</span><br><span class="line">DATA = char_count_c--1.0.sql</span><br><span class="line">PGFILEDESC = <span class="string">"char_count_c - count number of specified character"</span></span><br><span class="line">REGRESS = char_count_c</span><br><span class="line"></span><br><span class="line">ifdef USE_PGXS</span><br><span class="line">PG_CONFIG = pg_config</span><br><span class="line">PGXS := $(shell $(PG_CONFIG) --pgxs)</span><br><span class="line">include $(PGXS)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">subdir = contrib/char_count_c</span><br><span class="line">top_builddir = ../..</span><br><span class="line">include $(top_builddir)/src/Makefile.global</span><br><span class="line">include $(top_srcdir)/contrib/contrib-global.mk</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>Here we added a new line called MODULES = char_count_c. This line will actually compile your C code into a shared library (.so) file which will be used by PG when char_count_c extension is loaded.</p>
<p>Create a new C source file</p>
<figure class="highlight c"><figcaption><span>char_count_c.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"postgres.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"fmgr.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"utils/builtins.h"</span></span></span><br><span class="line"></span><br><span class="line">PG_MODULE_MAGIC;</span><br><span class="line"></span><br><span class="line">PG_FUNCTION_INFO_V1(char_count_c);</span><br><span class="line"></span><br><span class="line">Datum</span><br><span class="line">char_count_c(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">int</span> charCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">text</span> * inputText = PG_GETARG_TEXT_PP(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">text</span> * targetChar = PG_GETARG_TEXT_PP(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> inputText_sz = VARSIZE(inputText)-VARHDRSZ;</span><br><span class="line">        <span class="keyword">int</span> targetChar_sz = VARSIZE(targetChar)-VARHDRSZ;</span><br><span class="line">        <span class="keyword">char</span> * cp_inputText = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">char</span> * cp_targetChar = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( targetChar_sz &gt; <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                elog(ERROR, <span class="string">"arg1 must be 1 char long"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cp_inputText = (<span class="keyword">char</span> *) palloc ( inputText_sz + <span class="number">1</span>);</span><br><span class="line">        cp_targetChar = (<span class="keyword">char</span> *) palloc ( targetChar_sz + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(cp_inputText, VARDATA(inputText), inputText_sz);</span><br><span class="line">        <span class="built_in">memcpy</span>(cp_targetChar, VARDATA(targetChar), targetChar_sz);</span><br><span class="line"></span><br><span class="line">        elog(INFO, <span class="string">"arg0 length is %d, value %s"</span>, (<span class="keyword">int</span>)<span class="built_in">strlen</span>(cp_inputText), cp_inputText );</span><br><span class="line">        elog(INFO, <span class="string">"arg1 length is %d, value %s"</span>, (<span class="keyword">int</span>)<span class="built_in">strlen</span>(cp_targetChar), cp_targetChar );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ( i &lt; <span class="built_in">strlen</span>(cp_inputText) )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span>( cp_inputText[i] == cp_targetChar[<span class="number">0</span>] )</span><br><span class="line">                        charCount++;</span><br><span class="line">                i++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pfree(cp_inputText);</span><br><span class="line">        pfree(cp_targetChar);</span><br><span class="line">        PG_RETURN_INT32(charCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can compile the extension</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>If make is successful, there should be a new C shared library created</p>
<p><img src="/images/c-make-shared.png" alt="extension"></p>
<p>Let’s go ahread and install</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>This will copy the<br>char_count_c–1.0.sql and char_count_c.control to $SHAREDIR/extension<br>and char_count_c.so to $LIBDIR</p>
<p>Make sure char_count_c.so is indeed installed to the $LIBDIR, otherwise, PG will not be able to find it when the extension is loaded.</p>
<p>With the extension installed, we can connect to the PG server and use the new extension</p>
<p><img src="/images/char_count_c_load.png" alt="extension"></p>
<p>Create a new test case in char_count_c/sql</p>
<p>let’s make a copy of the test case from previous “char_count” example and change the names to “char_count_c”</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION char_count_c;</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'b'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc'</span>,<span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'x'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'b'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'5'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'0'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> char_count_c(<span class="string">'aaaabbbbbbbcc1111222222233333335555590'</span>,<span class="string">'asd'</span>);</span><br></pre></td></tr></table></figure>

<p>Please note that in the Makefile, we have to also specifiy the name of the regression tests with this line:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REGRESS = char_count_c</span><br></pre></td></tr></table></figure>

<p>Run the test case</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make installcheck</span><br></pre></td></tr></table></figure>

<p>copy the .out file to expected folder</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp char_count_c/results/char_count_c.out char_count_c/expected</span><br></pre></td></tr></table></figure>

<h3 id="7-Add-the-new-extensions-to-global-Makefile"><a href="#7-Add-the-new-extensions-to-global-Makefile" class="headerlink" title="7. Add the new extensions to global Makefile"></a>7. Add the new extensions to global Makefile</h3><p>If you would like to have your extensions built along with the community ones, instead of building individually, you will need to modify the global extension Makefile located in [PG SOURCE DIR]/contrib/Makefile, and add:</p>
<p>char_count and char_count_c in SUBDIRS parameter</p>
<h3 id="8-Summary"><a href="#8-Summary" class="headerlink" title="8. Summary"></a>8. Summary</h3><p>Postgres is a very flexibile and powerful database system that provides different ways for the end users to extend existing functionalities to fulfill his or her business needs.</p>
<p>From the examples above, we have learned that since Postgres version 9, we are able to create new extensions using either plpgsql or C language and be able to create regression tests as part of the extension build to ensure the extensions will work as intended.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/09/25/A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-thumbnail.png" alt="A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-26T05:32:25.000Z">2019-09-25</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 minutes read (About 1500 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/25/A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function/">A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>Table partitioning is introduced after Postgres version 9.4 that provides several performance improvement under extreme loads. Partitioning refers to splitting one logically large table into smaller pieces, which in turn distribute heavy loads across smaller pieces (also known as partitions).</p>
<p>There are several ways to define a partition table, such as declarative partitioning and partitioning by inheritance. In this article we will focus on a simple form of declarative partitioning by value range.</p>
<p>Later in this article, we will discuss how we can define a <code>TRIGGER</code> to work with a <code>FUNCTION</code> to make table updates more dynamic.</p>
<h3 id="2-Creating-a-Table-Partition-by-Range"><a href="#2-Creating-a-Table-Partition-by-Range" class="headerlink" title="2. Creating a Table Partition by Range"></a>2. Creating a Table Partition by Range</h3><p>Let’s define a use case. Say we are a world famous IT consulting company and there is a database table called <code>salesman_performance</code>, which contains all the sales personnel world wide and their lifetime revenue of sales. Technically it is possible to have one table containing all sales personnel in the world but as entries get much larger, the query performance may be greatly reduced.</p>
<p>Here, we would like to create 7 partitions, representing 7 different levels of sales (or ranks) like so:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance (</span><br><span class="line">        salesman_id <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">NULL</span>,</span><br><span class="line">        first_name <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">        last_name <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">        revenue <span class="built_in">numeric</span>(<span class="number">11</span>,<span class="number">2</span>),</span><br><span class="line">        last_updated <span class="built_in">timestamp</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (revenue);</span><br></pre></td></tr></table></figure>

<p>Please note that, we have to specify that it is a partition table by using keyword “PARTITION BY RANGE”. It is not possible to alter a already created table and make it a partition table.</p>
<p>Now, let’s create 7 partitions based on revenue performance:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_chief <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">100000000.00</span>) <span class="keyword">TO</span> (<span class="number">999999999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_elite <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">10000000.00</span>) <span class="keyword">TO</span> (<span class="number">99999999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_above_average <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">1000000.00</span>) <span class="keyword">TO</span> (<span class="number">9999999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_average <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">100000.00</span>) <span class="keyword">TO</span> (<span class="number">999999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_below_average <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">10000.00</span>) <span class="keyword">TO</span> (<span class="number">99999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_need_work <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">1000.00</span>) <span class="keyword">TO</span> (<span class="number">9999.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> salesman_performance_poor <span class="keyword">PARTITION</span> <span class="keyword">OF</span> salesman_performance</span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0.00</span>) <span class="keyword">TO</span> (<span class="number">999.99</span>);</span><br></pre></td></tr></table></figure>
<p>Let’s insert some values into “salesman_performace” table with different users having different revenue performance:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">1</span>, <span class="string">'Cary'</span>, <span class="string">'Huang'</span>, <span class="number">4458375.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">2</span>, <span class="string">'Nick'</span>, <span class="string">'Wahlberg'</span>, <span class="number">340.2</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">3</span>, <span class="string">'Ed'</span>, <span class="string">'Chase'</span>, <span class="number">764.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">4</span>, <span class="string">'Jennifer'</span>, <span class="string">'Davis'</span>, <span class="number">33750.12</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">5</span>, <span class="string">'Johnny'</span>, <span class="string">'Lollobrigida'</span>, <span class="number">4465.23</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">6</span>, <span class="string">'Bette'</span>, <span class="string">'Nicholson'</span>, <span class="number">600.44</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">7</span>, <span class="string">'Joe'</span>, <span class="string">'Swank'</span>, <span class="number">445237.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">8</span>, <span class="string">'Fred'</span>, <span class="string">'Costner'</span>, <span class="number">2456789.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">9</span>, <span class="string">'Karl'</span>, <span class="string">'Berry'</span>, <span class="number">4483758.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">10</span>, <span class="string">'Zero'</span>, <span class="string">'Cage'</span>, <span class="number">74638930.64</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">11</span>, <span class="string">'Matt'</span>, <span class="string">'Johansson'</span>, <span class="number">655837.34</span>, <span class="string">'2019-09-20 16:00:00'</span>);</span><br></pre></td></tr></table></figure>

<p>Postgres will automatically distribute queries to the respective partition based on revenue range. </p>
<p>You may run the \d+ command to see the table and its partitions</p>
<p><img src="/images/partition-table.png" alt="partition-table"></p>
<p>or examine just salesman_performance, which shows partition key and range</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">\d+ salesman-performance</span><br></pre></td></tr></table></figure>

<p><img src="/images/partition-table-info.png" alt="partition-table"></p>
<p>we can also use EXPLAIN ANALYZE query to see the query plan PG system makes to scan each partition. In the plan, it indicates how many rows of records exist in each partition</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">ANALYZE</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> salesman_performance;</span><br></pre></td></tr></table></figure>
<p><img src="/images/partition-table-query-plan.png" alt="partition-table"></p>
<p>There you have it. This ia a very basic partition table that distributes data by value range.</p>
<p>One of the advantages of using partition table is that bulk loads and deletes can be done simply by adding or removing partitions (DROP TABLE). This is much faster and can entirely avoid VACUUM overhead caused by DELETE</p>
<p>When you make a update to an entry. Say salesman_id 1 has reached the “Chief” level of sales rank from “Above Average” rank</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> salesman_performance <span class="keyword">SET</span> revenue = <span class="number">445837555.34</span> <span class="keyword">where</span> salesman_id=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>You will see that Postgres automatically put salesman_id 1 into the “salesman_performance_chief” partition and removes from “salesman_performance_above_average”</p>
<h3 id="3-Delete-and-Detach-Partition"><a href="#3-Delete-and-Detach-Partition" class="headerlink" title="3. Delete and Detach Partition"></a>3. Delete and Detach Partition</h3><p>A partition can be deleted completely simply by the “DROP TABLE [partition name]” command. This may not be desirable in some use cases.</p>
<p>The more recommended approach is to use “DETACH PARTITION” queries, which removes the partition relationship but preserves the data.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> salesman_performance DETACH <span class="keyword">PARTITION</span> salesman_performance_chief;</span><br></pre></td></tr></table></figure>

<p>If a partition range is missing, and the subsequent insertion has a range that no other partitions contain, the insertion will fail.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> salesman_performance <span class="keyword">VALUES</span>( <span class="number">12</span>, <span class="string">'New'</span>, <span class="string">'User'</span>, <span class="number">755837555.34</span>, <span class="keyword">current_timestamp</span>);</span><br><span class="line"></span><br><span class="line">=&gt; should result in failure because no partitions contain a range for this revenue =  755837555.34</span><br></pre></td></tr></table></figure>
<p>If we add back the partition for the missing range, then the above insertion will work:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> salesman_performance ATTACH <span class="keyword">PARTITION</span> salesman_performance_chief</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">100000000.00</span>) <span class="keyword">TO</span> (<span class="number">999999999.99</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-Create-Function-Using-Plpgsql-and-Define-a-Trigger"><a href="#4-Create-Function-Using-Plpgsql-and-Define-a-Trigger" class="headerlink" title="4. Create Function Using Plpgsql and Define a Trigger"></a>4. Create Function Using Plpgsql and Define a Trigger</h3><p>In this section, we will use an example of subscriber and coupon code redemption to illustrate the use of Plpgsql function and a trigger to correctly manage the distribution of available coupon codes.</p>
<p>First we will have a table called “subscriber”, which store a list of users and a table called “coupon”, which stores a list of available coupons.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> subscriber (</span><br><span class="line">    sub_id <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">NULL</span>,</span><br><span class="line">    first_name <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">    last_name <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">    coupon_code_redeemed <span class="built_in">varchar</span>(<span class="number">200</span>),</span><br><span class="line">    last_updated <span class="built_in">timestamp</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> coupon (</span><br><span class="line">    coupon_code <span class="built_in">varchar</span>(<span class="number">45</span>),</span><br><span class="line">    percent_off <span class="built_in">int</span> <span class="keyword">CHECK</span> (percent_off &gt;= <span class="number">0</span> <span class="keyword">AND</span> percent_off&lt;=<span class="number">100</span>),</span><br><span class="line">    redeemed_by <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line">    time_redeemed <span class="built_in">timestamp</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Let’s insert some records to the above tables:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> subscriber (sub_id, first_name, last_name, last_updated) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Cary'</span>,<span class="string">'Huang'</span>,<span class="keyword">current_timestamp</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> subscriber  (sub_id, first_name, last_name, last_updated) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Nick'</span>,<span class="string">'Wahlberg'</span>,<span class="keyword">current_timestamp</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> subscriber  (sub_id, first_name, last_name, last_updated) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Johnny'</span>,<span class="string">'Lollobrigida'</span>,<span class="keyword">current_timestamp</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> subscriber  (sub_id, first_name, last_name, last_updated) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Joe'</span>,<span class="string">'Swank'</span>,<span class="keyword">current_timestamp</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> subscriber  (sub_id, first_name, last_name, last_updated) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Matt'</span>,<span class="string">'Johansson'</span>,<span class="keyword">current_timestamp</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> coupon (coupon_code, percent_off) <span class="keyword">VALUES</span>(<span class="string">'CXNEHD-746353'</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> coupon (coupon_code, percent_off)  <span class="keyword">VALUES</span>(<span class="string">'CXNEHD-653834'</span>,<span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> coupon (coupon_code, percent_off)  <span class="keyword">VALUES</span>(<span class="string">'CXNEHD-538463'</span>,<span class="number">40</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> coupon (coupon_code, percent_off)  <span class="keyword">VALUES</span>(<span class="string">'CXNEHD-493567'</span>,<span class="number">50</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> coupon (coupon_code, percent_off)  <span class="keyword">VALUES</span>(<span class="string">'CXNEHD-384756'</span>,<span class="number">95</span>);</span><br></pre></td></tr></table></figure>

<p>The tables now look like:<br><img src="/images/coupon-and-subscriber.png" alt="trigger-function"></p>
<p>Say one subscriber redeems a coupon code, we would need a <code>FUNCTION</code> to check if the redeemed coupon code is valid (ie. Exists in coupon table). If valid, we will update the subscriber table with the coupon code redeemed and at the same time update the coupon table to indicate which subscriber redeemed the coupon and at what time.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> redeem_coupon() <span class="keyword">RETURNS</span> <span class="keyword">trigger</span> <span class="keyword">AS</span> $redeem_coupon$</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">EXISTS</span> ( <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> coupon c <span class="keyword">where</span> c.coupon_code = NEW.coupon_code_redeemed ) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> coupon <span class="keyword">SET</span> redeemed_by=OLD.first_name, time_redeemed=<span class="string">'2019-09-20 16:00:00'</span> <span class="keyword">where</span>  coupon_code = NEW.coupon_code_redeemed;</span><br><span class="line">    ELSE</span><br><span class="line">        RAISE EXCEPTION 'coupon code does not exist';</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">        RETURN NEW;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line">$redeem_coupon$ LANGUAGE plpgsql;</span><br></pre></td></tr></table></figure>

<p>we need to define a <code>TRIGGER</code>, which is invoked BEFORE UPDATE, to check the validity of a given coupon code.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> redeem_coupon_trigger</span><br><span class="line">  <span class="keyword">BEFORE</span> <span class="keyword">UPDATE</span></span><br><span class="line">  <span class="keyword">ON</span> subscriber</span><br><span class="line">  <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line">  <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> redeem_coupon();</span><br></pre></td></tr></table></figure>

<p>\d+ subscriber should look like this:</p>
<p><img src="/images/trigger_table.png" alt="trigger-function"></p>
<p>Let’s have some users redeem invalid coupon codes and as expected, an exception will be raised if coupon code is not valid.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'12345678'</span> <span class="keyword">where</span> first_name=<span class="string">'Cary'</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'87654321'</span> <span class="keyword">where</span> first_name=<span class="string">'Nick'</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'55555555'</span> <span class="keyword">where</span> first_name=<span class="string">'Joe'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/images/invalid-coupon.png" alt="trigger-function"></p>
<p>Let’s correct the above and redeem only the valid coupon codes and there should not be any error.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'CXNEHD-493567'</span> <span class="keyword">where</span> first_name=<span class="string">'Cary'</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'CXNEHD-653834'</span> <span class="keyword">where</span> first_name=<span class="string">'Nick'</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> subscriber <span class="keyword">set</span> coupon_code_redeemed=<span class="string">'CXNEHD-384756'</span> <span class="keyword">where</span> first_name=<span class="string">'Joe'</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/valid-coupon.png" alt="trigger-function"></p>
<p>Now both table should look like this, and now both table have information cross-related.</p>
<p><img src="/images/coupon-redeemed.png" alt="trigger-function"></p>
<p>And there you have it, a basic trigger function executed before each update.</p>
<h3 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h3><p>With the support of partitioned table defined by value range, we are able to define a condition for postgres to automatically split the load of a very large table across many smaller partitions. This has a lot of benefits in terms of performance boost and more efficient data management.</p>
<p>Having postgres <code>FUNCTION</code>  and <code>TRIGGER</code> working together as a duo, we are able to make general queries and updates more dynamic and automatic to achieve more complex operations. As some of the complex logics can be defined and handled as <code>FUNCTION</code>, which is then invoked at appropriate moment defined by <code>TRIGGER</code>, the application integrated to Postgres will have much less logics to implement. </p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2019/07/04/Types-of-SNMP-OIDs-Explained/" class="image is-7by1">
            <img class="thumbnail" src="/images/SNMP.png" alt="Types of SNMP OIDs Explained">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-07-04T22:14:21.000Z">2019-07-04</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1009 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/07/04/Types-of-SNMP-OIDs-Explained/">Types of SNMP OIDs Explained</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h3><p>SNMP stands for Simple Network Management Protocol and it is commonly used to access and manage network equipment such as switches and routers. It has been available for a long time and has evolved quite a lot with better functionality and security. Each SNMP object can be addressed by its Object IDs (OIDs) and I find that many new SNMP users are confused about the SNMP OIDs and how they should be used correctly. There are 3 major kinds of SNMP OIDs, scalar, table and dynamic and each has its own unique way of accessing. This blog will explain each type of OID and show how they can be accessed correctly.</p>
<h3 id="2-Scalar"><a href="#2-Scalar" class="headerlink" title="2. Scalar"></a>2. Scalar</h3><p>Scalar SNMP OID represents one single value that is available for GET/SET on a SNMP agent. This type of SNMP OID is represented by a ‘leaf icon’ (if read only) or a “paper and pen” icon (if read and write) on MIB browser.</p>
<p>To access a scalar value SNMP OID, you need to append a zero (0) in the end of the OID number. </p>
<p>For example:<br>cxSysBplTopologyTree has OID number = .1.3.6.1.4.1.6232.8.1.1.1</p>
<p>To access it, you much append a zero (0) in the end to indicate that you want to access this OID as a scalar value. So it becomes = .1.3.6.1.4.1.6232.8.1.1.1.0. without this zero, you will get “OID does not exist error”</p>
<p><img src="/images/snmp-oid1.png" alt="extension"></p>
<h3 id="3-Table"><a href="#3-Table" class="headerlink" title="3. Table"></a>3. Table</h3><p>Table OID represents one or more sets of values that are available for GET/SET on a SNMP agent. This type of SNMP OID is represented by a ‘Table icon’ on MIB browser. Each Table OID must have an index value that can be used by the client to select which table entry to retrieve value from. The index value is represented by the “key” icon on MIB browser and normally it is defined as integer.</p>
<p>To access a value from a Table OID, you need to append an index number that is larger than zero at the end of the OID number</p>
<p>For example:<br>plSysFWVersion has OID = .1.3.6.1.4.1.6232.8.3.1.1.5</p>
<p>To access it, you must append an index number in the end of the OID number to select one of many table entries. In most cases, (also our case), you need to put the index number = 1 to indicate you would like the value from table entry number 1. So the OID becomes .1.3.6.1.4.1.6232.8.3.1.1.5.1. Without this index number 1, you will get “OID does not exist error”.</p>
<h4 id="Why-do-we-need-a-table-OID"><a href="#Why-do-we-need-a-table-OID" class="headerlink" title="Why do we need a table OID?"></a>Why do we need a table OID?</h4><p>SNMP is mostly used to manage network equipment and it is common that this network equipment can have multiple Network Interface Card (NIC), for example (eth0, eth1, eth4…etc). If table is not used, you will need to define multiple separate sets of SNMP OIDS, each corresponding to one NIC. This is extremely not efficient and could get messy. Easier way is to define the table OIDs containing only one set of OID common for all NICs, and manager software can access each NIC’s OID values simply by varying the index number  </p>
<p><img src="/images/snmp-oid2.png" alt="extension"></p>
<h3 id="4-Dynamic-OID"><a href="#4-Dynamic-OID" class="headerlink" title="4. Dynamic OID"></a>4. Dynamic OID</h3><p>Dynamic OID is a more advanced usage of Table OID, which involves using more than one value to index table entries. In table OID, we talked about using one integer value to select a table entry by appending a number in the end of OID value. In addition to the integer number acting as primary index, we can define a second index value to further refine the result… like a 2 dimensional table, and we call this dynamic OID. For dynamic OID, the table is defined like the picture below… with 2 keys defined to look up a table value:</p>
<p>plPhyByMACCard and plPhyByMACMAC</p>
<p><img src="/images/snmp-oid3.png" alt="extension"></p>
<p>This means in order to retrieve a value from this table, you have to supply 2 key values</p>
<p>•    plPhyByMACCard<br>This is an integer value index, which we will append “1” in our case just like the previous chapter </p>
<p>•    plPhyByMACMAC<br>This is the second index, and it has a type = PHYSADDRESS instead of integer, this means you need to append the 6 byte MAC address (in decimal form) also to the end of the OID in order to retrieve this value</p>
<p>For example:<br>•    plPhyByMACTxPhySpeed has OID = .1.3.6.1.4.1.6232.8.3.3.1.1.11</p>
<p>We need to append a “1” in the end of the OID due to first index (plPhyByMACCard)<br>So it becomes .1.3.6.1.4.1.6232.8.3.3.1.1.11.1</p>
<p>•    Now we need to tell the agent which MAC address we would like to get the PHY speed from, let’s say MAC = 00:0B:C2:12:CD:E3. In our case, this MAC address is sent to the transport in cxSysPeerMacAddr attribute field</p>
<p>•    We need to convert the MAC to 6 decimal numbers<br>So it becomes 0.11.194.18.205.227</p>
<p>•    Now we append the six numbers at the end of the OID that has been appended 1 from previous step:<br>So it becomes .1.3.6.1.4.1.6232.8.3.3.1.1.11.1.0.11.194.18.205.227</p>
<h4 id="Why-do-we-need-a-second-key-value-defined-as-MAC-address"><a href="#Why-do-we-need-a-second-key-value-defined-as-MAC-address" class="headerlink" title="Why do we need a second key value defined as MAC address?"></a>Why do we need a second key value defined as MAC address?</h4><p>Let’s say a network switch has 5 devices connected to it having 5 different MAC addresses and there is one dynamic table OID using Network ID and MAC as keys defined to record the PHY speed to each connected equipment. In order for a SNMP manager to read the speed to one MAC equipment, it has to supply both network id and MAC address as index to the SNMP table so the agent can return the speed for respective device. Without dynamic table OID, the client simply cannot retrieve the speed value for any of the devices. SNMP walk can be used to GET all the available table entries, which represent all the devices connected.</p>
<p><img src="/images/snmp-oid4.png" alt="extension"></p>
<p>In the screenshot above, I first did a snmpwalk on OID .1.3.6.1.4.1.6232.8.3.3.1.1.11 without any index added, then I receive 2 entries, each entry corresponding to the Tx speed of one MAC. As you can see, even the returned value has the OID + integer index + MAC index. Second, I did a snmpget on OID .1.3.6.1.4.1.6232.8.3.3.1.1.11.1.0.11.194.18.205.227 and I only get one entry in the result as I have selected.</p>

        </div>
        
        
        
    </div>
</div>








</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/prof-img.jpg" alt="Cary Huang">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Cary Huang
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Multi-Displined Software Developer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Vancouver</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            6
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Category
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            1
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/caryhuang" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/caryhuang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://www.facebook.com/cary.huang.35">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.etsy.com/ca/shop/ShokuninDesignCo" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Etsy Shop</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.etsy.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.amazon.com/s?me=A7PVGNIPUKPQW&marketplaceID=ATVPDKIKX0DER" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Amazon Store Front</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.amazon.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Software-Development/">
            <span class="level-start">
                <span class="level-item">Software Development</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/postgres/" style="font-size: 20px;">postgres</a> <a href="/tags/snmp-networking/" style="font-size: 10px;">snmp, networking</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <a href="/2019/10/29/Steaming-Replication-Setup-in-PG12-How-to-do-it-right/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Steaming-Replication-Setup-in-PG12-How-to-do-it-right">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-10-30T06:36:39.000Z">2019-10-29</time></div>
                    <a href="/2019/10/29/Steaming-Replication-Setup-in-PG12-How-to-do-it-right/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Steaming-Replication-Setup-in-PG12-How-to-do-it-right</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/09/27/Replication-Failover-with-pg-rewind-in-PG12/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Replication-Failover-with-pg_rewind-in-PG12">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-28T06:36:52.000Z">2019-09-27</time></div>
                    <a href="/2019/09/27/Replication-Failover-with-pg-rewind-in-PG12/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Replication-Failover-with-pg_rewind-in-PG12</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/09/27/Trace-Postgres-query-processing-internals-with-debugger/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-thumbnail.png" alt="Trace-Postgres-query-processing-internals-with-debugger">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-28T06:36:24.000Z">2019-09-27</time></div>
                    <a href="/2019/09/27/Trace-Postgres-query-processing-internals-with-debugger/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Trace-Postgres-query-processing-internals-with-debugger</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/09/25/A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-thumbnail.png" alt="A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-26T06:36:03.000Z">2019-09-25</time></div>
                    <a href="/2019/09/25/A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres/" class="title has-link-black-ter is-size-6 has-text-weight-normal">A-Guide-to-Create-User-Defined-Extension-Modules-to-Postgres</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/09/25/A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-thumbnail.png" alt="A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-26T05:32:25.000Z">2019-09-25</time></div>
                    <a href="/2019/09/25/A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function/" class="title has-link-black-ter is-size-6 has-text-weight-normal">A-Guide-to-Basic-Postgres-Partition-Table-and-Trigger-Function</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Software-Development/">Software Development</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">October 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">September 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">July 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgres/">
                        <span class="tag">postgres</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/snmp-networking/">
                        <span class="tag">snmp, networking</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/mini4more.png" alt="Cary&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 Cary Huang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://yoursite.com',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>