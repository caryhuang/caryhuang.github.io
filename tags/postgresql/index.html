<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Tag: Postgresql - Cary&#39;s Blog</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="Cary&#39;s Blog">
<meta property="og:url" content="http://caryhuang.github.io/tags/Postgresql/index.html">
<meta property="og:site_name" content="Cary&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://caryhuang.github.io/images/og_image.png">
<meta property="article:author" content="Cary Huang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://caryhuang.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Cary's Blog" type="application/atom+xml">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
                <a class="navbar-item"
                href="/about/me.html">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">Tags</a></li>
            <li class="is-active"><a href="#" aria-current="page">Postgresql</a></li>
        </ul>
        </nav>
    </div>
</div>

    
<div class="card">
    
    <div class="card-image">
        <a href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/" class="image is-7by1">
            <img class="thumbnail" src="/images/copy.png" alt="Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-07-08T16:45:40.000Z">2022-07-08</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 minutes read (About 921 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/">Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>Recently in my development work, a custom connection is required to be maintained between a PG backend on primary and another PG backends on standby nodes to communicate custom data in addition to the existing walsender/walreceiver connection that streams WAL data. Of course, I could just create a new standalone backend and maintain a socket connection myself to communicate custom data. Technically, It could work, but it also created several problems. the persistence, user security, data encryption of this custom connection all need to be handled as well. So, why not just use libpq to handle all of these for us? Today, in this blog, I will share my experience with using libpq COPY protocol to maintain a custom connection for custom data based on PG14.</p>
<h3 id="2-Create-new-routines-in-libpqwalreceiver-c"><a href="#2-Create-new-routines-in-libpqwalreceiver-c" class="headerlink" title="2. Create new routines in libpqwalreceiver.c"></a>2. Create new routines in libpqwalreceiver.c</h3><p>This file is located in <code>src/backend/replication/libpqwalreceiver</code> and is compiled as a shared library (.so) that contains routines related to libpq library that allows a PG backend to use libpq without having it compiled in the backend code. When a PG backend process needs to use libpq, it needs to load the shared library first using <code>load_file()</code> call. </p>
<p>My requirement is simple, the new routines I needed are <code>connect</code>, <code>send</code>, <code>recv</code>, similar to normal socket interactions. I do not have a <code>close</code> function defined here, because I would like the connection to be persisted as long as the primary and standby are running. When one of them exits, the connection will be automatically terminated once it has detected the peer has disconnected. </p>
<h3 id="3-The-Connect-Routine"><a href="#3-The-Connect-Routine" class="headerlink" title="3. The Connect Routine"></a>3. The Connect Routine</h3><p>Unlike the <code>libpqrcv_connect</code> routine for replication, my case is much simpler. I just need my standby node to connect to the primary node, so I can simply reuse standby’s <code>primary_conninfo</code> configuration parameter to connect. This will trigger the primary node to fork a new backend process to serve this connection. A code snipper could look like this:</p>
<p><img src="/images/connect.jpg" alt="connect"></p>
<p>I also set my libpq socket connection to use blocking socket and set <code>asyncStatus</code> to be <code>PGASYNC_COPY_BOTH</code> to indicate that I will be doing a bidirectional data communication </p>
<h3 id="4-The-Send-Routine"><a href="#4-The-Send-Routine" class="headerlink" title="4. The Send Routine"></a>4. The Send Routine</h3><p>My send routine is exactlt the same to the <code>libpqrcv_send</code> routine for replication. Both uses <code>PQputCopyData</code> to send streams of data out to the primary. Renamed it for consistency. Snippet below:</p>
<p><img src="/images/send.jpg" alt="send"></p>
<h3 id="5-The-Recv-Routine"><a href="#5-The-Recv-Routine" class="headerlink" title="5. The Recv Routine"></a>5. The Recv Routine</h3><p>Also, very similar to <code>libpqrcv_recv</code> routine for replication, it shares almost exactly the same code. Except that for my requirement, the connection needs to be a <code>synchronous</code> connection. This means that my standby will block while waiting for primary to respond. In order to make recv synchronous, I had to pass a <code>0</code> to the third argument of <code>PQgetCopyData</code>. So, if you are okay with <code>asynchronous</code> connection, this routine could look exactly the same as <code>libpqrcv_recv</code> as well.</p>
<p><img src="/images/recv.jpg" alt="recv"></p>
<h3 id="6-Having-Standby-to-Send-Out-Some-Custom-Data"><a href="#6-Having-Standby-to-Send-Out-Some-Custom-Data" class="headerlink" title="6. Having Standby to Send Out Some Custom Data"></a>6. Having Standby to Send Out Some Custom Data</h3><p>Now that we have the libpq wrapper routines made for our own purpose, we can then have the standby sends some custom data to the primary and waits for a response. Note that I am sending a letter ‘N’ followed by 3 example custom data, 100, 200, 300. Libpq COPY uses the letter <code>d</code> to indicate a COPY command, and what we are doing here is to <code>wrap</code> our own commands within the <code>d</code> command</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">StringInfoData buf_blk_request;</span><br><span class="line">WalReceiverConn *wrconn;</span><br><span class="line">int len;</span><br><span class="line"></span><br><span class="line">load_file(&quot;libpqwalreceiver&quot;, false);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrconn &#x3D; netbuf_connect(&quot;dbname&#x3D;postgres  host&#x3D;127.0.0.1 port&#x3D;5550&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initStringInfo(&amp;buf_blk_request);</span><br><span class="line">pq_sendbyte(&amp;buf_blk_request, &#39;N&#39;);</span><br><span class="line">pq_sendint32(&amp;buf_blk_request, 100);</span><br><span class="line">pq_sendint32(&amp;buf_blk_request, 200);</span><br><span class="line">pq_sendint32(&amp;buf_blk_request, 300);</span><br><span class="line">pq_flush();</span><br><span class="line"></span><br><span class="line">&#x2F;* Send it *&#x2F;</span><br><span class="line">netbuf_send(wrconn, buf_blk_request.data, buf_blk_request.len);</span><br><span class="line"></span><br><span class="line">&#x2F;* Read the data *&#x2F;</span><br><span class="line">len &#x3D; netbuf_recv(wrconn, &amp;tmp, &amp;fd);</span><br><span class="line">if (len &gt; 0)</span><br><span class="line">&#123;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * Something was received from primary</span><br><span class="line">	 *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-Having-Primary-to-Receive-the-Custom-Data"><a href="#7-Having-Primary-to-Receive-the-Custom-Data" class="headerlink" title="7. Having Primary to Receive the Custom Data"></a>7. Having Primary to Receive the Custom Data</h3><p>When we send something using the methods above, the primary’s postmaster’s main loop will receive the data and decide what to do. Because we are using COPY protocol, the first character is <code>d</code>, in which <code>src/backend/tcop/postgres.c</code> already has a handler for that. So we will need to add additional code under the <code>d</code> handler in <code>postgres.c</code> to receive and process the data sent by standby and provide a response if needed.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">case &#39;d&#39;:			&#x2F;* copy data *&#x2F;</span><br><span class="line">	elog(DEBUG2, &quot;copy data request received&quot;);</span><br><span class="line">	int op;</span><br><span class="line"></span><br><span class="line">	op &#x3D; pq_getmsgbyte(&amp;input_message);</span><br><span class="line">	if (op &#x3D;&#x3D; &#39;N&#39;)</span><br><span class="line">	&#123;</span><br><span class="line">		StringInfoData buf_blk_reply;</span><br><span class="line">		int data1, data2, data3;</span><br><span class="line"></span><br><span class="line">		&#x2F;* receive custom data here *&#x2F;</span><br><span class="line">		data1 &#x3D; pq_getmsgint(&amp;input_message, 4);</span><br><span class="line">		data2 &#x3D; pq_getmsgint(&amp;input_message, 4);</span><br><span class="line">		data3 &#x3D; pq_getmsgint(&amp;input_message, 4);</span><br><span class="line">		pq_getmsgend(&amp;input_message);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&#x2F;* send another custom data back to standby here *&#x2F;</span><br><span class="line">		pq_beginmessage(&amp;buf_blk_reply, &#39;d&#39;);</span><br><span class="line">		pq_sendint32(&amp;buf_blk_request, 400);</span><br><span class="line">		pq_sendint32(&amp;buf_blk_request, 500);</span><br><span class="line">		pq_sendint32(&amp;buf_blk_request, 600);</span><br><span class="line">		pq_endmessage(&amp;buf_blk_reply);</span><br><span class="line">		pq_flush();</span><br><span class="line">	&#125;</span><br><span class="line">	break;</span><br></pre></td></tr></table></figure>

<h3 id="8-Summary"><a href="#8-Summary" class="headerlink" title="8. Summary"></a>8. Summary</h3><p>Based on libpq COPY, I have created a separate communication channel between a primary and standby node that can be used to communicate custom data similar to how you would normally handle a regular socket. All this is based on the COPY protocl that libpq already supports and within that protocol, we wrap our own data. In the above examples, when standby sends 100, 200, 300 to the primary, it is able to receive it and respond 400, 500, 600. This simple example can be expanded to support other things that you may need in your development. This way of using COPY for rown purpose may not be the cleaniest way, but it is what works for me.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/" class="image is-7by1">
            <img class="thumbnail" src="/images/visicheck.png" alt="Understand PG&#39;s MVCC Visibility Check Rules">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-06-10T18:13:40.000Z">2022-06-10</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 minutes read (About 973 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/">Understand PG&#39;s MVCC Visibility Check Rules</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>PostgreSQL’s MultiVersion Concurrency Control (MVCC) is an “advanced technique for improving database performance in a multi-user environment” according  to Vadim Mikheev. This technique requires multiple “versions” of the same data tuple exist in the system governed by snapshots taken during different time periods. In other words, under such technique, it is PG’s responsibility to figure out how many tuples are <code>visible</code> to the user and how many are not, according to multiple parameters such as snapshots taken, current transaction ID…etc. This is also known as <code>visibility check</code> rules in PG and today in this blog, I will talk about the basic principles of visibility check so you get an idea how PG performs this task internally and I hope it would be helpful in your development work.</p>
<h3 id="2-Parameters-Involved"><a href="#2-Parameters-Involved" class="headerlink" title="2. Parameters Involved?"></a>2. Parameters Involved?</h3><ul>
<li>The tuple itself, which contains:<ul>
<li>xmin (the transaction ID that inserts this tuple)</li>
<li>xmax (the transaction ID that deletes this tuple if &gt; 0, otherwise it’s not deleted)</li>
<li>cid (command ID)</li>
<li>hintbit </li>
</ul>
</li>
<li>Global top transaction ID if available </li>
<li>current snapshot, which also contains xmin, xmax and cid</li>
<li>Commit Log Data (CLOG)</li>
</ul>
<h3 id="3-The-Process"><a href="#3-The-Process" class="headerlink" title="3. The Process"></a>3. The Process</h3><h4 id="3-1-Check-the-Hintbit"><a href="#3-1-Check-the-Hintbit" class="headerlink" title="3.1 Check the Hintbit"></a>3.1 Check the Hintbit</h4><p>The visibility process starts by checking the hintbit. If hintbit has a state of <code>COMMITTED</code>, then we can skip most of the other visibility checking rules for better efficiency. With the tuple committed, PG then take this tuple’s xmin value to check with the current snapshot to ensure this tuple is not currently <code>in progress</code>. (See 3.3 below for formula to determine <code>in progress</code>). This check is required because there is a chance that this tuple, though committed, is still being updated by other backend processes at this very moment. If the tuple is not currently <code>in progress</code> by other backends, it will finally check its <code>xmax</code> value to ensure that it is invalid. Invalid means it has not been deleted. When all of the above are true, this tuple is considered visible.</p>
<p>If hintbit indicates <code>ABORTED</code>, then this tuple is considered invisible to user. If hintbit has no value, then PG should continue with the rest of visibility check rules.</p>
<h4 id="3-2-Check-If-Tuple’s-xmin-Equal-to-Global-Top-Transaction-ID"><a href="#3-2-Check-If-Tuple’s-xmin-Equal-to-Global-Top-Transaction-ID" class="headerlink" title="3.2 Check If Tuple’s xmin Equal to Global Top Transaction ID"></a>3.2 Check If Tuple’s xmin Equal to Global Top Transaction ID</h4><p>The next check involves taking tuple’s xmin and compare with global top transaction ID to see if they are equal. This global top transaction ID will only be set when user starts the transaction manually with <code>begin</code> clause. If user does not starts the transaction this way (no <code>begin</code> clause is issued), then this global top transaction ID will not be set and therefore this checking will be skipped. </p>
<p>If tuple xmin equals global top transaction ID, this means the tuple is currently <code>in progress</code> by the current backend, not others. This is where the command ID (cid) will be used to determine the visibility. Within a transaction block, each command issued has an associated command ID to indicate what command comes first and what comes later. For example, if a SELECT comes after an UPDATE, within a transaction, then the SELECT must see the new tuple updated by the previous UPDATE clause and cid plays a part in this determination. This behavior is also governed by the <code>isolation level</code> which is unfortunately out of scope of this blog. The default isolation level is <code>READ COMMITTED</code>, which makes the SELECT sees the data changed by previous UPDATE; but if the isolation is set to <code>REPEATABLE READ</code> then the SELECT will not see the data changed by previous UPDATE. Please keep this in mind.</p>
<p>If tuple’s xmin does not equal to global top transaction ID, then PG should continue with the rest of visibility</p>
<h4 id="3-3-Check-the-Current-Snapshot"><a href="#3-3-Check-the-Current-Snapshot" class="headerlink" title="3.3 Check the Current Snapshot"></a>3.3 Check the Current Snapshot</h4><p>The next check involves the PG to check if this tuple is currently <code>in progress</code> by other backend processes. This is done by comparing the tuple’s xmin value against current snapshot’s xmin and xmax values according to this formula.</p>
<ul>
<li>tuple xmin &lt; snapshot xmin = not in progress</li>
<li>tuple xmin &gt;= snapshot xmax = in progress</li>
</ul>
<p>If this tuple is considered <code>in progress</code> by the snapshot, then this tuple must not be visible to the current user because other backends are still working on it. If this tuple is NOT considered <code>in progress</code>, then PG should continue with the rest of visibility check rules.</p>
<h4 id="3-4-Check-the-Commit-Log-CLOG"><a href="#3-4-Check-the-Commit-Log-CLOG" class="headerlink" title="3.4 Check the Commit Log (CLOG)"></a>3.4 Check the Commit Log (CLOG)</h4><p>This next check involves the PG to take tuple’s xmin to check against the CLOG to see if this tuple has been committed or aborted. CLOG is like an array of transaction IDs and each array element stores a commit status. PG has a formula to convert a transaction ID into a CLOG block plus an offset to precisely access the right CLOG element. This CLOG data structure is regularly flushed to disk with checkpoint process and it is located in these 3 directories: <code>pg_xact</code>, <code>pg_multixact</code> and <code>pg_subtrans</code>. </p>
<p>If CLOG says the given tuple is committed, then PG will continue to check the tuple’s <code>xmax</code> value to ensure that it is invalid. Invalid means it has not been deleted and therefore it is visible to user. At the same time, PG will also update the hintbit value of this tuple to <code>COMMITTED</code> such that in the next visibility checking, PG will not access CLOG again, which is rather expensive. </p>
<p>If CLOG says the given tuple is aborted or invalid, then this tuple is not visible to the current user. At the same time, it will also update the hintbit value of this tuple to <code>INVALID</code> </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>The above processes are the very basic visibility rules within PG according to my understanding. Of course there are other complex checking not mentioned here, such as the involvement of sub transactions and multi transactions, but they do follow somewhat similar pattern to what’s mentioned today. I hope this blog would be helpful for you.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/" class="image is-7by1">
            <img class="thumbnail" src="/images/2pc2.png" alt="Atomic Commit with 2 Phase Commit in FDW Distributed Setup">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-05-06T18:51:12.000Z">2022-05-06</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 minutes read (About 849 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/">Atomic Commit with 2 Phase Commit in FDW Distributed Setup</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>PostgreSQL’s 2 phase commit (2PC) feature allows a database to store the details of a transaction on disk without committing it. This is done by issuing <code>PREPARE TRANSACTION [name]</code> command at the end of a transaction block. When the user is ready to commit, he/she can issue <code>COMMIT PREPARED [name]</code> where [name] should match the [name] in PREPARE TRANSACTION command. Because the transaction details are stored on disk with 2PC, the server is able to commit this transaction at a later time even if it crashes or out of service for some time. In a single database instance, the use of 2PC is not critical; the plain ‘commit’ can perform the job equally as well. However, in a larger setup, the data may be distributed on 2 or more database instances (for example, via Foreign Data Wrapper (FDW)), the use of 2PC is absolutely critical here to keep every database instance in sync. </p>
<h3 id="2-Atomic-Commit-Problem-with-Foreign-Data-Wrapper-FDW"><a href="#2-Atomic-Commit-Problem-with-Foreign-Data-Wrapper-FDW" class="headerlink" title="2. Atomic Commit Problem with Foreign Data Wrapper (FDW)"></a>2. Atomic Commit Problem with Foreign Data Wrapper (FDW)</h3><p>Current postgres_fdw does not support the use of 2PC to commit foreign server. When a <code>commit</code> command is sent to the main server, it will send the same <code>commit</code> command to all of the foreign servers before processing the <code>commit</code> for itself. If one of the foreign node fails the <code>commit</code>, the main server will go through a <code>abort</code> process and will not commit itself due to the failure. However, some of the foreign nodes could already been successfully committed, resulting in a partially committed transaction.</p>
<p>Consider this diagram:</p>
<p><img src="/images/2pc-illustrate.drawio.png" alt=""></p>
<p>where the CN node fails the commit to DN3 and goes through a abort process, but at the same time, DN1 and DN2 have already been committed successfully and can no longer be rollbacked. This scenario creates a partial commit that may not be desirable.</p>
<h3 id="3-FDW-with-2PC-Capability"><a href="#3-FDW-with-2PC-Capability" class="headerlink" title="3. FDW with 2PC Capability"></a>3. FDW with 2PC Capability</h3><p>If we were to add a 2PC functionality to current postgres_fdw, instead of sending the same <code>commit</code> to all foreign servers, we let the main server to send <code>PREPARE TRANSACTION</code> instead. The main server should proceed to send COMMIT PREPARE to all foreign servers Only when all of the foreign servers have successfully completed the PREPARE TRANSACTION. If one of them fails at the PREPARE stage, the main server is still able to ROLLBACK those foreign server who have successfully prepared.</p>
<p>Consider this diagram:</p>
<p><img src="/images/2pc-illustrate.drawio2.png" alt=""></p>
<p>where the CN node fails the PREPARE TRANSACTION to DN3 and sends <code>ROLLBACK PREPARED</code> to DN1 and DN2 before going to the abort process. With the 2PC method, there will not be any partial commits.</p>
<h3 id="3-Handling-COMMIT-PREPARED-Failure"><a href="#3-Handling-COMMIT-PREPARED-Failure" class="headerlink" title="3. Handling COMMIT PREPARED Failure?"></a>3. Handling COMMIT PREPARED Failure?</h3><p>If a foreign server fails at the PREPARE stage, it is not too late to rollback the rest of foreign servers that have succeeded the PREPARE, so the main server can still send ROLLBACK PREPARED to the foreign servers. However, if a foreign server fails at the COMMIT PREPARE stage, the other foreign servers who have succeeded it can no longer be rollbacked, potentially causing a partial commit as well.</p>
<p>In our implementation, we still allow the main server to continue with the commit even though a foreign server fails COMMIT PREPARED. In addition, we give user a warning about one of the foreign server may not have committed successfully, which leads to a potential partial commit. The foreign server with a failed COMMIT PREPARE will now have something called a “orphaned prepared transaction” that has yet to be committed. </p>
<p>Consider this diagram:</p>
<p><img src="/images/2pc-illustrate.drawio3.png" alt=""></p>
<p>where DN3 fails a COMMIT PREPARED command and the CN node continues the commit with warning. </p>
<h3 id="4-Handling-Orphaned-Prepared-Transaction"><a href="#4-Handling-Orphaned-Prepared-Transaction" class="headerlink" title="4. Handling Orphaned Prepared Transaction"></a>4. Handling Orphaned Prepared Transaction</h3><p>Following the above example, if we perform a SELECT query, we will see that DN3 does not have an updated value while DN1 and DN2 have been updated. Also, DN3 still have the transaction prepared and stored in its disk. What’s left to do is to have somebody to login to DN3 and manually run a COMMIT PREPARED command. If that is done successfully, there will no longer be a partial commit.</p>
<p>The way we handle this is to make a orphaned prepared transaction detector at each foreign server and we introduce an intermediate and external global transaction manager (GTM) node that records all the FDW operations. Again, following the above example, when DN3 detects a orphaned prepare transaction, it will make a connection to the GTM node and check if this prepared transaction comes from a CN node. If it is, then we simply let DN3 do a self-commit of the prepared transaction automatically, without any human intervention. If GTM does not have a record, then this orphaned prepared transaction must be created manually by another DN3 user and it should not do anything to it except to just give a warning in the log file.</p>
<p>This is the general concept how we handle atomic commit and orphaned prepared transactions. There may be better and more complex solutions out there but for us, having an intermediate GTM node to coordinate all the operations between CN and DN nodes seems to be the simplest.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/" class="image is-7by1">
            <img class="thumbnail" src="/images/2pc.png" alt="Distributed Database With PostgreSQL - Atomic Commit Problems">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-03-18T20:26:14.000Z">2022-03-18</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1063 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/">Distributed Database With PostgreSQL - Atomic Commit Problems</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>If you are into distributed database research, especially one that is setup using Foreign Data Wrapper (FDW) + partitioned foreign tables, you probably have heard that there are many potential issues associated with this setup. Atomic commit, atomic visibility and global deadlock detection are one of the most popular issues that one can encounter in a distributed database environment. </p>
<p>There has been a lot of discussion on the PostgreSQL community on atomic commit and potential ways to solve this problem, and also discuss how this issue introduces an atomic visibility issue. </p>
<p>I recently had a chance to scan through several of the community discussion on atomic commit and would like to share what I have learned in this blog.</p>
<h3 id="2-The-problem"><a href="#2-The-problem" class="headerlink" title="2. The problem"></a>2. The problem</h3><p>In a distributed environment, if a query involves modification to multiple foreign tables (or shards), current PostgreSQL cannot guarantee  either all of them commit or all of them rollback. This means that, if one of them fails to commit for some reason but the rest have succeeded, we will see inconsistent results. The desired behavior would be that if one of the foreign tables fails to commit, PostgreSQL should be able to roll back the ones that have been committed successfully. </p>
<p>However, with the current postgres_fdw and the transaction manager, it is currently not possible to “uncommit” a foreign transaction that has been committed. This is why most of the discussions generally regard PG’s “2 Phase Commit” as the basic building block to achieve atomic commit.</p>
<h3 id="2-2-Phase-Commit-2PC"><a href="#2-2-Phase-Commit-2PC" class="headerlink" title="2. 2 Phase Commit (2PC)"></a>2. 2 Phase Commit (2PC)</h3><p>2PC basically splits a regular commit action into 2 stages, a PREPARE TRANSACTION and a COMMIT PREPARED (or ROLLBACK PREPARED) stage. Doing this allows PG to uncommit an in-progress commit in case it finds a condition that all of the foreign transactions need to be aborted.</p>
<p>For example, 1 Coordinator Node (CN) sends a UPDATE query to 3 Data Nodes (DNs) and would like to commit</p>
<ul>
<li>CN sends a PREPARE TRANSACTION to each DN1 and waits for response </li>
<li>CN sends a PREPARE TRANSACTION to each DN2 and waits for response </li>
<li>CN sends a PREPARE TRANSACTION to each DN3 and waits for response </li>
</ul>
<p>If any of these PREPARE TRANSACTION (say DN3) fails to deliver or its response contains error, CN still has a chance to ROLLBACK transactions on DN1 and DN2 and DEALLOCATE the existing prepared transaction. After that, the CN will abort the local transaction and finish the transaction with error and nothing gets changed here.</p>
<p>Only if all 3 DNs have confirmed the PREPARE TRANSACTION success, CN can then proceed to commit the local transaction, if local succeeds, continue to send COMMIT PREPARED to each DN, or send ROLLBACK PREPARED if local fails</p>
<ul>
<li>CN sends a COMMIT/ROLLBACK PREPARED to each DN1 and waits for response </li>
<li>CN sends a COMMIT/ROLLBACK PREPARED to each DN2 and waits for response </li>
<li>CN sends a COMMIT/ROLLBACK PREPARED to each DN3 and waits for response </li>
</ul>
<p>If any of these fails to COMMIT PREPARED at this point, say (DN3), CN is not able to uncommit DN1 and DN2 that have been 2-phase committed, so at this point, CN can only retry indefinitely to deliver COMMIT PREPARED to DN3 to ensure atomicity. If DN3 is unreachable, CN will keep on trying forever without closing the transaction and leaving the client waiting. </p>
<p>If client choose to cancel the transaction by hitting ctrl-c, then the transaction will close with a warning message that DN3 has not confirmed a COMMIT PREPARED message and data may be inconsistent. DN3 at this point may have an orphaned prepared transaction that needs to be handled. </p>
<h3 id="3-Orphaned-Prepared-Transaction"><a href="#3-Orphaned-Prepared-Transaction" class="headerlink" title="3. Orphaned Prepared Transaction"></a>3. Orphaned Prepared Transaction</h3><p>In the previous example, an orphaned prepared transaction can happen if CN prepares a foreign transaction but never has a chance to commit it (possibly due to network). In this case, the DN node can very easily detect an orphaned prepared transaction based on the time the prepared transaction has been created. Unfortunately, without a centralized Global Transaction Manager (GTM), DN node is not able to decide if this orphaned prepared transaction should be committed or discarded. Therefore, most of the solutions on the community only support the detection of orphaned prepared transaction without any handling.</p>
<h3 id="4-How-Atomic-Visibility-Appeared"><a href="#4-How-Atomic-Visibility-Appeared" class="headerlink" title="4. How Atomic Visibility Appeared?"></a>4. How Atomic Visibility Appeared?</h3><p>Using 2PC allows CN node to rollback a commit during the PREPARE stage but cannot allow rollback during the commit prepared stage, so it can only retry forever or exit with a warning. The visibility issue can happen in a case where DN1 and DN2 have already comitted the prepared transactions while DN3 has not yet committed. At this point, if a client does a SELECT statement across DN1, DN2 and DN3, it will see that DN3 still does not have the right data but DN1 and DN2 have. This is not atomic at all.</p>
<p>To solve this, several people proposed a snapshot that can be shared globally across all the DN and CN nodes. The standard PG’s snapshot is purely based on transaction ID to determine if a tuple is visible or not, but with multiple different PG servers, each of them have their own transaction ID range and could all be very different, so sharing a snapshot based on transaction ID is impossible. </p>
<p>This is why a Commit Sequence Number (CSN) snapshot is being proposed in the discussion, which is based on time, and could be made the same in all of the CN and DN nodes and act as a reference point to determine if a tuple belongs to the past or future. The problem is then shifted to how to ensure all of the CN and DN nodes have consistently the same time? Even the best clock chipsets are subject to time skewing and will slowly go out of sync. The concept of Clock-SI is then added to the discussion, which is designed to handle such a clock skew. This makes the discussion somewhat more complicated and out of scope. </p>
<p>But for me, this may not be worth the effort to completely solve the atomic visibility issue with all these complicated stuff. </p>
<h3 id="5-reference-to-some-of-the-discussions"><a href="#5-reference-to-some-of-the-discussions" class="headerlink" title="5. reference to some of the discussions"></a>5. reference to some of the discussions</h3><p><a href="https://commitfest.postgresql.org/26/1574/">Transactions involving multiple servers</a><br><a href="https://www.postgresql.org/message-id/flat/CA%2BCSw_tEpJ%3Dmd1zgxPkjH6CWDnTDft4gBi%3D%2BP9SnoC%2BWy3pKdA%40mail.gmail.com">Proosal for CSN based snapshot</a><br><a href="https://www.postgresql.org/message-id/flat/21BC916B-80A1-43BF-8650-3363CCDAE09C%40postgrespro.ru">Global snapshot</a></p>

        </div>
        
        
        
    </div>
</div>








</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/prof-img.jpg" alt="Cary Huang">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Cary Huang
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Multi-Displined Software Developer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Vancouver</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            34
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            54
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/caryhuang" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/caryhuang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://www.facebook.com/cary.huang.35">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.etsy.com/ca/shop/ShokuninDesignCo" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Etsy Shop</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.etsy.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.highgo.ca/" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">HighGo Software Canada</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.highgo.ca</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Netsnmp/">
            <span class="level-start">
                <span class="level-item">Netsnmp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/PostgreSQL/">
            <span class="level-start">
                <span class="level-item">PostgreSQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">26</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/2021-PG-Asia-Conference/" style="font-size: 12.5px;">2021 PG Asia Conference</a> <a href="/tags/Postgresql/" style="font-size: 17.5px;">Postgresql</a> <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/atomic-commit/" style="font-size: 12.5px;">atomic commit</a> <a href="/tags/backend/" style="font-size: 10px;">backend</a> <a href="/tags/buffer-manager/" style="font-size: 10px;">buffer manager</a> <a href="/tags/copy/" style="font-size: 10px;">copy</a> <a href="/tags/extended-query/" style="font-size: 10px;">extended query</a> <a href="/tags/extension/" style="font-size: 10px;">extension</a> <a href="/tags/external-key-management-system/" style="font-size: 10px;">external key management system</a> <a href="/tags/failover/" style="font-size: 10px;">failover</a> <a href="/tags/fdw/" style="font-size: 12.5px;">fdw</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/in-memory/" style="font-size: 10px;">in-memory</a> <a href="/tags/in-memory-table/" style="font-size: 10px;">in-memory table</a> <a href="/tags/key-management-system/" style="font-size: 10px;">key management system</a> <a href="/tags/libpq/" style="font-size: 10px;">libpq</a> <a href="/tags/logical-decoding/" style="font-size: 10px;">logical decoding</a> <a href="/tags/logical-replication/" style="font-size: 10px;">logical replication</a> <a href="/tags/lsn/" style="font-size: 10px;">lsn</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mvcc/" style="font-size: 10px;">mvcc</a> <a href="/tags/networking/" style="font-size: 17.5px;">networking</a> <a href="/tags/oid/" style="font-size: 10px;">oid</a> <a href="/tags/parallel-worker/" style="font-size: 10px;">parallel worker</a> <a href="/tags/partition/" style="font-size: 10px;">partition</a> <a href="/tags/pg13/" style="font-size: 10px;">pg13</a> <a href="/tags/pg-rewind/" style="font-size: 10px;">pg_rewind</a> <a href="/tags/pitr/" style="font-size: 10px;">pitr</a> <a href="/tags/pluggable-api/" style="font-size: 10px;">pluggable api</a> <a href="/tags/pluggable-storage/" style="font-size: 15px;">pluggable storage</a> <a href="/tags/postgres/" style="font-size: 10px;">postgres</a> <a href="/tags/postgresql/" style="font-size: 20px;">postgresql</a> <a href="/tags/postmaster/" style="font-size: 12.5px;">postmaster</a> <a href="/tags/query-processing/" style="font-size: 10px;">query processing</a> <a href="/tags/recovery/" style="font-size: 12.5px;">recovery</a> <a href="/tags/redo/" style="font-size: 10px;">redo</a> <a href="/tags/replication/" style="font-size: 15px;">replication</a> <a href="/tags/savepoint/" style="font-size: 10px;">savepoint</a> <a href="/tags/security/" style="font-size: 17.5px;">security</a> <a href="/tags/sequence/" style="font-size: 10px;">sequence</a> <a href="/tags/snmp/" style="font-size: 10px;">snmp</a> <a href="/tags/streaming-replication/" style="font-size: 10px;">streaming replication</a> <a href="/tags/subtransaction/" style="font-size: 10px;">subtransaction</a> <a href="/tags/table-access-method/" style="font-size: 12.5px;">table access method</a> <a href="/tags/tde/" style="font-size: 10px;">tde</a> <a href="/tags/timeline-id/" style="font-size: 10px;">timeline id</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/trace/" style="font-size: 10px;">trace</a> <a href="/tags/trigger/" style="font-size: 10px;">trigger</a> <a href="/tags/visibility/" style="font-size: 10px;">visibility</a> <a href="/tags/visibility-check/" style="font-size: 10px;">visibility check</a> <a href="/tags/wal2mongo/" style="font-size: 10px;">wal2mongo</a> <a href="/tags/wire-protocol/" style="font-size: 10px;">wire protocol</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <a href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/copy.png" alt="Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-07-08T16:45:40.000Z">2022-07-08</time></div>
                    <a href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/visicheck.png" alt="Understand PG&#39;s MVCC Visibility Check Rules">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-06-10T18:13:40.000Z">2022-06-10</time></div>
                    <a href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Understand PG&#39;s MVCC Visibility Check Rules</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/2pc2.png" alt="Atomic Commit with 2 Phase Commit in FDW Distributed Setup">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-05-06T18:51:12.000Z">2022-05-06</time></div>
                    <a href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Atomic Commit with 2 Phase Commit in FDW Distributed Setup</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/2pc.png" alt="Distributed Database With PostgreSQL - Atomic Commit Problems">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-03-18T20:26:14.000Z">2022-03-18</time></div>
                    <a href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Distributed Database With PostgreSQL - Atomic Commit Problems</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/02/18/The-significance-of-LSN-in-PostgreSQL-System/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/lsn.png" alt="The significance of LSN in PostgreSQL System">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-02-18T19:41:06.000Z">2022-02-18</time></div>
                    <a href="/2022/02/18/The-significance-of-LSN-in-PostgreSQL-System/" class="title has-link-black-ter is-size-6 has-text-weight-normal">The significance of LSN in PostgreSQL System</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2022/07/">
                <span class="level-start">
                    <span class="level-item">July 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/06/">
                <span class="level-start">
                    <span class="level-item">June 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/05/">
                <span class="level-start">
                    <span class="level-item">May 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/03/">
                <span class="level-start">
                    <span class="level-item">March 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/02/">
                <span class="level-start">
                    <span class="level-item">February 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/01/">
                <span class="level-start">
                    <span class="level-item">January 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/12/">
                <span class="level-start">
                    <span class="level-item">December 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/10/">
                <span class="level-start">
                    <span class="level-item">October 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">September 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/08/">
                <span class="level-start">
                    <span class="level-item">August 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/07/">
                <span class="level-start">
                    <span class="level-item">July 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">March 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/02/">
                <span class="level-start">
                    <span class="level-item">February 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">January 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">November 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">September 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">August 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">July 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">June 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">May 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">April 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">March 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">January 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">October 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">September 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">July 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/2021-PG-Asia-Conference/">
                        <span class="tag">2021 PG Asia Conference</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Postgresql/">
                        <span class="tag">Postgresql</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/architecture/">
                        <span class="tag">architecture</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/atomic-commit/">
                        <span class="tag">atomic commit</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/backend/">
                        <span class="tag">backend</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/buffer-manager/">
                        <span class="tag">buffer manager</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/copy/">
                        <span class="tag">copy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extended-query/">
                        <span class="tag">extended query</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extension/">
                        <span class="tag">extension</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/external-key-management-system/">
                        <span class="tag">external key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/failover/">
                        <span class="tag">failover</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/fdw/">
                        <span class="tag">fdw</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/gdb/">
                        <span class="tag">gdb</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory/">
                        <span class="tag">in-memory</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory-table/">
                        <span class="tag">in-memory table</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/key-management-system/">
                        <span class="tag">key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/libpq/">
                        <span class="tag">libpq</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-decoding/">
                        <span class="tag">logical decoding</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-replication/">
                        <span class="tag">logical replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/lsn/">
                        <span class="tag">lsn</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mongodb/">
                        <span class="tag">mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mvcc/">
                        <span class="tag">mvcc</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/networking/">
                        <span class="tag">networking</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/oid/">
                        <span class="tag">oid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/parallel-worker/">
                        <span class="tag">parallel worker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/partition/">
                        <span class="tag">partition</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg13/">
                        <span class="tag">pg13</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg-rewind/">
                        <span class="tag">pg_rewind</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pitr/">
                        <span class="tag">pitr</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-api/">
                        <span class="tag">pluggable api</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-storage/">
                        <span class="tag">pluggable storage</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgres/">
                        <span class="tag">postgres</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgresql/">
                        <span class="tag">postgresql</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postmaster/">
                        <span class="tag">postmaster</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/query-processing/">
                        <span class="tag">query processing</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/recovery/">
                        <span class="tag">recovery</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/redo/">
                        <span class="tag">redo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/replication/">
                        <span class="tag">replication</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/savepoint/">
                        <span class="tag">savepoint</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/security/">
                        <span class="tag">security</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sequence/">
                        <span class="tag">sequence</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/snmp/">
                        <span class="tag">snmp</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/streaming-replication/">
                        <span class="tag">streaming replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/subtransaction/">
                        <span class="tag">subtransaction</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/table-access-method/">
                        <span class="tag">table access method</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tde/">
                        <span class="tag">tde</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/timeline-id/">
                        <span class="tag">timeline id</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tls/">
                        <span class="tag">tls</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trace/">
                        <span class="tag">trace</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trigger/">
                        <span class="tag">trigger</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility/">
                        <span class="tag">visibility</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility-check/">
                        <span class="tag">visibility check</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wal2mongo/">
                        <span class="tag">wal2mongo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wire-protocol/">
                        <span class="tag">wire protocol</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2022 Cary Huang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://caryhuang.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>ize-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/">Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>I am working on a new PostgreSQL feature that redefines the way a tuple’s visibility status is determined. The feature is working very nicely until I start doing a large SELECT query, which triggers PostgreSQL to spawn multiple parallel workers to process the request. When this happens, the feature I am working on start to yield incorrect results. A good portion of the data tuples returned are missing because they are considered as invisible, while some portion of it remains visible. It immediately came to my attention that the new feature I am working on does not work in parallel worker mode and somehow I need to find a way to debug into a spawned parallel worker to examine how it is computing the visibility and what is missing inside.</p>
<p>In this blog, I would like to share with you how I use GDB to debug and trace into a new parallel worker spawned by Postmaster in order to fix the visibility issue.</p>
<h3 id="2-GDB-Basics"><a href="#2-GDB-Basics" class="headerlink" title="2. GDB Basics"></a>2. GDB Basics</h3><p>I wrote another blog previously that shows how to use GDB to trace and debug a PostgreSQL issues and share some of the most common commands that I use every day to resolve software issues. If you are new to GDB, I suggest giving this blog a read <a href="https://www.highgo.ca/2020/11/07/how-to-analyze-a-postgresql-crash-dump-file/">here</a></p>
<h3 id="3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker"><a href="#3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker" class="headerlink" title="3. How and When does PG Spawn A New Parallel Worker"></a>3. How and When does PG Spawn A New Parallel Worker</h3><p>When you use <code>psql</code> to connect to a PostgreSQL database, it will spawn a new backend worker process to serve this connecting client. Most of the queries you provide will be processed by this backend process, includes SELECT, UPDATE, INSERT…etc. By default, if your SELECT query will require doing a sequential scan over 8MB of data, it will try to use a parallel worker to help speed up the processing. This 8MB threshold can be configured by the <code>min_parallel_table_scan_size</code> parameter in <code>postgresql.conf</code> . There is another configuration parameter <code>max_parallel_workers</code> that controls the maximum number of parallel workers is allowed to be spawned. The default is 8. </p>
<p>Technically, I can avoid my visibility issues simply by either setting <code>min_parallel_table_scan_size</code> to a huge number, or setting <code>max_parallel_workers</code> to 0. But this is really not my style, I would like to keep all these goodies that PG provides while being able to solve the problem. </p>
<p>To spawn a parallel worker, the psql backend will initialize a parallel worker context in the global process table and a message queue based on shared memory for communication with the backend. Then it sends a signal to postmaster to notify that the global process table has been updated. </p>
<p>When postmaster receives the signal, it will load the global process table and found that it needs to spawn a new parallel worker. It will proceed to <code>fork</code> a new parallel worker according to the context information supplied. This information determines the entry point for the parallel worker and what to do once spawned. During processing, the parallel worker and the psql backend use the message queue to communicate tuples back and forth and finally the psql backend will gather together all the data tuples and produce a final result back to the user.</p>
<h3 id="4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned"><a href="#4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned" class="headerlink" title="4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?"></a>4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?</h3><p>Technically yes, but the life time of this parallel worker may be very short, by the time you see its PID from the <code>ps -ef</code> command, the worker may have already done its job and exited. This means, it is too late for me to start GDB and attach to its PID. </p>
<p>Instead, the technique I am going to show you today will trace the parallel worker from the moment it starts. </p>
<h3 id="5-Tracing-the-Parallel-Worker"><a href="#5-Tracing-the-Parallel-Worker" class="headerlink" title="5. Tracing the Parallel Worker"></a>5. Tracing the Parallel Worker</h3><p>I will be using this instance of PostgreSQL server (version 12.5) as an example where PID 11976 is the psql backend process serving the psql client. </p>
<p><img src="/images/mypids.png" alt="img"></p>
<h4 id="Pre-Condition"><a href="#Pre-Condition" class="headerlink" title="Pre-Condition:"></a>Pre-Condition:</h4><p>Connect psql to the PostgreSQL server, create an example table and inserted about 2.5M rows of data. This will for sure trigger parallel workers.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ psql -d postgres -U postgres -p 6660</span><br><span class="line">psql (12.5)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create table test(a int, b int);</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>

<h4 id="Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point"><a href="#Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point" class="headerlink" title="Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point"></a>Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point</h4><p>I am setting a break point at the function <code>RegisterDynamicBackgroundWorker</code>. This is called when parallel worker is required to complete the query. Setting a breakpoint allows us more control as to when to proceed with a parallel worker spawn. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11976</span><br><span class="line">(gdb) b RegisterDynamicBackgroundWorker</span><br></pre></td></tr></table></figure>


<h4 id="Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points"><a href="#Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points" class="headerlink" title="Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points"></a>Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points</h4><p>We are using a second GDB to attach to the postmaster and set 2 break points there. <code>fork_process</code> is the function before postmaster actually spawns a new parallel worker using the system <code>fork()</code> call.  <code>ParallelWorkerMain</code> is the main function for the parallel worker after it has been spawned. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11959</span><br><span class="line">(gdb) b fork_process</span><br><span class="line">(gdb) b ParallelWorkerMain</span><br></pre></td></tr></table></figure>

<h4 id="Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points"><a href="#Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points" class="headerlink" title="Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points"></a>Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postgres&#x3D;# select count(*) from test;</span><br></pre></td></tr></table></figure>

<p>The <code>RegisterDynamicBackgroundWorker</code> break point will be hit on the first GDB session having attached PID = 11959</p>
<p>Use the <code>continue</code> or <code>c</code> GDB command to continue to spawn the worker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, RegisterDynamicBackgroundWorker (worker&#x3D;0x7ffd867f3c80, handle&#x3D;0x55a009b77388) at bgworker.c:1002</span><br><span class="line">1002            bool            success &#x3D; false;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>

<p>As you continue the first GDB session, the second GDB session will pause due to receipt of a <code>SIGUSR1</code> signal. This signal tells postmaster to reload the global process table and then spawn a parallel worker. Using the <code>continue</code> command will hit the first break point at <code>fork_process</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Program received signal SIGUSR1, User defined signal 1.</span><br><span class="line">0x00007f301b97d0f7 in __GI___select (nfds&#x3D;5, readfds&#x3D;0x7ffd867f47d0, writefds&#x3D;0x0, exceptfds&#x3D;0x0, timeout&#x3D;0x7ffd867f4740)</span><br><span class="line">    at ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c:41</span><br><span class="line">41      in ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, fork_process () at fork_process.c:47</span><br><span class="line">47              fflush(stdout);</span><br><span class="line"></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent"><a href="#Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent" class="headerlink" title="Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent"></a>Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent</h4><p>At this point, the postmaster GDB is now waiting at the <code>fork_process</code> call, which is right before spawning a parallel worker. This is a good time now to tell GDB to follow the child process instead of staying at parent when the process calls <code>fork()</code>. The reason we want to set this late at this moment is because postmaster is occasionally  spawning other backend processes such as <code>walsender</code> and <code>walreceiver</code>. Setting to follow child process early may cause our GDB to follow to another backend process that we are not interested in.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) set follow-fork-mode child</span><br></pre></td></tr></table></figure>

<p>You may use the <code>continue</code> command after setting it to follow child. Then immediately the GDB will switch to the new child process having PID = 12198 below and hit our second break point <code>ParallelWorkerMain</code>. So, Now the GDB is debugging the parallel worker process instead of the original postmaster.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 12198]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">[Switching to Thread 0x7f301ca79740 (LWP 12198)]</span><br><span class="line"></span><br><span class="line">Thread 2.1 &quot;postgres&quot; hit Breakpoint 2, ParallelWorkerMain (main_arg&#x3D;1544458234) at parallel.c:1207</span><br><span class="line">1207    &#123;</span><br></pre></td></tr></table></figure>

<h4 id="Step-5-Continue-To-Debug-The-Parallel-Process"><a href="#Step-5-Continue-To-Debug-The-Parallel-Process" class="headerlink" title="Step 5: Continue To Debug The Parallel Process"></a>Step 5: Continue To Debug The Parallel Process</h4><p>Using the <code>ps -ef | grep postgres</code> command, we can see a new parallel worker being spawned having PID = 12198</p>
<p><img src="/images/mypids2.png" alt="img"></p>
<p>At this point, you are free to explore the process flow of the parallel worker. For me, I am debugging the visibility issues, so I will set additional break points at <code>HeapTupleSatisfiesMVCC</code> and <code>TransactionIdIsCurrentTransactionId</code>. In your case, you may be debugging some other functionalities. </p>
<p>Being able to debugging into a parallel worker with GDB allows me to see the problems I was having and being able to fix quickly.</p>
<p>If you are having trouble tracing into a parallel workers spawned by PostgreSQL during run time, I hope this blog will be helpful to you.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/" class="image is-7by1">
            <img class="thumbnail" src="/images/banner-2021-03-03.png" alt="How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-03-03T20:17:11.000Z">2021-03-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 minutes read (About 1846 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/">How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>As an experienced PostgreSQL user, you may have a lot of experience in setting up streaming replication in your database clusters to make multiple backups of your data. But have you wondered how the standby is able to correctly determine if a tuple sent from the primary should be visible to the user or not. In the case where a transaction contains multiple subtransactions, how does the standby determine the visibility in this case? You might say… well it is PostgreSQL so it will just work… This is true. If you are someone who is curious and interested in knowing how PostgreSQL does certain things internally, then this blog may be interesting for you as we will talk about normally transaction and subtransactions and how both affect the standby’s ability to determine tuple visibility.</p>
<h3 id="2-How-is-Tuple-Visibility-Determined"><a href="#2-How-is-Tuple-Visibility-Determined" class="headerlink" title="2. How is Tuple Visibility Determined?"></a>2. How is Tuple Visibility Determined?</h3><p>PostgreSQL determines a tuple’s visibility based on the concept of transaction ID (a.k.a <code>txid</code>) and it is normally stored in a tuple’s header as either <code>xmin</code> or <code>xmax</code> where <code>xmin</code> holds the <code>txid</code> of the transaction that inserted this tuple and <code>t_xmax</code> holds the <code>txid</code> of the transaction that deleted or updated this tuple. If a tuple has not been deleted, its <code>t_xmax</code> is 0. There is also another mechanism called commit log (a.k.a <code>clog</code>) where it has information of currently active transaction IDs. When an inserted tuple has a valid <code>t_xmin</code> and invalid <code>t_xmax</code>, PostgreSQL will have to consult the <code>clog</code> first to determine if the <code>txid</code> stored in <code>t_xmin</code> is visible or not, then the result will be stored in the tuple’s <code>hint_bit</code> field about the visibility information such that it does not always have to consult the <code>clog</code> which could be resource intensive. If a tuple has a valid <code>t_xmax</code>, then there is no need to consult the <code>clog</code> as the tuple must be invisible. </p>
<p>This is just the basic ideas of how visibility is determined but it is enough for me to continue with this blog. For more information about visibility, you could refer to this <a href="http://www.interdb.jp/pg/pgsql05.html#_5.7.">resource</a></p>
<h3 id="3-What-is-a-Subtransaction"><a href="#3-What-is-a-Subtransaction" class="headerlink" title="3. What is a Subtransaction?"></a>3. What is a Subtransaction?</h3><p>As the name suggests, it is a smaller transaction that exists within a regular transaction and it can be created using the <code>SAVEPOINT</code> keyword after your <code>BEGIN</code> statement. Normally, when you have issued a <code>BEGIN</code> statement, all the tuples created from the subsequent DML statements such as <code>INSERT</code> or <code>UPDATE</code> will have a <code>txid</code> associated with these tuples and they will all be the same. </p>
<p>When you issue a <code>SAVEPOINT</code> statement within this transaction, all the tuples created from the subsequent DML statements will have a different <code>txid</code> that is normally larger than the main transaction’s <code>txid</code>. When you issue the <code>SAVEPOINT</code> statement again, the <code>txid</code> changes again. </p>
<p>The advantage of Subtransaction is that in a very large transaction, the entire transaction will not be aborted due to an error. It allows you to rollback to the previously created <code>SAVEPOINT</code> and continue to execute the main transaction. </p>
<p>The biggest difference between a subtransaction and a regular transaction is that there is not a concept of <code>commit</code> associated with subtransactions and it will not be recorded in the WAL file. However, if subtransaction is aborted, it will be recorded in the WAL file and subsequently be sent to the standby.</p>
<h3 id="4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction"><a href="#4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction" class="headerlink" title="4. How Does a Standby Determines Visibility Information In a Regular Transaction?"></a>4. How Does a Standby Determines Visibility Information In a Regular Transaction?</h3><p>Here’s an example of a regular transaction without any subtransactions:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In a general case, the above queries will send at least 4 WAL records to the standby during streaming replication. First 3 contain the actual tuple information with <code>t_xmin</code> set to the current transaction ID which is 500 in the example. In other words, before the <code>COMMIT</code> is issued, the standby should have already received 3 WAL records from primary and completed the redo, meaning that the 3 tuples already exist in standby’s memory buffer. However, they are not visible yet because transaction ID 500 does not exist in the standby. It is until the <code>COMMIT</code> is issued in the primary that will subsequently generate a <code>XLOG_XACT_COMMIT</code> WAL record to be sent to standby to notify that transaction ID 500 is now committed and valid. When standby receives the <code>XLOG_XACT_COMMIT</code> WAL record, it will eventually update to its <code>clog</code> so the subsequent <code>SELECT</code> queries can do visibility check against. </p>
<h3 id="5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions"><a href="#5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions" class="headerlink" title="5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?"></a>5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?</h3><p>Now, let’s use the same example but add some <code>SAVEPOINT</code> to create subtransactions</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>As you can see, after the creation of <code>SAVEPOINT</code>, the tuple’s <code>t_xmin</code> value will be changed and is no longer equal to the current transaction ID, which is 500 in the example. Before the <code>COMMIT</code> is issued, the standby should have received 9 WAL records, 3 having <code>t_xmin</code> = 500, 3 having <code>t_xmin</code> = 501 and 3 having <code>t_xmin</code> = 502. None of them is visible yet in the standby because these transaction IDs do not exist yet. When the primary issues the <code>COMMIT</code> statement, it will generate a <code>XLOG_XACT_COMMIT</code> WAL record and send to standby containing only the current transaction ID 500 without the 501 and 502. </p>
<p>After the commit, the standby is able to see all 9 tuples that are replicated from the primary. Now, you may be asking…. why? How come the standby knows that <code>txid</code> = 501 and 502 are also visible even though the primary never send a <code>XLOG_XACT_COMMIT</code> WAL record to tell the standby that 501 and 502 are also committed. Keep reading to find out.</p>
<p>Using the similar example, if we rollback to one of the SAVEPOINTs, the primary will send a XLOG_XACT_ABORT WAL record to notify the standby a transaction ID has become invalid.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">ROLLBACK TO SAVEPOINT B;  &#x3D;&gt; a XLOG_XACT_ABORT WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In this example, when doing a <code>ROLLBACK</code> to <code>SAVEPOINT</code> B, a XLOG_XACT_ABORT WAL record will be sent to the standby to invalidate that the transaction ID 502 is invalid. So when primary commits, records having <code>txid</code>=502 will not be visible as primary has notified.</p>
<h3 id="6-The-Secret-of-Standby’s-KnownAssignedTransactionIds"><a href="#6-The-Secret-of-Standby’s-KnownAssignedTransactionIds" class="headerlink" title="6. The Secret of Standby’s KnownAssignedTransactionIds"></a>6. The Secret of Standby’s KnownAssignedTransactionIds</h3><p>In addition to handling the XLOG_XACT_COMMIT and XLOG_XACT_ABORT WAL records to determine if a <code>txid</code> is valid or not, it actually manages a global <code>txid</code> list called <code>KnownAssignedTransactionIds</code>. Whenever a standby receives a heap_redo WAL record, it will save its <code>xmin</code> to <code>KnownAssignedTransactionIds</code>. Using the same example as above again here:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby and standby submits 500, 501 and 502 to clog as valid.</span><br></pre></td></tr></table></figure>

<p>Before the <code>COMMIT</code> is issued on the primary, the standby already has <code>txid</code> 500, 501, and 502 present in the <code>KnownAssignedTransactionIds</code>. When the standby receives <code>XLOG_XACT_COMMIT WAL</code>, it will actually submit <code>txid</code> 500 from the WAL plus the 501 and 502 from <code>KnownAssignedTransactionIds</code> to the <code>clog</code>. So that the subsequent <code>SELECT</code> query consult the <code>clog</code> it will say <code>txid</code> 500, 501, and 502 are visible. If the primary sends <code>XLOG_XACT_ABORT</code> as a result of rolling back to a previous <code>SAVEPOINT</code>, that invalid <code>txid</code> will be removed from the <code>KnownAssignedTransactionIds</code>, so when the transaction commits, the invalid <code>txid</code> will not be submit to <code>clog</code>.</p>
<h3 id="7-Summary"><a href="#7-Summary" class="headerlink" title="7. Summary"></a>7. Summary</h3><p>So this is how PostgreSQL determines a tuple’s visibility within subtransactions in a streaming replication setup. Of course, there is more details to what is discussed here in this blog, but I hope today’s discussion can help you get a general understanding of how PostgreSQL determines the visibility and maybe it will help you in your current work on PostgreSQL.</p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/tags/postgresql/page/0/">Previous</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/tags/postgresql/page/2/">Next</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/tags/postgresql/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/postgresql/page/2/">2</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/prof-img.jpg" alt="Cary Huang">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Cary Huang
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Multi-Displined Software Developer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Vancouver</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            34
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            54
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/caryhuang" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/caryhuang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://www.facebook.com/cary.huang.35">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.etsy.com/ca/shop/ShokuninDesignCo" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Etsy Shop</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.etsy.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.highgo.ca/" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">HighGo Software Canada</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.highgo.ca</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Netsnmp/">
            <span class="level-start">
                <span class="level-item">Netsnmp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/PostgreSQL/">
            <span class="level-start">
                <span class="level-item">PostgreSQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">26</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/2021-PG-Asia-Conference/" style="font-size: 12.5px;">2021 PG Asia Conference</a> <a href="/tags/Postgresql/" style="font-size: 17.5px;">Postgresql</a> <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/atomic-commit/" style="font-size: 12.5px;">atomic commit</a> <a href="/tags/backend/" style="font-size: 10px;">backend</a> <a href="/tags/buffer-manager/" style="font-size: 10px;">buffer manager</a> <a href="/tags/copy/" style="font-size: 10px;">copy</a> <a href="/tags/extended-query/" style="font-size: 10px;">extended query</a> <a href="/tags/extension/" style="font-size: 10px;">extension</a> <a href="/tags/external-key-management-system/" style="font-size: 10px;">external key management system</a> <a href="/tags/failover/" style="font-size: 10px;">failover</a> <a href="/tags/fdw/" style="font-size: 12.5px;">fdw</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/in-memory/" style="font-size: 10px;">in-memory</a> <a href="/tags/in-memory-table/" style="font-size: 10px;">in-memory table</a> <a href="/tags/key-management-system/" style="font-size: 10px;">key management system</a> <a href="/tags/libpq/" style="font-size: 10px;">libpq</a> <a href="/tags/logical-decoding/" style="font-size: 10px;">logical decoding</a> <a href="/tags/logical-replication/" style="font-size: 10px;">logical replication</a> <a href="/tags/lsn/" style="font-size: 10px;">lsn</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mvcc/" style="font-size: 10px;">mvcc</a> <a href="/tags/networking/" style="font-size: 17.5px;">networking</a> <a href="/tags/oid/" style="font-size: 10px;">oid</a> <a href="/tags/parallel-worker/" style="font-size: 10px;">parallel worker</a> <a href="/tags/partition/" style="font-size: 10px;">partition</a> <a href="/tags/pg13/" style="font-size: 10px;">pg13</a> <a href="/tags/pg-rewind/" style="font-size: 10px;">pg_rewind</a> <a href="/tags/pitr/" style="font-size: 10px;">pitr</a> <a href="/tags/pluggable-api/" style="font-size: 10px;">pluggable api</a> <a href="/tags/pluggable-storage/" style="font-size: 15px;">pluggable storage</a> <a href="/tags/postgres/" style="font-size: 10px;">postgres</a> <a href="/tags/postgresql/" style="font-size: 20px;">postgresql</a> <a href="/tags/postmaster/" style="font-size: 12.5px;">postmaster</a> <a href="/tags/query-processing/" style="font-size: 10px;">query processing</a> <a href="/tags/recovery/" style="font-size: 12.5px;">recovery</a> <a href="/tags/redo/" style="font-size: 10px;">redo</a> <a href="/tags/replication/" style="font-size: 15px;">replication</a> <a href="/tags/savepoint/" style="font-size: 10px;">savepoint</a> <a href="/tags/security/" style="font-size: 17.5px;">security</a> <a href="/tags/sequence/" style="font-size: 10px;">sequence</a> <a href="/tags/snmp/" style="font-size: 10px;">snmp</a> <a href="/tags/streaming-replication/" style="font-size: 10px;">streaming replication</a> <a href="/tags/subtransaction/" style="font-size: 10px;">subtransaction</a> <a href="/tags/table-access-method/" style="font-size: 12.5px;">table access method</a> <a href="/tags/tde/" style="font-size: 10px;">tde</a> <a href="/tags/timeline-id/" style="font-size: 10px;">timeline id</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/trace/" style="font-size: 10px;">trace</a> <a href="/tags/trigger/" style="font-size: 10px;">trigger</a> <a href="/tags/visibility/" style="font-size: 10px;">visibility</a> <a href="/tags/visibility-check/" style="font-size: 10px;">visibility check</a> <a href="/tags/wal2mongo/" style="font-size: 10px;">wal2mongo</a> <a href="/tags/wire-protocol/" style="font-size: 10px;">wire protocol</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <a href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/copy.png" alt="Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-07-08T16:45:40.000Z">2022-07-08</time></div>
                    <a href="/2022/07/08/Maintain-a-custom-PG-to-PG-Connection-With-libpq-s-COPY-protocol/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Maintain a custom PG to PG Connection With libpq&#39;s COPY protocol</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/visicheck.png" alt="Understand PG&#39;s MVCC Visibility Check Rules">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-06-10T18:13:40.000Z">2022-06-10</time></div>
                    <a href="/2022/06/10/Understand-PG-s-MVCC-Visibility-Check-Rules/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Understand PG&#39;s MVCC Visibility Check Rules</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/2pc2.png" alt="Atomic Commit with 2 Phase Commit in FDW Distributed Setup">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-05-06T18:51:12.000Z">2022-05-06</time></div>
                    <a href="/2022/05/06/Ensure-Atomic-Commit-with-2-Phase-Commit-in-FDW-Distributed-Setup/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Atomic Commit with 2 Phase Commit in FDW Distributed Setup</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/2pc.png" alt="Distributed Database With PostgreSQL - Atomic Commit Problems">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-03-18T20:26:14.000Z">2022-03-18</time></div>
                    <a href="/2022/03/18/Distributed-Database-With-PostgreSQL-Atomic-Commit-Problems/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Distributed Database With PostgreSQL - Atomic Commit Problems</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2022/02/18/The-significance-of-LSN-in-PostgreSQL-System/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/lsn.png" alt="The significance of LSN in PostgreSQL System">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-02-18T19:41:06.000Z">2022-02-18</time></div>
                    <a href="/2022/02/18/The-significance-of-LSN-in-PostgreSQL-System/" class="title has-link-black-ter is-size-6 has-text-weight-normal">The significance of LSN in PostgreSQL System</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2022/07/">
                <span class="level-start">
                    <span class="level-item">July 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/06/">
                <span class="level-start">
                    <span class="level-item">June 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/05/">
                <span class="level-start">
                    <span class="level-item">May 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/03/">
                <span class="level-start">
                    <span class="level-item">March 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/02/">
                <span class="level-start">
                    <span class="level-item">February 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2022/01/">
                <span class="level-start">
                    <span class="level-item">January 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/12/">
                <span class="level-start">
                    <span class="level-item">December 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/10/">
                <span class="level-start">
                    <span class="level-item">October 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">September 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/08/">
                <span class="level-start">
                    <span class="level-item">August 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/07/">
                <span class="level-start">
                    <span class="level-item">July 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">March 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/02/">
                <span class="level-start">
                    <span class="level-item">February 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">January 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">November 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">September 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">August 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">July 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">June 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">May 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">April 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">March 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">January 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">October 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">September 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">July 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/2021-PG-Asia-Conference/">
                        <span class="tag">2021 PG Asia Conference</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Postgresql/">
                        <span class="tag">Postgresql</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/architecture/">
                        <span class="tag">architecture</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/atomic-commit/">
                        <span class="tag">atomic commit</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/backend/">
                        <span class="tag">backend</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/buffer-manager/">
                        <span class="tag">buffer manager</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/copy/">
                        <span class="tag">copy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extended-query/">
                        <span class="tag">extended query</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extension/">
                        <span class="tag">extension</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/external-key-management-system/">
                        <span class="tag">external key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/failover/">
                        <span class="tag">failover</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/fdw/">
                        <span class="tag">fdw</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/gdb/">
                        <span class="tag">gdb</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory/">
                        <span class="tag">in-memory</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory-table/">
                        <span class="tag">in-memory table</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/key-management-system/">
                        <span class="tag">key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/libpq/">
                        <span class="tag">libpq</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-decoding/">
                        <span class="tag">logical decoding</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-replication/">
                        <span class="tag">logical replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/lsn/">
                        <span class="tag">lsn</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mongodb/">
                        <span class="tag">mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mvcc/">
                        <span class="tag">mvcc</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/networking/">
                        <span class="tag">networking</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/oid/">
                        <span class="tag">oid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/parallel-worker/">
                        <span class="tag">parallel worker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/partition/">
                        <span class="tag">partition</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg13/">
                        <span class="tag">pg13</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg-rewind/">
                        <span class="tag">pg_rewind</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pitr/">
                        <span class="tag">pitr</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-api/">
                        <span class="tag">pluggable api</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-storage/">
                        <span class="tag">pluggable storage</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgres/">
                        <span class="tag">postgres</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgresql/">
                        <span class="tag">postgresql</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postmaster/">
                        <span class="tag">postmaster</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/query-processing/">
                        <span class="tag">query processing</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/recovery/">
                        <span class="tag">recovery</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/redo/">
                        <span class="tag">redo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/replication/">
                        <span class="tag">replication</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/savepoint/">
                        <span class="tag">savepoint</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/security/">
                        <span class="tag">security</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sequence/">
                        <span class="tag">sequence</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/snmp/">
                        <span class="tag">snmp</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/streaming-replication/">
                        <span class="tag">streaming replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/subtransaction/">
                        <span class="tag">subtransaction</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/table-access-method/">
                        <span class="tag">table access method</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tde/">
                        <span class="tag">tde</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/timeline-id/">
                        <span class="tag">timeline id</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tls/">
                        <span class="tag">tls</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trace/">
                        <span class="tag">trace</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trigger/">
                        <span class="tag">trigger</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility/">
                        <span class="tag">visibility</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility-check/">
                        <span class="tag">visibility check</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wal2mongo/">
                        <span class="tag">wal2mongo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wire-protocol/">
                        <span class="tag">wire protocol</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2022 Cary Huang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://caryhuang.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>