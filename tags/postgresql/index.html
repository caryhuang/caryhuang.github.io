<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Tag: postgresql - Cary&#39;s Blog</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="Cary&#39;s Blog">
<meta property="og:url" content="http://caryhuang.github.io/tags/postgresql/index.html">
<meta property="og:site_name" content="Cary&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://caryhuang.github.io/images/og_image.png">
<meta property="article:author" content="Cary Huang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://caryhuang.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Cary's Blog" type="application/atom+xml">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
                <a class="navbar-item"
                href="/about/me.html">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">Tags</a></li>
            <li class="is-active"><a href="#" aria-current="page">postgresql</a></li>
        </ul>
        </nav>
    </div>
</div>

    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2022-01-18T20:57:59.000Z">2022-01-18</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 minutes read (About 1863 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2022/01/18/2021-PG-Asia-Conferenece-Delivered-Another-Successful-Online-Conference-Again/">2021 PG Asia Conference Delivered Another Successful Online Conference Again!</a>
            
        </h1>
        <div class="content">
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>On December 14-17, 2021, PostgresConf.CN &amp; PGconf.Asia2021 (referred to as 2021 PG Asia Conference) was held online successfully and once again listed as a global gold standard conference on Postgresql.org! This conference was jointly organized by the PG China Open Source Software Promotion Alliance, PostgresConf International Conference Organization, PGConf.Asia Asian Community and PG user community groups from the world including:</p>
<ul>
<li>Japan PG User Group</li>
<li>Korea PG User Group</li>
<li>Russia PG User Group</li>
<li>Europe PG User Group</li>
<li>Philippine PG User Group</li>
<li>Pakistan PG User Group</li>
<li>Thailand PG User Group</li>
<li>Vietnam PG User Group</li>
</ul>
<h2 id="About-the-Conference"><a href="#About-the-Conference" class="headerlink" title="About the Conference"></a>About the Conference</h2><p>Also known as the Asia’s largest open source relational database ecology conference</p>
<p>PostgresConf.CN and PGConf.Asia were hosted together as one conference online for the first time back in 2020. In 2021, both conferences joined forces again to deliver another successful conference that attracted record high numbers of PG enthusiasts from the world! </p>
<p>PostgresConf.CN is an annual conference held by the China PostgreSQL Association for PostgreSQL users and developers. It is also one of the conference series held by PostgresConf Organization. PostgreConf.CN 2019 took place in Beijing, it was very well attended by PostgreSQL users and community members across the globe.</p>
<p>PGCONF.Asia is also an annual PostgreSQL event that took place in Bali Indonesia in 2019, it was a continuation of the PGCONF.Asia event that took place in Tokyo, Japan in 2018. The first PGCONG.Asia conference took place in 2016 in Tokyo, this conference acts as a hub of PostgreSQL related development and technical discussion among PostgreSQL users and developers in the region as well as experts from around the globe.</p>
<p>Learn more about these conferences and the organizers from these resources:</p>
<ul>
<li><a href="https://2021.postgresconf.cn/en">2021.postgresconf.cn</a></li>
<li><a href="https://pgconf.asia/EN/">2021.pgconf.asia</a></li>
<li><a href="https://www.postgresconf.org">PostgresConf</a></li>
</ul>
<h2 id="Sponsors"><a href="#Sponsors" class="headerlink" title="Sponsors"></a>Sponsors</h2><p>This conference was sponsored by:</p>
<p><strong>Platinum</strong>:</p>
<ul>
<li><a href="https://cloud.tencent.com/">Tencent Cloud</a></li>
<li><a href="https://aws.amazon.com/">AWS</a></li>
<li><a href="https://www.highgo.com/">HighGo Database</a></li>
</ul>
<p><strong>Golden</strong>:</p>
<ul>
<li><a href="https://es.inspur.com/">Inspur Commercial Systems</a></li>
<li><a href="https://azure.microsoft.com/">Microsoft Azure</a></li>
</ul>
<p><strong>Silver</strong>:</p>
<ul>
<li><a href="https://www.ibm.com/">IBM</a></li>
<li><a href="https://www.kylinos.cn/">Kylin Software</a></li>
<li><a href="https://equnix.asia/">Equnix</a></li>
</ul>
<h2 id="14-Conference-Channels-over-4-Days"><a href="#14-Conference-Channels-over-4-Days" class="headerlink" title="14 Conference Channels over 4 Days!"></a>14 Conference Channels over 4 Days!</h2><p>This conference was broadcast live with a record-high number of viewers streaming the conference events. It consists of a total of 14 live channels delivering speeches in Mandarin Chinese, English, Korean and Indonesian languages. </p>
<p>the conference gathered 101 technical presentations and more than 100 well-known experts and scholars around the world to provide a grand technical feast for all the participating PG enthusiasts.</p>
<ul>
<li>Guangnam Ni, Fellow of the Chinese Academy of Engineering</li>
<li>Peng Liu, Vice chairman of China Open Source Software Promotion Alliance and researcher of the Chinese Academy of Sciences</li>
<li>Xing Chunxiao, deputy director of the Information System Committee of the China Computer Federation</li>
<li>Bruce Momjian, co-founder of PostgreSQL international community and vice president of EDB</li>
<li>Peter Zaitsev, Founder and CEO of Percona</li>
<li>Ding Zhiming, Director of the Spatiotemporal Data Science Research Center of the Chinese Academy of Sciences</li>
<li>Experts from from HighGo, Alibaba, Tencent, Amazon, Kylin, Inspur, Ping An, Meichuang, SphereEx, Inspur Yunxi database, VMware Greenplum, Huawei, Ali cloud, ZTE…etc</li>
<li>Professors from Peking University, Tsinghua University, Institute of Information Technology, Chinese Academy of Sciences, Shenzhen University, Zhengzhou University, Shandong Normal University, Suzhou University of Science and Technology and other academic and scientific research institutions</li>
<li>And many, many more!</li>
</ul>
<p>With the great support from these PostgreSQL communities, the conference was held with great success, which brought together the Chinese PG power, major Asian PG contributors and many PostgreSQL experts worldwide to build the largest PG ecosystem in Asia.</p>
<h2 id="Conference-Highlights"><a href="#Conference-Highlights" class="headerlink" title="Conference Highlights"></a>Conference Highlights</h2><h3 id="Opening-Speech-by-Fellow-Guangnam-Ni"><a href="#Opening-Speech-by-Fellow-Guangnam-Ni" class="headerlink" title="Opening Speech by Fellow Guangnam Ni"></a>Opening Speech by Fellow Guangnam Ni</h3><p><img src="/images/ni-2021.webp" alt="Guangnam Ni"></p>
<p>Guangnan Ni first expressed his warm congratulations to the holding of the PGConf.Asia 2021 Asia Conference, and greeted sincerely to the representatives of various countries and open source experts participating in the conference. He pointed out that open source is an important trend in the development of today’s world, and open source technology is profoundly changing the global digital economy and information industry pattern. The holding of this PG Asia Conference is of great significance to the development of the open source industry, the promotion of the open source movement and the popularization of open source culture in China, and the strengthening of international exchanges and cooperation.</p>
<h3 id="Bruce-Momjian"><a href="#Bruce-Momjian" class="headerlink" title="Bruce Momjian"></a>Bruce Momjian</h3><p><img src="/images/bruce-2021.webp" alt="Bruce Momjian"></p>
<p>Bruce mojian, as a core group member of the PG international community, has always been keen on sharing themes in the community. This time Bruce made a sharing based on the status quo of PG, project development challenges, competition challenges, and technical challenges, mainly emphasizing that the development process of the PG version has been adapting. Changes in the environment, continuous breakthroughs and innovations, such as SSD optimization, virtualization, containerization, and functional expansion of cloud environments have been completed in the face of technical challenges. For the future evolution of the PG version, it will continue to optimize and iterate on several aspects such as PG write amplification, TDE encryption, and horizontal scalability.</p>
<h3 id="Peter-Zaitsev"><a href="#Peter-Zaitsev" class="headerlink" title="Peter Zaitsev"></a>Peter Zaitsev</h3><p><img src="/images/peter-2021.webp" alt="Peter Zaitsev"><br>Mr. Peter Zaitsev, CEO of Percona, has been a guest at the PG Asia Conference for the second time. This time Peter brought us a speech of &lt;<State of Open Source Databases>&gt;, mainly from cloud computing, PG peripheral ecology, DaaS and K8S. This aspect expresses the openness and flexibility of PG, which enables PG and the evolution of the technical architecture to be better integrated, promote mutual development, and meet the needs of different business scenarios. He said that Percona, which has been engaged in open source database services for many years, loves to embrace PG and make innovations based on PG to bring more value to customers.</p>
<h3 id="Chunxiao-Xing"><a href="#Chunxiao-Xing" class="headerlink" title="Chunxiao Xing"></a>Chunxiao Xing</h3><p><img src="/images/xing-2021.webp" alt="Chunxiao Xing"><br>Professor Xing Chunxiao, deputy dean of the Institute of Information Technology of Tsinghua University and deputy director of the Information System Committee of the China Computer Federation, shared with us the most popular topics of “metaverse”, blockchain, and data lake, emphasizing that data management is a popular technology development Only the continuous evolution and iteration of database management software can better provide support for cutting-edge technologies and make our lives more meaningful.</p>
<h3 id="Zhiming-Ding"><a href="#Zhiming-Ding" class="headerlink" title="Zhiming Ding"></a>Zhiming Ding</h3><p><img src="/images/ivorysql-2021.webp" alt="Zhiming Ding"><br>The ivorySQL project is a PG open source derivative project with a broad ecological foundation and Chinese characteristics. Its purpose is to develop community collaboration among Chinese developers and allow engineers to create greater personal and social value.</p>
<p>The session was presented by Professor Ding Zhiming, an early promoter of research practice in the domestic PG field, the new president of the China PG branch, and director of the Center for Space-Time Data Science (STDMS) of the Chinese Academy of Sciences. Their system completely expounds the necessity and realization idea of “PostgreSQL database software + Chinese characteristics”, the positioning, characteristics and operation mode of the ivorySQL project and community. Through the launch event, the project was officially known to the majority of PG practitioners in China.</p>
<p>The launch of IvorySQL attracted many domestic PG enthusiasts, and they have provided suggestions and opinions to make the project better. We feel very thankful fro their effort into this new project. In the mean time, please check out the project’s official website at <a href="http://www.ivorysql.org">www.ivorysql.org</a> for the latest developments.</p>
<h3 id="Xiaojun-Zheng"><a href="#Xiaojun-Zheng" class="headerlink" title="Xiaojun Zheng"></a>Xiaojun Zheng</h3><p><img src="/images/zheng-2021.webp" alt="Xiaojun Zheng"><br>Xiaojun Zheng, Chief Scientist of HighGo, presented &lt;<Highgo peer-to-peer service cluster database>&gt;.</p>
<p>Mr. Zheng first gave a systematic overview of the definition of database cluster, and then explained the concept and implementation of “peer-to-peer service cluster” in a more generalized manner. Finally, Mr. Zheng led everyone to experience Higao’s Peer-to-peer service cluster database environment. Through this practical demonstration, we have brought you a new idea and method for realizing peer-to-peer service clustering. Architects and product managers who pay attention to the PostgreSQL database, I believe they can gain new product inspiration from it.</p>
<h3 id="Jian-Feng"><a href="#Jian-Feng" class="headerlink" title="Jian Feng"></a>Jian Feng</h3><p><img src="/images/jian-2021.webp" alt="Jian Feng"><br>Director Feng first introduced the two major product lines of K1 Power and their respective market opportunities, advantages, and application scenarios. He then demonstrated the business value of K1 Power’s advanced virtualization features to PostgreSQL database in four aspects, and elaborated on running under K1 Power Linux. The best practices of the PostgreSQL database and the uniqueness of the x86 CPU. Finally, Director Feng introduced the PowerFans community on Github <a href="https://github.com/powerfans/">https://github.com/powerfans/</a>. This PowerFan community can be said to be the king of technical feasts. In addition to providing the above best practices, it also provides open-source software binary packages, useful tools and documentation, etc. This PowerFans community provides database enthusiasts with great convenience to use the Power server platform, such as: PostgreSQL under the PowerLinux platform and you no longer need to make RPM packages yourself, Inspur commercial machines are ready for you!</p>
<h3 id="Grant-Zhou-The-Launch-of-IvorySQL-Open-Source-Project"><a href="#Grant-Zhou-The-Launch-of-IvorySQL-Open-Source-Project" class="headerlink" title="Grant Zhou - The Launch of IvorySQL Open Source Project"></a>Grant Zhou - The Launch of IvorySQL Open Source Project</h3><p><img src="/images/ivorysql2-2021.webp" alt="ivorysql"><br>This conference specially invited the well-known domestic database solution supplier, HighGo Database, to jointly organize and launch the HighGo database sub-forum. Jichao Ma, the pre-sales director of HighGo Software, presented &lt;<Highgo Database New Features>&gt;, and introduced some new features and functions of HighGo Database related to high availability.</p>
<p>Grant Zhou, head of the IvorySQL open source community presented &lt;<IvorySQL-an Oracle compatible open source PostgreSQL database>&gt;, and introduced an Oracle-compatible open source PostgreSQL database ivorySQL. </p>
<h3 id="Seoul-Sub-Forum"><a href="#Seoul-Sub-Forum" class="headerlink" title="Seoul Sub-Forum"></a>Seoul Sub-Forum</h3><p><img src="/images/seoul-2021.webp" alt="seoul sub forum"></p>
<p>In the Seoul sub-forum, four Korean PostgreSQL user group members gave speeches, namely Ioseph Kim, Jaegeun Yu, Daniel Lee, and Lee Jiho.</p>
<p>Ioseph Kim is a contributor to PostgreSQL11 and PostgreSQL12 and translated the PostgreSQL Korean documentation. The topic of his speech was &lt;<Peculiar SQL with PostgreSQL for application developer>&gt;. In this speech, Loseph Kim talked about the syntax of PostgreSQL’s Lateral Joins, distinct on… etc. He also introduced the new features of PostgreSQL14.</p>
<p>Jaegeun Yu has more than 3 years of experience as a PostgreSQL DBA. The topic of his speech is &lt;<Porting from Oracle UDF and Optimization>&gt;. In this speech, Jaegeun Yu talks about the basic principles of function optimization and shows how to write PostgreSQL functions efficiently while porting, and illustrate the migration process with examples.</p>
<p>Daniel Lee brought you a speech &lt;<Citus high-availability environment deployment based on Patroni>&gt;. In this speech, Daniel Lee introduced the high availability technology solution of Citus, and actually demonstrated the steps to build a Citus HA environment based on Patroni.</p>
<p>Lee Jiho is the head of the department at insignal in Korea, and has more than 20 years of experience in using PostgreSQL. Lee Jiho brought a speech &lt;<Database configuration and migration and index clustering around clusters in PostgreSQL>&gt;. In this speech, Lee Jiho introduced the changes and upgrades of Cluster, table clustering … etc.</p>
<h3 id="Jakarta-Sub-Forum"><a href="#Jakarta-Sub-Forum" class="headerlink" title="Jakarta Sub-Forum"></a>Jakarta Sub-Forum</h3><p><img src="/images/equnix-2021.webp" alt="jakarta sub forum"></p>
<p>In Jakarta sub-forum, CEO-Julyanto Sutandang and CTO-Lucky Haryadi from Equnix Business Solutions brought 3 speeches in Indonesian.</p>
<p>Equunix Business Solutions’ CEO-Julyanto Sutandang brought 2 speeches on &lt;<Active active PostgreSQL Do We Really Need It>&gt; and &lt;&lt;In-memory Database, Is It Really Faster?&gt;&gt;, Equunix Business Solutions CTO-Lucky Haryadi’s speech topic is &lt;<Does HA Can Help You Balance Your Load>&gt;. As a technology company with strong influence in the field of PostgreSQL and Linux in Southeast Asia, the speech brought by Equnix Business Solutions is a perfect combination of practice and theory.</p>
<p>The successful landing of this Jakarta sub-forum has greatly promoted the dissemination and development of PostgreSQL database technology in Indonesia and even Southeast Asia.</p>
<h2 id="Special-Thanks-To"><a href="#Special-Thanks-To" class="headerlink" title="Special Thanks To"></a>Special Thanks To</h2><p><img src="/images/special-thanks-2021.webp" alt="special thanks"></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/12/10/A-Look-Inside-PostgreSQL-s-Extended-Query-Protocol/" class="image is-7by1">
            <img class="thumbnail" src="/images/extended.png" alt="A Look Inside PostgreSQL&#39;s Extended Query Protocol">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-12-10T19:34:58.000Z">2021-12-10</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 983 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/12/10/A-Look-Inside-PostgreSQL-s-Extended-Query-Protocol/">A Look Inside PostgreSQL&#39;s Extended Query Protocol</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>Few weeks ago, I was tasked to have a detailed look inside PostgreSQL’s extended query protocol and study its internal mechanisms for a project that depends on this particular feature. In this blog, I will explain how extended protocol works in my own words and how it differs from simple query.</p>
<h3 id="2-Simple-Query"><a href="#2-Simple-Query" class="headerlink" title="2. Simple Query"></a>2. Simple Query</h3><p>A client is able to initiate 2 type of queries against a PostgreSQL server, simple query or extended query. Simple query, as the name suggests, is very simple and straightforward to understand. When we launch the <code>psql</code> client tool to connect to a PostgreSQLs server, almost all of the SQL commands sent are considered as simple queries. This includes the use of <code>begin</code> and <code>commit</code> to enclose a transaction, having multiple SQL queries included in one big query separated by a semicolon, executing or defining a function and much more. </p>
<p>Simple query automatically follows the standard query processing routines, which consist of these stages:</p>
<ul>
<li>Parser</li>
<li>Analyzer</li>
<li>Rewriter</li>
<li>Planner</li>
<li>Executor</li>
</ul>
<p>Refer to this blog <a href="https://www.highgo.ca/2019/10/03/trace-query-processing-internals-with-debugger/">here</a> for detailed information about query processing.</p>
<p>The communication between the client and the server is also very straightforward. In case of DML operations such as INSERT, the client sends the query to the server for processing and the server responds a <code>CommandComplete</code> message such as <code>INSERT 0 1</code> followed by a <code>ReadyForQuery(IDLE)</code> message to indicate that the server has finished the query and is now idle. The client can send another query and it follows the same patter. </p>
<p>In case of a <code>SELECT</code> query, the server will send the row description followed by the actual row data satisfying the query until there is no more rows to return. In the end, the server sends a <code>ReadyForQuery(IDLE)</code> message to indicate that the server has finished the query and is now idle.</p>
<h3 id="3-Extended-Query"><a href="#3-Extended-Query" class="headerlink" title="3. Extended Query"></a>3. Extended Query</h3><p>Extended query is the other way for the client to complete a query excepts that it breaks down the standard query processing into different steps and <code>the client</code> is responsible to ensure these steps are followed and executed correctly. The client is able to control thses steps by sending the following wire protocol message types:</p>
<ul>
<li><p>‘P’ message (Parse)</p>
<ul>
<li><code>P</code> message takes a generalize query string with data values repalced with placeholders like <code>$1</code>, <code>$2</code>, which can be later substitued with real values in the Bind step.</li>
<li>This generalized query string will be parsed via these query processing routines: <code>Parser</code> -&gt; <code>Analyzer</code> -&gt; <code>Rewriter</code></li>
<li>At the end of a successful Parse, a <code>prepared statement</code> is produced, similar to SQL’s <code>PREPARE</code> clause</li>
<li>This <code>prepared statement</code> can be <code>named</code> or <code>unnammed</code> (more on this next).</li>
<li>This <code>prepared statement</code> is just a representation of the input query and it cannot be executed yet. </li>
</ul>
</li>
<li><p>‘B’ message (Bind)</p>
<ul>
<li><code>B</code> takes the <code>named</code> or <code>unnammed</code> <code>prepared statement</code> produced from the <code>P</code> message and replaces the placeholders ($1, $2) with the user-supplied values.</li>
<li>After the values are bound to the <code>prepared statement</code>, we basically have a completed query and it will then be fed into the <code>planner</code> stage to produce the most optimized query plan for the query.</li>
<li>At the end of a successful planning, a <code>portal</code> is produced. </li>
<li>This <code>portal</code> can also be <code>named</code> or <code>unnammed</code> (more on this next)</li>
<li>A portal is basically an object that represents how to execute a particular query</li>
</ul>
</li>
<li><p>‘E’ message (Execute)</p>
<ul>
<li><code>E</code> takes the <code>named</code> or <code>unnamed</code> <code>portal</code> produced from the <code>B</code> message and actuallly launch the <code>executor</code> to execute the query (or portal).</li>
<li>resultant rows are produced (if any) and returns to the client</li>
</ul>
</li>
<li><p>‘S’ message (Sync)</p>
<ul>
<li>The client has to send a <code>S</code> message to the server to indicate the end of the extended query. </li>
<li>This message causes the server to end the current transaction and sends <code>ReadyForQuery(IDLE)</code> message back to client.</li>
</ul>
</li>
</ul>
<p>What is the purpose of separating a simple query into multiple steps? One major benefit of using the extended query is that it can save a lot of unnecessary parsing of the same query structure. Instead, we can have the common strucuture parsed only once and then bind and execute with different values multiple times.</p>
<h3 id="4-Named-and-Unnamed-Prepared-Statement-and-Portal"><a href="#4-Named-and-Unnamed-Prepared-Statement-and-Portal" class="headerlink" title="4. Named and Unnamed Prepared Statement and Portal"></a>4. Named and Unnamed Prepared Statement and Portal</h3><p>In previous section we mentioned that a prepared statement and protal can be either <code>named</code> or <code>unnamed</code> during the extended query protocol. What does it mean and what is the significance? </p>
<p>The general rule is that PostgreSQL server can only keep one unnamed prepared statement or portal. Requests containing unnamed prepared statemnt or portal will replace the existing ones. </p>
<p>With named prepared statement or portal, the server will respectively remember them based on the names given and client is able to invoke them any time or specifically destroyed by sending a Close message. </p>
<p>So, it is possible for a client to create multiple prepared statements within a transaction, each having different prepared statement names, and then bind values for them all at the same time by giving them different portal names. Eventually, the client chooses which portal to be executed.</p>
<p>More importantly, named prepared statement’s life time lasts for the entire TCP session unless explicitly destroyed; named portal lasts only until the end of transaction or when it is executed or explicitly destroyed.</p>
<p>But, does it make client implementation more complicated if extended query is used?</p>
<p>Yes, but client has a choice to complicate things or not</p>
<p>Taking libpq for example, when extended query is used, it requires the client application to provide a prepared statement name to construct the <code>P</code> (Parse) message, but does not require the client application to provide portal name to construct the <code>B</code> (Bind) message. This means that with libpq, we can send <code>P</code> message multiple times with different prepared statement names, but with <code>B</code> message, it forces to use unnamed portal name, so we always have one portal to execute. This avoids the case with multiple portal names in the client side to manage. </p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/10/29/The-PostgreSQL-Timeline-Concept/" class="image is-7by1">
            <img class="thumbnail" src="/images/timeline.png" alt="The PostgreSQL Timeline Concept">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-29T16:46:01.000Z">2021-10-29</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 659 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/29/The-PostgreSQL-Timeline-Concept/">The PostgreSQL Timeline Concept</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>In my previous blog <a href="https://www.highgo.ca/2021/10/01/postgresql-14-continuous-archiving-and-point-in-time-recovery/">here</a>, I discussed about PostgreSQL’s point in time recovery where PostgreSQL supports an ability to recover your database to a specific time, recovery point or transaction ID in the past but I did not discuss in detail the concept of <code>timeline id</code>, which is also important in database recovery.</p>
<h3 id="2-What-is-timeline-ID-and-Why-it-is-important"><a href="#2-What-is-timeline-ID-and-Why-it-is-important" class="headerlink" title="2. What is timeline ID and Why it is important?"></a>2. What is timeline ID and Why it is important?</h3><p>A timeline ID is basically a point of divergence in WAL. It represents a point, of to be exact, the LSN of the WAL in which the database starts to diverge. Divergence happens when an user performs a point in time recovery or when the standby server is promoted. The timeline ID is included in the first 8 bytes of WAL segment files under pg_wal/ directory.</p>
<p>For example:<br>pg_wal/000000010000000000000001, indicates that this WAL segment belongs to timeline ID = 1</p>
<p>and</p>
<p>pg_wal/000000020000000000000001, indicates that this WAL segment belongs to timeline ID = 2</p>
<p>Timeline ID behaves somewhat like <code>git branch</code> function without the ability to move forward in parallel and to merge back to the master branch. Your development starts from a <code>master branch</code>, and you are able to create a new branch (A) from the master branch to continue a specific feature development. Let’s say the feature also involves several implementation approaches and you are able to create additional branches (B, C and D) to implement each approach.</p>
<p>This is a simple illustration of git branch:</p>
<p><img src="/images/timeline-gitbranch.drawio.png" alt=""></p>
<p>With timeline ID, your database starts from timeline ID 1 and it will stay at 1 for all subsequent database operations. Timeline ID 2 will be created when the user performs a point in time recovery on timeline 1 and all of the subsequnt database operations at this point belong to timeline ID 2. While at 2, the user could perform more PITR to create timeline 3, 4 and 5 respectively. </p>
<p>In the previous PITR blog, I mentioned that you could do PITR based on time, a recovery point, a LSN or a transaction ID but all these can only apply to one particular timeline. In postgresql.conf, you can select a desired recovery timeline by the <code>recovery_target_timeline</code> parameter. This parameter can be <code>&#39;latest&#39;</code>, <code>&#39;current&#39;</code>, or <code>&#39;a particular timeline ID value&#39;</code>. </p>
<p>With this configuration, an user is able to recovery the database to a particular point of a particular timeline in the past </p>
<p>This is a simple illustration of timeline ID:</p>
<p><img src="/images/timeline.drawio.png" alt=""></p>
<h3 id="3-The-History-File-Associated-with-a-Timeline-ID"><a href="#3-The-History-File-Associated-with-a-Timeline-ID" class="headerlink" title="3. The History File Associated with a Timeline ID"></a>3. The History File Associated with a Timeline ID</h3><p>The history files are created under pg_wal/ directory with a <code>.history</code> postfix when a new timeline Id is created. This file describes all the past divergence points that have to be replayed in order to reach the current timeline. Without this file, it is impossible to tell where a timeline comes from, thus not being able to do PITR.</p>
<p>For example, a history file <code>00000003.history</code> may contain the following contents</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat pg_wal&#x2F;00000003.history</span><br><span class="line">1       0&#x2F;30000D8       no recovery target specified</span><br><span class="line"></span><br><span class="line">2       0&#x2F;3002B08       no recovery target specified</span><br></pre></td></tr></table></figure>

<p>which means that timeline 3 comes from LSN(0/3002B08) of timeline 2, which comes from LSN(0/30000D8) of timeline 1. </p>
<h3 id="4-Importance-of-Continuous-Archiving"><a href="#4-Importance-of-Continuous-Archiving" class="headerlink" title="4. Importance of Continuous Archiving"></a>4. Importance of Continuous Archiving</h3><p>With the concept of timeline ID, it is possible that the same LSN or the same WAL segments exist in multiple timelines. </p>
<p>For example: the WAL segments, 3, 4, 5, 6 exist in both timeline 1 and timeline 2 but with different contents. Since the current timeline is 2, so the ones in timeline 2 will continue to grow forward. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">000000010000000000000001</span><br><span class="line">000000010000000000000002</span><br><span class="line">000000010000000000000003</span><br><span class="line">000000010000000000000004</span><br><span class="line">000000010000000000000005</span><br><span class="line">000000010000000000000006</span><br><span class="line">000000020000000000000003</span><br><span class="line">000000020000000000000004</span><br><span class="line">000000020000000000000005</span><br><span class="line">000000020000000000000006</span><br><span class="line">000000020000000000000007</span><br><span class="line">000000020000000000000008</span><br></pre></td></tr></table></figure>

<p>With more timelines created, the number of WAL segments files may also increase. Sine PG keeps a certain amount of WAL segment files before deleting them, it is super important to archive all the WAL segments to a separate location either by enabling continuous archiving function or using pg_receivewal tool. With all WAL segment files archived in a separate location, the user is able to perform successful point in time recovery to any timeline and any LSN.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/10/25/PostgresConf-CN-and-PGConf-Asia-2021-China-Branch-Join-Forces-Again-to-Bring-You-the-Best/" class="image is-7by1">
            <img class="thumbnail" src="/images/title-conference-en.jpg" alt="PostgresConf.CN and PGConf.Asia 2021 (China Branch) Join Forces Again to Bring You the Best!">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-25T17:25:12.000Z">2021-10-25</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 544 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/25/PostgresConf-CN-and-PGConf-Asia-2021-China-Branch-Join-Forces-Again-to-Bring-You-the-Best/">PostgresConf.CN and PGConf.Asia 2021 (China Branch) Join Forces Again to Bring You the Best!</a>
            
        </h1>
        <div class="content">
            <p><img src="/images/top-graph-subpage.jpg" alt=""></p>
<h3 id="About-the-Event"><a href="#About-the-Event" class="headerlink" title="About the Event"></a>About the Event</h3><p>In November, 2020, PostgresConf.CN and PGconf.Asia2020 cooperatively organized <code>2020 PG Asia Conference</code> online for the very first time! This conference attracted over 100 participating experts, scholars and speakers around the world to deliver a grand technical feast for all the participants. The event was broadcast exclusively via the Modb Technology Community platform in China with a record-high number of viewers streaming the conference channels. Each channel on average accumulated over 30,000+ active LIVE streams, the official conference blog views accumulated over 50,000+ views, and the news reports and articles from media exceeded over 3,000+ entries.</p>
<p>This year, both PostgresConf.CN and PGConf.Asia 2021 (China Branch) will join forces again to bring you the best PostgreSQL conference in Asia!</p>
<p><a href="https://2021.postgresconf.cn/en">Official Event Website - 2021</a></p>
<h3 id="Time-and-Rough-Agenda"><a href="#Time-and-Rough-Agenda" class="headerlink" title="Time and Rough Agenda"></a>Time and Rough Agenda</h3><p>The 2021 PG Asia Conference will be a 4-day event from December 14 to 17, 2021.</p>
<p>Rough schedule is as below. Please note that the final schedule is subject to the date of the meeting. The agenda time is Beijing Time(GMT+8)</p>
<ul>
<li>December 14 - Day 1<ul>
<li>09:00-18:00    Main Conference</li>
</ul>
</li>
<li>December 15 - Day 2<ul>
<li>09:00-17:00    Mandarin sub-Comprehensive forum</li>
<li>09:00-17:00    Indonesia sub</li>
<li>09:00-17:00    Korean Sub</li>
<li>09:00-17:00    English sub</li>
<li>09:00-12:00    Special Training A</li>
<li>14:00-16:30    Special Training B</li>
</ul>
</li>
<li>December 16 - Day 3<ul>
<li>09:00-17:00    Mandarin sub-Application Forum</li>
<li>09:00-17:00    Japanese Sub</li>
<li>09:00-17:00    Thai Sub</li>
<li>09:00-12:00    Special Training C</li>
<li>10:00-11:30    Developer Unconference</li>
<li>14:00-16:30    Special Training D</li>
</ul>
</li>
<li>December 17 - Day 4<ul>
<li>09:00-12:00    Special Training E</li>
<li>14:00-16:30    Special Training F</li>
</ul>
</li>
</ul>
<h3 id="About-PostgresConf-CN"><a href="#About-PostgresConf-CN" class="headerlink" title="About PostgresConf.CN"></a>About PostgresConf.CN</h3><p>PostgresConf.CN is an annual event held by the China PostgreSQL Association for PostgreSQL users and developers, PostgreSQL is a leading open-source relational database with an active and vibrant community. PostgreConf.CN 2020 took place as an online conference for the very first time; it was very well attended by PostgreSQL users and community members across the globe. It is also one of the conference series held by PostgresConf Organization.</p>
<p><a href="https://2020.postgresconf.cn/en">Official Event Website - 2020</a></p>
<h3 id="About-PGConf-Asia"><a href="#About-PGConf-Asia" class="headerlink" title="About PGConf.Asia"></a>About PGConf.Asia</h3><p>PGCONF.Asia is a shorthand of the Asian PostgreSQL Conference which has been hosted in Tokyo from 2016 until 2018. The conference was held in Bali for the first time in Sep 2019 and it is intended as the Asian level of PostgreSQL International Conference. It co-hosted the 2020 PG Asia Conference together with PostgresConf.CN as an online event and accumulated unprecedented number of participants worldwide. The organization is often regarded as the HUB and the Summit of the PostgreSQL Community throughout Asian Countries.</p>
<h3 id="Call-for-Paper"><a href="#Call-for-Paper" class="headerlink" title="Call for Paper"></a>Call for Paper</h3><p>Each speaker is given a 30-minute session (25 minutes of speech + 5 minutes of Q&amp;A).The direction of the speech can be: kernel development, application practice, operation and maintenance management, data migration, distributed, high availability, security control, optimization, cloud database, open source upstream and downstream ecology, etc.</p>
<p>Please submit your speech topic first. The deadline for topic submission is <code>October 31, 2021</code>. The organizing committee will complete topic review before <code>November 15, 2021</code>. You will be notified the result of your topic selection at that time, please start preparing the speech content. The deadline for PPT submission is <code>November 30, 2021</code>.</p>
<p>Please download the PPT template <a href="https://2021.postgresconf.cn/assets/PPT%20Template-PGConf.CN&PGConf.Asia2021.pptx">here</a>.</p>
<p>You will have to create a free Postgres Conference account in order to submit your topic.</p>
<p>Access the account registration <a href="https://2021.postgresconf.cn/login_en?type=%2Ftheme_en">here</a></p>
<h3 id="Contacts"><a href="#Contacts" class="headerlink" title="Contacts"></a>Contacts</h3><p>Global Sponsor Interface:    <a href="mailto:grantzhou@postgresconf.org">grantzhou@postgresconf.org</a><br>About Speech submission and other inquiries:    <a href="mailto:meeting@postgresqlchina.com">meeting@postgresqlchina.com</a></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/10/01/Set-up-PostgreSQL-Continuous-archiving-and-Perform-Point-In-Time-Recovery/" class="image is-7by1">
            <img class="thumbnail" src="/images/pitr.png" alt="PostgreSQL 14 Continuous archiving and Point In Time Recovery Tutorial">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-01T18:33:13.000Z">2021-10-01</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    8 minutes read (About 1246 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/01/Set-up-PostgreSQL-Continuous-archiving-and-Perform-Point-In-Time-Recovery/">PostgreSQL 14 Continuous archiving and Point In Time Recovery Tutorial</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>Recently I have been practicing the internals of PostgreSQL continuous archiving and the point in time recovery features that are required for my current development work. Today I would like to demonstrate these important features with the recently released PostgreSQL 14 on Ubuntu 18.04.</p>
<h3 id="2-Write-Ahead-Log"><a href="#2-Write-Ahead-Log" class="headerlink" title="2. Write Ahead Log?"></a>2. Write Ahead Log?</h3><p>Before going into the details of continuous archiving, it is important to understand the concept of Write Ahead Log (WAL). WAL files are generated by PG that contains all of the operations done on the database since the beginning. Operations such as <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>VACUUM</code> …etc are captured in WAL files. Having these WAL files, it is possible to recreate the database simply by <code>replaying</code> them, allowing an user to recover the database to a certain state in case of fault. This is the basis of continuous archiving and point in time recovery.</p>
<h3 id="3-What-is-Continuous-Archiving"><a href="#3-What-is-Continuous-Archiving" class="headerlink" title="3. What is Continuous Archiving?"></a>3. What is Continuous Archiving?</h3><p>The generated WAL files are normally stored in the <code>pg_wal</code> directory within the PG database cluster, but they will not grow forever. The configuration parameters, <code>max_wal_size</code> and <code>min_wal_size</code> control how many WAL files can be kept in <code>pg_wal</code> directory. The checkpointer process will periodically purge the old WAL files, leaving only recent ones.</p>
<p>So, it is important to set up continuous archiving so all these WAL files can be <code>archived</code> to somewhere else outside of PG cluster. So, when you need all the old WAL files for recovery, PG can restore them from the archive.</p>
<p>To enable WAL archiving and restoring, set these parameters in postgresql.conf:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">archive_mode &#x3D; on</span><br><span class="line">archive_command &#x3D; &#39;cp %p &#x2F;path&#x2F;to&#x2F;archive&#x2F;%f&#39;</span><br><span class="line">restore_command &#x3D; &#39;cp &#x2F;path&#x2F;to&#x2F;archive&#x2F;%f %p&#39;</span><br></pre></td></tr></table></figure>

<p>where you should replace <code>/path/to/archive</code> with your own archive path on your system. %p and %f will be swapped with <code>path to WAL segment</code> and <code>WAL segment name</code> to complete the command.</p>
<p>When a WAL segment is ready to be archived, PG will create a signal file in <code>pg_wal/archive_status</code> to indicate a particular WAL segment is ready for archive. </p>
<p>In the example below, the segment <code>00000001000000000000000E</code> is ready for archive, indicated by the postfix <code>.ready</code> while all of the previous segments have been successfully archived and therefore indicated by the <code>.done</code> postfix.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ls pgtest&#x2F;pg_wal&#x2F;archive_status&#x2F;</span><br><span class="line">000000010000000000000002.done  000000010000000000000005.done  00000001000000000000000A.done  00000001000000000000000E.ready</span><br><span class="line">000000010000000000000003.done  000000010000000000000007.done  00000001000000000000000B.done</span><br><span class="line">000000010000000000000004.done  000000010000000000000008.done  00000001000000000000000D.done</span><br></pre></td></tr></table></figure>

<p>The PG’s archiver process will then be waken up to perform the archive by running the <code>archive_command</code> configured.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ps -ef | grep postgres</span><br><span class="line"></span><br><span class="line">caryh     1487     1  0 11:10 ?        00:00:00 postgres -D &#x2F;home&#x2F;caryh&#x2F;pgtest</span><br><span class="line">caryh     1510  1487  0 11:10 ?        00:00:00 postgres: checkpointer</span><br><span class="line">caryh     1511  1487  0 11:10 ?        00:00:00 postgres: background writer</span><br><span class="line">caryh     1512  1487  0 11:10 ?        00:00:00 postgres: walwriter</span><br><span class="line">caryh     1516  1487  0 11:10 ?        00:00:00 postgres: autovacuum launcher</span><br><span class="line">caryh     1520  1487  0 11:10 ?        00:00:00 postgres: archiver   archiving 00000001000000000000000E</span><br><span class="line">caryh     1521  1487  0 11:10 ?        00:00:00 postgres: stats collector</span><br><span class="line">caryh     1522  1487  0 11:10 ?        00:00:00 postgres: logical replication launcher</span><br></pre></td></tr></table></figure>

<p>Note that the archiver (PID=1520) also shows its progress on the <code>ps</code> display.</p>
<p>When done successfully, the signal file in <code>pg_wal/archive_status</code> will be updated to <code>.done</code> postfix.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ls pgtest&#x2F;pg_wal&#x2F;archive_status&#x2F;</span><br><span class="line">000000010000000000000002.done  000000010000000000000005.done  00000001000000000000000A.done  00000001000000000000000E.done</span><br><span class="line">000000010000000000000003.done  000000010000000000000007.done  00000001000000000000000B.done</span><br><span class="line">000000010000000000000004.done  000000010000000000000008.done  00000001000000000000000D.done</span><br></pre></td></tr></table></figure>

<p>In the next checkpoint, these <code>.done</code> files will be removed so these status files will not be continuously growing as well.</p>
<h3 id="4-What-is-Point-In-Time-Recovery-PITR"><a href="#4-What-is-Point-In-Time-Recovery-PITR" class="headerlink" title="4. What is Point In Time Recovery (PITR)?"></a>4. What is Point In Time Recovery (PITR)?</h3><p>Having all of the WAL segments backed up in a separate archive, we gained the ability to recovery the database up yo a certain point in time in the past or completely recover the whole database. This depends on your use case, if you made a major mistake and need to start again from a point of time in the past, you can have PG to recover to that particular time during recovery mode and continue the database operation from that point. This is also referred to as <code>switching  to a new time line ID</code> and we will discuss this more in the next blog.</p>
<p>Let’s continue from the above example (which already has 1 million rows of data) and do a point in time recovery.</p>
<ol>
<li><p>Make a basebackup of the current database, we can use <code>pg_basebackup</code> to achieve this</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ pg_basebackup -U caryh -h 127.0.0.1 --progress -D pgtest-back</span><br></pre></td></tr></table></figure>
</li>
<li><p>back to the database and continue inserting some more data, use <code>pg_switch_wal</code> to immediate write out the WAL segment and obtain a <code>LSN</code>. LSN stands for Log Sequence Number, and it logically represent a WAL entry within a WAL segment. Refer to documentation <a href="https://www.postgresql.org/docs/current/datatype-pg-lsn.html">here</a> for more information.</p>
</li>
</ol>
<p>After obtaining the LSN, we again insert some more rows of data. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into test values(generate_series(1,1000000), &#39;asdas&#39;);</span><br><span class="line">insert into test values(generate_series(1,1000000), &#39;asdas&#39;);</span><br><span class="line"></span><br><span class="line">pg_switch_wal();</span><br><span class="line"> pg_switch_wal</span><br><span class="line">---------------</span><br><span class="line"> 0&#x2F;13DAC308</span><br><span class="line"></span><br><span class="line">insert into test values(generate_series(1,1000000), &#39;asdas&#39;);</span><br><span class="line">insert into test values(generate_series(1,1000000), &#39;asdas&#39;);</span><br></pre></td></tr></table></figure>

<p>So, in total, this table <code>test</code> should have 5 million rows of data, because it started with 1 million and we just inserted 4 million more in the example above.</p>
<p>The WAL location indicated by LSN <code>0/13DAC308</code> indicated a time when the database only contains 3 million rows, and this is the <code>point of time</code> that we would like to recover up to in our example.</p>
<ol start="3">
<li><p>Stop the database server</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pg_ctl -D pgtest stop</span><br></pre></td></tr></table></figure>
</li>
<li><p>Wipe out everything in this database <code>pgtest</code></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ rm -rf pgtest&#x2F;</span><br></pre></td></tr></table></figure>

<p>I know it sounds crazy, but remember, we made a basebackup back in (1.) + all the WAL segments in the archive, so technically we still have everything.</p>
<ol start="5">
<li>Copy everything from our basebackup back to <code>pgtest</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp -r pgtest-back&#x2F;* pgtest&#x2F;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Edit pgtest/postgresql.conf and set your recover target</li>
</ol>
<p>Since we are using LSN as our target, we can simply put the LSN we captured to <code>recovery_target_lsn</code> configuration</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">recovery_target_lsn &#x3D; &#39;0&#x2F;13DAC308&#39;</span><br></pre></td></tr></table></figure>

<p>PG also supports other ways to define recovery target, based on timestamp, name or xid. Refer to this <a href="https://www.postgresql.org/docs/11/recovery-target-settings.html">documentation</a> for other options.</p>
<ol start="7">
<li>Signal the database to run in recovery mode by creating a <code>recovery.signal</code> file under the <code>pgtest</code> cluster</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$touch pgtest&#x2F;recovery.signal</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>Start the server<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$pg_ctl -D pgtest start</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>the server will now start in recovery mode and it will restore WAL files from the archive and perform the recover. You may log in with <code>psql</code> and check that the database should contain also 3 million rows instead of 5. </p>
<p>You may notice that even though the database has been recovered to a point of time in the past, you will encounter a <code>database in recovery</code> or <code>read only database</code> error if you intend to insert additional data. This is because we are still in the <code>recovery mode</code> but is currently <code>paused</code>.</p>
<p>This is configured by the <code>recovery_target_action</code> option, which defaults to <code>pause</code>. This is actually intended, to allow you to have a moment to check your database and confirm that it is indeed the database state that you would like to recover to. If this is wrong, you can simply shutdown the database and reconfigure the <code>recovery_target_lsn</code> until you reach a desired state of database.</p>
<ol start="9">
<li>Exit the recovery mode<br>Once you are confirm the database is recovered correctly, you can exit the recovery mode by this psql command:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select pg_wal_replay_resume();</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>This command will end the recovery mode and you should be able to insert additional data to the database. The <code>recovery.signal</code> file will be removed, and the future WAL segments will have a new timeline ID.</p>
<p>Timeline ID is also an important aspect of the recovery and we will discuss more on timeline ID in my next post.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/" class="image is-7by1">
            <img class="thumbnail" src="/images/fdw-foreign.png" alt="Implement Foreign Scan With FDW Interface API">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-09-03T16:47:45.000Z">2021-09-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1049 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/">Implement Foreign Scan With FDW Interface API</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>Recently I have been tasked to familiarize myself with the Foreign Data Wrapper (FDW) interface API to build a new FDW capable of doing vertical / columnar sharding, meaning that the FDW is capable of collecting column information from multiple sources and combine them together as a result query. I will document and blog about the vertical sharding in later posts. Now, in this blog, I would like to share some of the key findings and understanding of FDW interface related to foreign scan.</p>
<h3 id="2-Scan-related-API-Routines"><a href="#2-Scan-related-API-Routines" class="headerlink" title="2. Scan-related API Routines"></a>2. Scan-related API Routines</h3><p>FDW foreign scan API routines have some similarities to the table access method API’s sequential scan routines. You can learn more about it in the blog post <a href="https://www.highgo.ca/2021/01/15/how-postgresql-executes-sequential-scans-with-the-help-of-table-access-methods-apis/">here</a>. Most noticeable difference is that the FDW routines require us to take part during the planning stage, so we have to come out with a foreign plan for the exectuor so it knows what and how to perform the foreign scan.</p>
<p>In order to complete a foreign scan, the following FDW routines are invoked in order:</p>
<ul>
<li>IsForeignScanParallelSafe</li>
<li>GetForeignRelSize</li>
<li>GetForeignPaths</li>
<li>GetForeignPlan</li>
<li>BeginForeignScan</li>
<li>IterateForeignScan</li>
<li>…</li>
<li>IterateForeignScan</li>
<li>EndForeignScan</li>
</ul>
<h4 id="2-1-IsForeignScanParallelSafe"><a href="#2-1-IsForeignScanParallelSafe" class="headerlink" title="2.1 IsForeignScanParallelSafe"></a>2.1 IsForeignScanParallelSafe</h4><p>In this routine, you have to tell PG whether or not the foreign scan can support parallel Scan by returning true to indicate it is supported, or false otherwise. Parallel scan is invokved by the planner when a scan query involves retrieving a large amount of data. Depending on the foreign server and your implementation, you have to decide whether or not parallel scan is supported.</p>
<h4 id="2-2-GetForeignRelSize"><a href="#2-2-GetForeignRelSize" class="headerlink" title="2.2 GetForeignRelSize"></a>2.2 GetForeignRelSize</h4><p>Similar to the table access method’s <code>relation_estimate_size()</code> API, this routine requires you to provide an estimate of the amount of tuples/rows would be involved during this round of scanning. This information is very important because it directly affects the planner’s decision to execute the query. For example, if you say foreign relation has 1 million tuples to be fetched, then the planner is most likely to use parallel scan to complete the scan for performance reasons if you answer “true” in the <code>IsForeignScanParallelSafe()</code> function call.</p>
<h4 id="2-3-GetForeignPaths"><a href="#2-3-GetForeignPaths" class="headerlink" title="2.3 GetForeignPaths"></a>2.3 GetForeignPaths</h4><p>In this routine, we are required to provide a list of possible paths to complete the required foreign scan. Paths simply means ways to execute. For example, you can complete a foreign scan by doing a sequential scan by fetching 1 tuple at a time, or you can complete the same scan using index to look-up a target tuple if the table has an index defined and user gives specific <code>WHERE</code> clause to pinpoint a tuple. If user provides a <code>WHERE</code> clause to filter the result, you also have an option to estimate whether the <code>WHERE</code> can be executed by the foreign server or by the local server as it fetches a tuple.</p>
<p>All these are possible <code>pathnodes</code> are required by the planner to decide on the optimal path to execute the scan. Each <code>pathnode</code> requires you to provide the <code>startup cost</code>, <code>total cost</code>, <code>number of rows</code> and <code>path keys</code> if any. The official documentation suggests that you should use <code>add_path</code> and <code>create_foreignscan_path</code> routines to prepare a list of path nodes.</p>
<h4 id="2-4-GetForeignPlan"><a href="#2-4-GetForeignPlan" class="headerlink" title="2.4 GetForeignPlan"></a>2.4 GetForeignPlan</h4><p>Having provided all the possible <code>pathnodes</code>, planner will pick one that is the most optimal and pass that <code>pathnode</code> to this routine and ask you to make a foreign scan plan for the executor. This is a very important function because whatever plan that we provide here directly affects how the executor is going to function, so be cautious here.</p>
<p>In this function, the planner will give you everything about the query such as the target attribute list and the restricting clauses (<code>WHERE</code> clauses) and also the information about the foreign relation, such as its OID, and each column’s data types. Official PostgreSQL documentation suggests using <code>make_foreignscan()</code> routine with the desired arguments to create the foreign plan.</p>
<p>In here, you also will have an option to <code>push down</code> the restricting clauses or not. In other words, you can choose to send all the <code>WHERE</code> clauses to the foreign server to process if it can support it. This results in much less data communication. You can also choose having all the <code>WHERE</code> clauses to be processed locally, but this requires the FDW to fetch every single row from the foreign server, resulting in more data communication. This decision is controlled by the <code>List *qpqual</code> argument to the <code>make_foreignscan()</code> function. If this list contains the list of your restricting clauses, the local server will perform the <code>WHERE</code> evaluation locally; if this list is empty, then the local server assumes the FDW will do the <code>WHERE</code> evaluation on the foreign server</p>
<h4 id="2-5-BeginForeignScan"><a href="#2-5-BeginForeignScan" class="headerlink" title="2.5 BeginForeignScan"></a>2.5 BeginForeignScan</h4><p>This routine will be called before starting the foreign scan, giving you a chance to allocate all the necessary control information required for your foreign scan. You can define your own control information, for example, cursor location, remote connection structure, current offset…etc. and store in <code>node-&gt;fdw_state</code> and it will be passed down to the <code>IterateForeignScan</code> as the scan is begin completed.</p>
<h4 id="2-6-IterateForeignScan"><a href="#2-6-IterateForeignScan" class="headerlink" title="2.6 IterateForeignScan"></a>2.6 IterateForeignScan</h4><p>This is the main routine to perform the actual scan. You need to put the proper logic here depending on your use case to fetch one or more rows from the foreign server. When you have the row data, you will need to convert that to a <code>TupleTableSlot</code> strucutre in which the PG internals can understand. We normally use <code>ExecStoreHeapTuple()</code> routine to convert a HeapTuple into a <code>TupleTableSlot</code>. This routine will be continuously called by the PG executor as long as you still have data to fetch and it will only stop once you return an empty <code>TupleTableSlot</code>.</p>
<h4 id="2-7-EndForeignScan"><a href="#2-7-EndForeignScan" class="headerlink" title="2.7 EndForeignScan"></a>2.7 EndForeignScan</h4><p>This routine will be called at the end of foreign scan, giving you the opportunity to clean up the control information allocated in <code>BeginForeignScan()</code>. This marks the end of foreign scan via FDW.</p>
<h3 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3. Summary"></a>3. Summary</h3><p>There is a lot of information and articals out there related to PostgreSQL’s FDW API interface. This blog is merely a quick summary of what I have learned during the FDW evaluation and there is much more to what’s discussed here. For more detail, you can refer to the official documentation about the FDW callback functons <a href="https://www.postgresql.org/docs/current/fdw-callbacks.html">here</a> </p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-sec-banner.png" alt="Understanding the Security Around PostgreSQL">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-08-06T19:04:08.000Z">2021-08-06</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 670 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/">Understanding the Security Around PostgreSQL</a>
            
        </h1>
        <div class="content">
            <h3 id="1-What-Is-Security"><a href="#1-What-Is-Security" class="headerlink" title="1. What Is Security?"></a>1. What Is Security?</h3><p>The word “Security” is a very broad concept and could refer to completely different procedures and methodology to achieve. Knowing what security means to your application is very important, so you could execute proper security practices and procedures to ensure the safety of your company’s assets. Data compromises could often lead to financial loss, reputation damage, consumer confidence disintegration, brand erosion, and non-compliance of government and industry regulation. </p>
<p>For this reason, the security on infrastructure software such as PostgreSQL is even more important because any data compromises could have nation or city-wide impacts, which are often difficult to completely recover.</p>
<h3 id="2-Common-Database-Compromises"><a href="#2-Common-Database-Compromises" class="headerlink" title="2. Common Database Compromises"></a>2. Common Database Compromises</h3><p>User Compromises:</p>
<ul>
<li>Excessive privileges</li>
<li>Privilege abuse</li>
<li>Weak user authentication</li>
<li>Weak password</li>
<li>Default privilege too open</li>
</ul>
<p>Data Compromises:</p>
<ul>
<li>Unmanaged and unprotected sensitive data</li>
<li>Backup data exposure</li>
<li>Stolen hard disks</li>
<li>Unmanaged encryption keys</li>
</ul>
<p>Network Compromises:</p>
<ul>
<li>Firewall rules</li>
<li>Deep Packet Inspection (DPS)</li>
<li>Vulnerability prevention</li>
<li>Denial of Service (DOS) attack</li>
</ul>
<p>Vulnerability:</p>
<ul>
<li>Software bug</li>
<li>Buffer overflow</li>
<li>SQL injection</li>
<li>Privileged escalation</li>
</ul>
<h3 id="3-The-Big-Picture"><a href="#3-The-Big-Picture" class="headerlink" title="3. The Big Picture"></a>3. The Big Picture</h3><p><img src="/images/thebigpicture.png" alt="img"></p>
<p>This picture shows different types of “security” around a PostgreSQL server and there are roughly 5 types of security concepts involved here:</p>
<h4 id="3-1-Data-Security-Over-Network"><a href="#3-1-Data-Security-Over-Network" class="headerlink" title="3.1 Data Security (Over Network)"></a>3.1 Data Security (Over Network)</h4><p>This is the security in the communication between PostgreSQL client and server that we almost always want to use TLS to encrypt the data communication in a production environment. TLS guarantees the mutual trust between the client and the server so each side is sure that it is communicating with the right entity instead of a rogue server. SSH tunneling is also a common option to secure a psql connection when TLS is not fully set up. SSH tunneling is also very secure as each connection forces client and server to generate and agree on an encryption key that is valid only for that session. Furthermore, SSH tunneling can be made more secured by setting up the public and private key pair between client and server to ensure the authenticity of the two entities. </p>
<h4 id="3-2-Data-Security"><a href="#3-2-Data-Security" class="headerlink" title="3.2 Data Security"></a>3.2 Data Security</h4><p>This is the security between PostgreSQL and the disk in which it writes data to. This security type is often refereed as a “Cluster Data Encryption” or “Transparent Data Encryption”. Current version of PostgreSQL does not support this feature but there is a handful of talented people working on this feature right now. This security is designed to prevent data compromises directly done on the hard disk. By encrypting the data on the disk, hard disk theft will not be able to extract useful information from the hard disk. </p>
<h4 id="3-3-Network-Security"><a href="#3-3-Network-Security" class="headerlink" title="3.3 Network Security"></a>3.3 Network Security</h4><p>This is the security that most likely will involve a firewall in between a connecting client and a server. The purpose of a firewall is to block most of the malicious connections coming from the public network and prevent unauthorized access to the server. Most advanced firewalls such as an IPS can block DOS attacks and perform deep packet examination according to a database of known malicious packet and attacks. There are also firewalls such as an IDS that perform network monitoring only and will raise alert to the operator should it detects an attack attempt.</p>
<h4 id="3-4-Vulnerability"><a href="#3-4-Vulnerability" class="headerlink" title="3.4 Vulnerability"></a>3.4 Vulnerability</h4><p>This is the security that is mostly caused by a software bug that allows an attacker to take advantage of the server, steal data, or simply out a stop to the server and cause damage. The best way to prevent this is upgrade your PostgreSQL server to the latest version that has addressed most of the known vulnerabilities.</p>
<h4 id="3-5-User-Security"><a href="#3-5-User-Security" class="headerlink" title="3.5 User Security"></a>3.5 User Security</h4><p>This is the security that relates mostly to the user management, sometimes called a Role-Based Access Control (RBAC). This is where a database administrator is managing each database user and setting the right privileges for the right users. Excessive privileges, weak passwords and privilege abuses are very common if not done correctly. Make sure the right users get the right privileges and use a third party authentication servers such as LDAP or Kerberos instead of simple passwords can significantly increase the security ratings of your database infrastructure.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/" class="image is-7by1">
            <img class="thumbnail" src="/images/gdb-debug-banner.png" alt="Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-07-09T18:41:55.000Z">2021-07-09</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 minutes read (About 1372 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/">Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>I am working on a new PostgreSQL feature that redefines the way a tuple’s visibility status is determined. The feature is working very nicely until I start doing a large SELECT query, which triggers PostgreSQL to spawn multiple parallel workers to process the request. When this happens, the feature I am working on start to yield incorrect results. A good portion of the data tuples returned are missing because they are considered as invisible, while some portion of it remains visible. It immediately came to my attention that the new feature I am working on does not work in parallel worker mode and somehow I need to find a way to debug into a spawned parallel worker to examine how it is computing the visibility and what is missing inside.</p>
<p>In this blog, I would like to share with you how I use GDB to debug and trace into a new parallel worker spawned by Postmaster in order to fix the visibility issue.</p>
<h3 id="2-GDB-Basics"><a href="#2-GDB-Basics" class="headerlink" title="2. GDB Basics"></a>2. GDB Basics</h3><p>I wrote another blog previously that shows how to use GDB to trace and debug a PostgreSQL issues and share some of the most common commands that I use every day to resolve software issues. If you are new to GDB, I suggest giving this blog a read <a href="https://www.highgo.ca/2020/11/07/how-to-analyze-a-postgresql-crash-dump-file/">here</a></p>
<h3 id="3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker"><a href="#3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker" class="headerlink" title="3. How and When does PG Spawn A New Parallel Worker"></a>3. How and When does PG Spawn A New Parallel Worker</h3><p>When you use <code>psql</code> to connect to a PostgreSQL database, it will spawn a new backend worker process to serve this connecting client. Most of the queries you provide will be processed by this backend process, includes SELECT, UPDATE, INSERT…etc. By default, if your SELECT query will require doing a sequential scan over 8MB of data, it will try to use a parallel worker to help speed up the processing. This 8MB threshold can be configured by the <code>min_parallel_table_scan_size</code> parameter in <code>postgresql.conf</code> . There is another configuration parameter <code>max_parallel_workers</code> that controls the maximum number of parallel workers is allowed to be spawned. The default is 8. </p>
<p>Technically, I can avoid my visibility issues simply by either setting <code>min_parallel_table_scan_size</code> to a huge number, or setting <code>max_parallel_workers</code> to 0. But this is really not my style, I would like to keep all these goodies that PG provides while being able to solve the problem. </p>
<p>To spawn a parallel worker, the psql backend will initialize a parallel worker context in the global process table and a message queue based on shared memory for communication with the backend. Then it sends a signal to postmaster to notify that the global process table has been updated. </p>
<p>When postmaster receives the signal, it will load the global process table and found that it needs to spawn a new parallel worker. It will proceed to <code>fork</code> a new parallel worker according to the context information supplied. This information determines the entry point for the parallel worker and what to do once spawned. During processing, the parallel worker and the psql backend use the message queue to communicate tuples back and forth and finally the psql backend will gather together all the data tuples and produce a final result back to the user.</p>
<h3 id="4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned"><a href="#4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned" class="headerlink" title="4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?"></a>4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?</h3><p>Technically yes, but the life time of this parallel worker may be very short, by the time you see its PID from the <code>ps -ef</code> command, the worker may have already done its job and exited. This means, it is too late for me to start GDB and attach to its PID. </p>
<p>Instead, the technique I am going to show you today will trace the parallel worker from the moment it starts. </p>
<h3 id="5-Tracing-the-Parallel-Worker"><a href="#5-Tracing-the-Parallel-Worker" class="headerlink" title="5. Tracing the Parallel Worker"></a>5. Tracing the Parallel Worker</h3><p>I will be using this instance of PostgreSQL server (version 12.5) as an example where PID 11976 is the psql backend process serving the psql client. </p>
<p><img src="/images/mypids.png" alt="img"></p>
<h4 id="Pre-Condition"><a href="#Pre-Condition" class="headerlink" title="Pre-Condition:"></a>Pre-Condition:</h4><p>Connect psql to the PostgreSQL server, create an example table and inserted about 2.5M rows of data. This will for sure trigger parallel workers.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ psql -d postgres -U postgres -p 6660</span><br><span class="line">psql (12.5)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create table test(a int, b int);</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>

<h4 id="Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point"><a href="#Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point" class="headerlink" title="Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point"></a>Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point</h4><p>I am setting a break point at the function <code>RegisterDynamicBackgroundWorker</code>. This is called when parallel worker is required to complete the query. Setting a breakpoint allows us more control as to when to proceed with a parallel worker spawn. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11976</span><br><span class="line">(gdb) b RegisterDynamicBackgroundWorker</span><br></pre></td></tr></table></figure>


<h4 id="Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points"><a href="#Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points" class="headerlink" title="Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points"></a>Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points</h4><p>We are using a second GDB to attach to the postmaster and set 2 break points there. <code>fork_process</code> is the function before postmaster actually spawns a new parallel worker using the system <code>fork()</code> call.  <code>ParallelWorkerMain</code> is the main function for the parallel worker after it has been spawned. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11959</span><br><span class="line">(gdb) b fork_process</span><br><span class="line">(gdb) b ParallelWorkerMain</span><br></pre></td></tr></table></figure>

<h4 id="Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points"><a href="#Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points" class="headerlink" title="Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points"></a>Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postgres&#x3D;# select count(*) from test;</span><br></pre></td></tr></table></figure>

<p>The <code>RegisterDynamicBackgroundWorker</code> break point will be hit on the first GDB session having attached PID = 11959</p>
<p>Use the <code>continue</code> or <code>c</code> GDB command to continue to spawn the worker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, RegisterDynamicBackgroundWorker (worker&#x3D;0x7ffd867f3c80, handle&#x3D;0x55a009b77388) at bgworker.c:1002</span><br><span class="line">1002            bool            success &#x3D; false;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>

<p>As you continue the first GDB session, the second GDB session will pause due to receipt of a <code>SIGUSR1</code> signal. This signal tells postmaster to reload the global process table and then spawn a parallel worker. Using the <code>continue</code> command will hit the first break point at <code>fork_process</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Program received signal SIGUSR1, User defined signal 1.</span><br><span class="line">0x00007f301b97d0f7 in __GI___select (nfds&#x3D;5, readfds&#x3D;0x7ffd867f47d0, writefds&#x3D;0x0, exceptfds&#x3D;0x0, timeout&#x3D;0x7ffd867f4740)</span><br><span class="line">    at ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c:41</span><br><span class="line">41      in ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, fork_process () at fork_process.c:47</span><br><span class="line">47              fflush(stdout);</span><br><span class="line"></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent"><a href="#Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent" class="headerlink" title="Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent"></a>Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent</h4><p>At this point, the postmaster GDB is now waiting at the <code>fork_process</code> call, which is right before spawning a parallel worker. This is a good time now to tell GDB to follow the child process instead of staying at parent when the process calls <code>fork()</code>. The reason we want to set this late at this moment is because postmaster is occasionally  spawning other backend processes such as <code>walsender</code> and <code>walreceiver</code>. Setting to follow child process early may cause our GDB to follow to another backend process that we are not interested in.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) set follow-fork-mode child</span><br></pre></td></tr></table></figure>

<p>You may use the <code>continue</code> command after setting it to follow child. Then immediately the GDB will switch to the new child process having PID = 12198 below and hit our second break point <code>ParallelWorkerMain</code>. So, Now the GDB is debugging the parallel worker process instead of the original postmaster.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 12198]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">[Switching to Thread 0x7f301ca79740 (LWP 12198)]</span><br><span class="line"></span><br><span class="line">Thread 2.1 &quot;postgres&quot; hit Breakpoint 2, ParallelWorkerMain (main_arg&#x3D;1544458234) at parallel.c:1207</span><br><span class="line">1207    &#123;</span><br></pre></td></tr></table></figure>

<h4 id="Step-5-Continue-To-Debug-The-Parallel-Process"><a href="#Step-5-Continue-To-Debug-The-Parallel-Process" class="headerlink" title="Step 5: Continue To Debug The Parallel Process"></a>Step 5: Continue To Debug The Parallel Process</h4><p>Using the <code>ps -ef | grep postgres</code> command, we can see a new parallel worker being spawned having PID = 12198</p>
<p><img src="/images/mypids2.png" alt="img"></p>
<p>At this point, you are free to explore the process flow of the parallel worker. For me, I am debugging the visibility issues, so I will set additional break points at <code>HeapTupleSatisfiesMVCC</code> and <code>TransactionIdIsCurrentTransactionId</code>. In your case, you may be debugging some other functionalities. </p>
<p>Being able to debugging into a parallel worker with GDB allows me to see the problems I was having and being able to fix quickly.</p>
<p>If you are having trouble tracing into a parallel workers spawned by PostgreSQL during run time, I hope this blog will be helpful to you.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/" class="image is-7by1">
            <img class="thumbnail" src="/images/banner-2021-03-03.png" alt="How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-03-03T20:17:11.000Z">2021-03-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 minutes read (About 1846 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/">How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>As an experienced PostgreSQL user, you may have a lot of experience in setting up streaming replication in your database clusters to make multiple backups of your data. But have you wondered how the standby is able to correctly determine if a tuple sent from the primary should be visible to the user or not. In the case where a transaction contains multiple subtransactions, how does the standby determine the visibility in this case? You might say… well it is PostgreSQL so it will just work… This is true. If you are someone who is curious and interested in knowing how PostgreSQL does certain things internally, then this blog may be interesting for you as we will talk about normally transaction and subtransactions and how both affect the standby’s ability to determine tuple visibility.</p>
<h3 id="2-How-is-Tuple-Visibility-Determined"><a href="#2-How-is-Tuple-Visibility-Determined" class="headerlink" title="2. How is Tuple Visibility Determined?"></a>2. How is Tuple Visibility Determined?</h3><p>PostgreSQL determines a tuple’s visibility based on the concept of transaction ID (a.k.a <code>txid</code>) and it is normally stored in a tuple’s header as either <code>xmin</code> or <code>xmax</code> where <code>xmin</code> holds the <code>txid</code> of the transaction that inserted this tuple and <code>t_xmax</code> holds the <code>txid</code> of the transaction that deleted or updated this tuple. If a tuple has not been deleted, its <code>t_xmax</code> is 0. There is also another mechanism called commit log (a.k.a <code>clog</code>) where it has information of currently active transaction IDs. When an inserted tuple has a valid <code>t_xmin</code> and invalid <code>t_xmax</code>, PostgreSQL will have to consult the <code>clog</code> first to determine if the <code>txid</code> stored in <code>t_xmin</code> is visible or not, then the result will be stored in the tuple’s <code>hint_bit</code> field about the visibility information such that it does not always have to consult the <code>clog</code> which could be resource intensive. If a tuple has a valid <code>t_xmax</code>, then there is no need to consult the <code>clog</code> as the tuple must be invisible. </p>
<p>This is just the basic ideas of how visibility is determined but it is enough for me to continue with this blog. For more information about visibility, you could refer to this <a href="http://www.interdb.jp/pg/pgsql05.html#_5.7.">resource</a></p>
<h3 id="3-What-is-a-Subtransaction"><a href="#3-What-is-a-Subtransaction" class="headerlink" title="3. What is a Subtransaction?"></a>3. What is a Subtransaction?</h3><p>As the name suggests, it is a smaller transaction that exists within a regular transaction and it can be created using the <code>SAVEPOINT</code> keyword after your <code>BEGIN</code> statement. Normally, when you have issued a <code>BEGIN</code> statement, all the tuples created from the subsequent DML statements such as <code>INSERT</code> or <code>UPDATE</code> will have a <code>txid</code> associated with these tuples and they will all be the same. </p>
<p>When you issue a <code>SAVEPOINT</code> statement within this transaction, all the tuples created from the subsequent DML statements will have a different <code>txid</code> that is normally larger than the main transaction’s <code>txid</code>. When you issue the <code>SAVEPOINT</code> statement again, the <code>txid</code> changes again. </p>
<p>The advantage of Subtransaction is that in a very large transaction, the entire transaction will not be aborted due to an error. It allows you to rollback to the previously created <code>SAVEPOINT</code> and continue to execute the main transaction. </p>
<p>The biggest difference between a subtransaction and a regular transaction is that there is not a concept of <code>commit</code> associated with subtransactions and it will not be recorded in the WAL file. However, if subtransaction is aborted, it will be recorded in the WAL file and subsequently be sent to the standby.</p>
<h3 id="4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction"><a href="#4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction" class="headerlink" title="4. How Does a Standby Determines Visibility Information In a Regular Transaction?"></a>4. How Does a Standby Determines Visibility Information In a Regular Transaction?</h3><p>Here’s an example of a regular transaction without any subtransactions:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In a general case, the above queries will send at least 4 WAL records to the standby during streaming replication. First 3 contain the actual tuple information with <code>t_xmin</code> set to the current transaction ID which is 500 in the example. In other words, before the <code>COMMIT</code> is issued, the standby should have already received 3 WAL records from primary and completed the redo, meaning that the 3 tuples already exist in standby’s memory buffer. However, they are not visible yet because transaction ID 500 does not exist in the standby. It is until the <code>COMMIT</code> is issued in the primary that will subsequently generate a <code>XLOG_XACT_COMMIT</code> WAL record to be sent to standby to notify that transaction ID 500 is now committed and valid. When standby receives the <code>XLOG_XACT_COMMIT</code> WAL record, it will eventually update to its <code>clog</code> so the subsequent <code>SELECT</code> queries can do visibility check against. </p>
<h3 id="5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions"><a href="#5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions" class="headerlink" title="5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?"></a>5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?</h3><p>Now, let’s use the same example but add some <code>SAVEPOINT</code> to create subtransactions</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>As you can see, after the creation of <code>SAVEPOINT</code>, the tuple’s <code>t_xmin</code> value will be changed and is no longer equal to the current transaction ID, which is 500 in the example. Before the <code>COMMIT</code> is issued, the standby should have received 9 WAL records, 3 having <code>t_xmin</code> = 500, 3 having <code>t_xmin</code> = 501 and 3 having <code>t_xmin</code> = 502. None of them is visible yet in the standby because these transaction IDs do not exist yet. When the primary issues the <code>COMMIT</code> statement, it will generate a <code>XLOG_XACT_COMMIT</code> WAL record and send to standby containing only the current transaction ID 500 without the 501 and 502. </p>
<p>After the commit, the standby is able to see all 9 tuples that are replicated from the primary. Now, you may be asking…. why? How come the standby knows that <code>txid</code> = 501 and 502 are also visible even though the primary never send a <code>XLOG_XACT_COMMIT</code> WAL record to tell the standby that 501 and 502 are also committed. Keep reading to find out.</p>
<p>Using the similar example, if we rollback to one of the SAVEPOINTs, the primary will send a XLOG_XACT_ABORT WAL record to notify the standby a transaction ID has become invalid.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">ROLLBACK TO SAVEPOINT B;  &#x3D;&gt; a XLOG_XACT_ABORT WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In this example, when doing a <code>ROLLBACK</code> to <code>SAVEPOINT</code> B, a XLOG_XACT_ABORT WAL record will be sent to the standby to invalidate that the transaction ID 502 is invalid. So when primary commits, records having <code>txid</code>=502 will not be visible as primary has notified.</p>
<h3 id="6-The-Secret-of-Standby’s-KnownAssignedTransactionIds"><a href="#6-The-Secret-of-Standby’s-KnownAssignedTransactionIds" class="headerlink" title="6. The Secret of Standby’s KnownAssignedTransactionIds"></a>6. The Secret of Standby’s KnownAssignedTransactionIds</h3><p>In addition to handling the XLOG_XACT_COMMIT and XLOG_XACT_ABORT WAL records to determine if a <code>txid</code> is valid or not, it actually manages a global <code>txid</code> list called <code>KnownAssignedTransactionIds</code>. Whenever a standby receives a heap_redo WAL record, it will save its <code>xmin</code> to <code>KnownAssignedTransactionIds</code>. Using the same example as above again here:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby and standby submits 500, 501 and 502 to clog as valid.</span><br></pre></td></tr></table></figure>

<p>Before the <code>COMMIT</code> is issued on the primary, the standby already has <code>txid</code> 500, 501, and 502 present in the <code>KnownAssignedTransactionIds</code>. When the standby receives <code>XLOG_XACT_COMMIT WAL</code>, it will actually submit <code>txid</code> 500 from the WAL plus the 501 and 502 from <code>KnownAssignedTransactionIds</code> to the <code>clog</code>. So that the subsequent <code>SELECT</code> query consult the <code>clog</code> it will say <code>txid</code> 500, 501, and 502 are visible. If the primary sends <code>XLOG_XACT_ABORT</code> as a result of rolling back to a previous <code>SAVEPOINT</code>, that invalid <code>txid</code> will be removed from the <code>KnownAssignedTransactionIds</code>, so when the transaction commits, the invalid <code>txid</code> will not be submit to <code>clog</code>.</p>
<h3 id="7-Summary"><a href="#7-Summary" class="headerlink" title="7. Summary"></a>7. Summary</h3><p>So this is how PostgreSQL determines a tuple’s visibility within subtransactions in a streaming replication setup. Of course, there is more details to what is discussed here in this blog, but I hope today’s discussion can help you get a general understanding of how PostgreSQL determines the visibility and maybe it will help you in your current work on PostgreSQL.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/" class="image is-7by1">
            <img class="thumbnail" src="/images/tuple-insert-banner.png" alt="How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-02-02T19:35:31.000Z">2021-02-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1117 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/">How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>This blog talks about a high level description of the mechanism behind PostgreSQL to execute an <code>INSERT</code> query. This process involves many steps of processing before the data is put in the right place. These process normally involves several catalog cache lookup to determine if the destination table exists or several checking on the constraint violations..etc. This blog will mainly focus on the part where the processing handle is passed to the PostgreSQL’s table access method API and its interaction with buffer manager and WAL routines. This is also the core area where an <code>INSERT</code> query is actually executed. If you are a developer looking to understand how PostgreSQL works internally, this blog may be helpful to you…</p>
<h3 id="2-Table-Access-Method-APIs-in-PostgreSQL"><a href="#2-Table-Access-Method-APIs-in-PostgreSQL" class="headerlink" title="2. Table Access Method APIs in PostgreSQL"></a>2. Table Access Method APIs in PostgreSQL</h3><p>Pluggable table access method API has been made available since PostgreSQL 12, which allows a developer to redefine how PostgreSQL stores / retrieves table data. This API contains a total of 42 routines that need to be implemented in order to complete the implementation and honestly it is no easy task to understand all of them and to implement them. This API structure is defined in <code>tableam.h</code> under the name <code>typedef struct TableAmRoutine</code></p>
<p>Today I will describe the routines related to <code>INSERT</code>.</p>
<h3 id="3-INSERT-Query-Overall-Call-Flow"><a href="#3-INSERT-Query-Overall-Call-Flow" class="headerlink" title="3. INSERT Query Overall Call Flow"></a>3. INSERT Query Overall Call Flow</h3><p>A few of the 42 routines will be called by executor just to complete an <code>INSERT</code> query. This section will describe these routines in the order they are called.</p>
<h4 id="3-1-slot-callbacks"><a href="#3-1-slot-callbacks" class="headerlink" title="3.1 slot_callbacks"></a>3.1 slot_callbacks</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const TupleTableSlotOps *(*slot_callbacks) (Relation rel);</span><br></pre></td></tr></table></figure>
<p>The executor needs to find out which set of tuple table slot (TTS) callback operation this table access method is compatible with. TTS is a set of routines that ensures the tuple storage is compatible between the executor and your access method. The executor will execute the TTS callback to <code>translate</code> your tuple strucuture to <code>TupleTableSlot</code> format in which the executor will understand. The default <code>heap</code> access method uses <code>TTSOpsBufferHeapTuple</code> defined in <code>execTuples.c</code> to handle this operation</p>
<h4 id="3-2-heap-insert"><a href="#3-2-heap-insert" class="headerlink" title="3.2 heap_insert"></a>3.2 heap_insert</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void</span><br><span class="line">heap_insert(Relation relation, HeapTuple tup, CommandId cid,</span><br><span class="line">			int options, BulkInsertState bistate)</span><br></pre></td></tr></table></figure>
<p><code>heap_insert</code> is the entry point to perform the actual data insertion and it will undergo several other routines provided by <code>buffer manager</code> and <code>WAL module</code> in order to complete the insertion.</p>
<h5 id="heap-prepare-insert"><a href="#heap-prepare-insert" class="headerlink" title="heap_prepare_insert"></a>heap_prepare_insert</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static HeapTuple heap_prepare_insert(Relation relation, HeapTuple tup,</span><br><span class="line">									 TransactionId xid, CommandId cid, int options);</span><br></pre></td></tr></table></figure>
<p>This is a subroutine for <code>heap_insert</code> where it will initialize the tuple header contents such as relation OID, infomasks, xmin, xmax values. It will also determine if the tuple is too big that <code>TOAST</code> is required to complete the insertion. These terms and parameters are very technical in PostgreSQL. If you are not sure what exactly they are, you could refer to resources <a href="https://www.postgresql.org/docs/current/storage-toast.html">here</a> and <a href="https://www.postgresql.org/docs/current/ddl-system-columns.html">here</a>.</p>
<h5 id="RelationGetBufferForTuple"><a href="#RelationGetBufferForTuple" class="headerlink" title="RelationGetBufferForTuple"></a>RelationGetBufferForTuple</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern Buffer RelationGetBufferForTuple(Relation relation, Size len,</span><br><span class="line">										Buffer otherBuffer, int options,</span><br><span class="line">										BulkInsertStateData *bistate,</span><br><span class="line">										Buffer *vmbuffer, Buffer *vmbuffer_other);</span><br></pre></td></tr></table></figure>
<p>This is an entry function to access <code>buffer manager</code> resources and all it is doing is ask the <code>buffer manager</code> to return a <code>buffer ID</code> that can be used to store the target tuple. This may sound very straightforward, but there is quite a lot of processing on the buffer manager side to properly determine a desired buffer location. </p>
<p>First, it will do a quick size check. If the input tuple is larger than the size of each buffer block, it will return immediately with error as <code>TOAST</code> has to be used in this case. Then it will try to put the tuple on the same page the system last inserted the tuple on to see if it will fit there. If not, it will utilize the <code>free space map</code> to find another page that could fit tuple. If that does not work out, then buffer manage will allocate a new data page (also referred to as <code>extend</code>) to be used to hold this new tuple. As soon as we have a desired buffer page determined, buffer manager will cache this page in the <code>relation</code> structure such that next time the same relation visits the buffer manager, it knows immediately about the reference to the last inserted block. </p>
<h5 id="RelationPutHeapTuple"><a href="#RelationPutHeapTuple" class="headerlink" title="RelationPutHeapTuple"></a>RelationPutHeapTuple</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern void RelationPutHeapTuple(Relation relation, Buffer buffer,</span><br><span class="line">								 HeapTuple tuple, bool token);</span><br></pre></td></tr></table></figure>
<p>Once we have identified the location of the buffer to store the tuple, the insert routine will then call <code>RelationPutHeapTuple</code> to actually put the tuple in the specified buffer location. This routine will again ask the buffer manager to get a pointer reference to the data page using the buffer ID we obtained from <code>RelationGetBufferForTuple</code>, then add the tuple data using <code>PageAddItem()</code> routine. Internally in buffer manager, it manages the relationship between buffer ID, buffer descriptor and the actual pointer to the data page to help us correctly identify and write to a data page. After a successful write, the routine will save a <code>CTID</code> of the inserted tuple. This ID is the location of this tuple and it consists of the data page number and the offset. For more information about how buffer manager works, you can refer to the resource <a href="http://www.interdb.jp/pg/pgsql08.html">here</a></p>
<h5 id="Mark-buffer-dirty"><a href="#Mark-buffer-dirty" class="headerlink" title="Mark buffer dirty"></a>Mark buffer dirty</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern void MarkBufferDirty(Buffer buffer);</span><br></pre></td></tr></table></figure>
<p>At this point, the tuple data is already stored in the buffer manager referenced by a particular data page plus an offset, but it is not yet flushed to disk yet. In this case, we almost always will have to call <code>MarkBufferDirty</code> function to signal buffer manager that there are some tuples on the page that have not been flushed to disk and therefore in the next <code>checkpoint</code>, it will ensure the new tuples are flushed to disk.</p>
<h5 id="Insert-WAL-Record"><a href="#Insert-WAL-Record" class="headerlink" title="[Insert WAL Record]"></a>[Insert WAL Record]</h5><p>Last but not least, after doing all the hassle of finding a buffer location to put our tuple in and mark it as dirty, it is time for the <code>heap_insert</code> routine to populate a WAL record. This part is not the focus of this blog so I will skip the high level details of WAL writing.</p>
<h4 id="3-3-End-of-the-insertion"><a href="#3-3-End-of-the-insertion" class="headerlink" title="3.3 End of the insertion"></a>3.3 End of the insertion</h4><p>At this point the insertion of a new tuple data has finished and proper WAL record has been written. The routine will once again save the <code>CTID</code> value that we derived during the data insertion and save this value to the <code>TTS</code> structure so the executor also gets a copy of the location of the tuple. Then it will clean up the local resources before returning.</p>
<h3 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h3><p>What we have discussed here is the basic call flow of a simple sequential scan. If we were to visualize the process, it should look something like this:<br><img src="/images/tuple-insert.png" alt="tuple insert"></p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/tags/postgresql/page/0/">Previous</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/tags/postgresql/page/2/">Next</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/tags/postgresql/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/postgresql/page/2/">2</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/prof-img.jpg" alt="Cary Huang">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Cary Huang
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Multi-Displined Software Developer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Vancouver</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            29
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            46
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/caryhuang" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/caryhuang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://www.facebook.com/cary.huang.35">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.etsy.com/ca/shop/ShokuninDesignCo" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Etsy Shop</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.etsy.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.highgo.ca/" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">HighGo Software Canada</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.highgo.ca</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Netsnmp/">
            <span class="level-start">
                <span class="level-item">Netsnmp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/PostgreSQL/">
            <span class="level-start">
                <span class="level-item">PostgreSQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">26</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/2021-PG-Asia-Conference/" style="font-size: 12.5px;">2021 PG Asia Conference</a> <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/backend/" style="font-size: 10px;">backend</a> <a href="/tags/buffer-manager/" style="font-size: 10px;">buffer manager</a> <a href="/tags/extended-query/" style="font-size: 10px;">extended query</a> <a href="/tags/extension/" style="font-size: 10px;">extension</a> <a href="/tags/external-key-management-system/" style="font-size: 10px;">external key management system</a> <a href="/tags/failover/" style="font-size: 10px;">failover</a> <a href="/tags/fdw/" style="font-size: 10px;">fdw</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/in-memory/" style="font-size: 10px;">in-memory</a> <a href="/tags/in-memory-table/" style="font-size: 10px;">in-memory table</a> <a href="/tags/key-management-system/" style="font-size: 10px;">key management system</a> <a href="/tags/logical-decoding/" style="font-size: 10px;">logical decoding</a> <a href="/tags/logical-replication/" style="font-size: 10px;">logical replication</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/networking/" style="font-size: 17.5px;">networking</a> <a href="/tags/oid/" style="font-size: 10px;">oid</a> <a href="/tags/parallel-worker/" style="font-size: 10px;">parallel worker</a> <a href="/tags/partition/" style="font-size: 10px;">partition</a> <a href="/tags/pg13/" style="font-size: 10px;">pg13</a> <a href="/tags/pg-rewind/" style="font-size: 10px;">pg_rewind</a> <a href="/tags/pitr/" style="font-size: 10px;">pitr</a> <a href="/tags/pluggable-api/" style="font-size: 10px;">pluggable api</a> <a href="/tags/pluggable-storage/" style="font-size: 15px;">pluggable storage</a> <a href="/tags/postgres/" style="font-size: 10px;">postgres</a> <a href="/tags/postgresql/" style="font-size: 20px;">postgresql</a> <a href="/tags/postmaster/" style="font-size: 12.5px;">postmaster</a> <a href="/tags/query-processing/" style="font-size: 10px;">query processing</a> <a href="/tags/recovery/" style="font-size: 12.5px;">recovery</a> <a href="/tags/replication/" style="font-size: 15px;">replication</a> <a href="/tags/savepoint/" style="font-size: 10px;">savepoint</a> <a href="/tags/security/" style="font-size: 17.5px;">security</a> <a href="/tags/sequence/" style="font-size: 10px;">sequence</a> <a href="/tags/snmp/" style="font-size: 10px;">snmp</a> <a href="/tags/streaming-replication/" style="font-size: 10px;">streaming replication</a> <a href="/tags/subtransaction/" style="font-size: 10px;">subtransaction</a> <a href="/tags/table-access-method/" style="font-size: 12.5px;">table access method</a> <a href="/tags/tde/" style="font-size: 10px;">tde</a> <a href="/tags/timeline-id/" style="font-size: 10px;">timeline id</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/trace/" style="font-size: 10px;">trace</a> <a href="/tags/trigger/" style="font-size: 10px;">trigger</a> <a href="/tags/visibility/" style="font-size: 10px;">visibility</a> <a href="/tags/wal2mongo/" style="font-size: 10px;">wal2mongo</a> <a href="/tags/wire-protocol/" style="font-size: 10px;">wire protocol</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <a href="/2022/01/18/2021-PG-Asia-Conferenece-Delivered-Another-Successful-Online-Conference-Again/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="2021 PG Asia Conference Delivered Another Successful Online Conference Again!">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2022-01-18T20:57:59.000Z">2022-01-18</time></div>
                    <a href="/2022/01/18/2021-PG-Asia-Conferenece-Delivered-Another-Successful-Online-Conference-Again/" class="title has-link-black-ter is-size-6 has-text-weight-normal">2021 PG Asia Conference Delivered Another Successful Online Conference Again!</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/12/10/A-Look-Inside-PostgreSQL-s-Extended-Query-Protocol/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/extended.png" alt="A Look Inside PostgreSQL&#39;s Extended Query Protocol">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-12-10T19:34:58.000Z">2021-12-10</time></div>
                    <a href="/2021/12/10/A-Look-Inside-PostgreSQL-s-Extended-Query-Protocol/" class="title has-link-black-ter is-size-6 has-text-weight-normal">A Look Inside PostgreSQL&#39;s Extended Query Protocol</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/29/The-PostgreSQL-Timeline-Concept/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/timeline.png" alt="The PostgreSQL Timeline Concept">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-29T16:46:01.000Z">2021-10-29</time></div>
                    <a href="/2021/10/29/The-PostgreSQL-Timeline-Concept/" class="title has-link-black-ter is-size-6 has-text-weight-normal">The PostgreSQL Timeline Concept</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/25/PostgresConf-CN-and-PGConf-Asia-2021-China-Branch-Join-Forces-Again-to-Bring-You-the-Best/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/title-conference-en.jpg" alt="PostgresConf.CN and PGConf.Asia 2021 (China Branch) Join Forces Again to Bring You the Best!">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-25T17:25:12.000Z">2021-10-25</time></div>
                    <a href="/2021/10/25/PostgresConf-CN-and-PGConf-Asia-2021-China-Branch-Join-Forces-Again-to-Bring-You-the-Best/" class="title has-link-black-ter is-size-6 has-text-weight-normal">PostgresConf.CN and PGConf.Asia 2021 (China Branch) Join Forces Again to Bring You the Best!</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/01/Set-up-PostgreSQL-Continuous-archiving-and-Perform-Point-In-Time-Recovery/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pitr.png" alt="PostgreSQL 14 Continuous archiving and Point In Time Recovery Tutorial">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-01T18:33:13.000Z">2021-10-01</time></div>
                    <a href="/2021/10/01/Set-up-PostgreSQL-Continuous-archiving-and-Perform-Point-In-Time-Recovery/" class="title has-link-black-ter is-size-6 has-text-weight-normal">PostgreSQL 14 Continuous archiving and Point In Time Recovery Tutorial</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2022/01/">
                <span class="level-start">
                    <span class="level-item">January 2022</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/12/">
                <span class="level-start">
                    <span class="level-item">December 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/10/">
                <span class="level-start">
                    <span class="level-item">October 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">September 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/08/">
                <span class="level-start">
                    <span class="level-item">August 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/07/">
                <span class="level-start">
                    <span class="level-item">July 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">March 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/02/">
                <span class="level-start">
                    <span class="level-item">February 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">January 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">November 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">September 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">August 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">July 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">June 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">May 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">April 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">March 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">January 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">October 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">September 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">July 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/2021-PG-Asia-Conference/">
                        <span class="tag">2021 PG Asia Conference</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/architecture/">
                        <span class="tag">architecture</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/backend/">
                        <span class="tag">backend</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/buffer-manager/">
                        <span class="tag">buffer manager</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extended-query/">
                        <span class="tag">extended query</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extension/">
                        <span class="tag">extension</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/external-key-management-system/">
                        <span class="tag">external key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/failover/">
                        <span class="tag">failover</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/fdw/">
                        <span class="tag">fdw</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/gdb/">
                        <span class="tag">gdb</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory/">
                        <span class="tag">in-memory</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory-table/">
                        <span class="tag">in-memory table</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/key-management-system/">
                        <span class="tag">key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-decoding/">
                        <span class="tag">logical decoding</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-replication/">
                        <span class="tag">logical replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mongodb/">
                        <span class="tag">mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/networking/">
                        <span class="tag">networking</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/oid/">
                        <span class="tag">oid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/parallel-worker/">
                        <span class="tag">parallel worker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/partition/">
                        <span class="tag">partition</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg13/">
                        <span class="tag">pg13</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg-rewind/">
                        <span class="tag">pg_rewind</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pitr/">
                        <span class="tag">pitr</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-api/">
                        <span class="tag">pluggable api</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-storage/">
                        <span class="tag">pluggable storage</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgres/">
                        <span class="tag">postgres</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgresql/">
                        <span class="tag">postgresql</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postmaster/">
                        <span class="tag">postmaster</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/query-processing/">
                        <span class="tag">query processing</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/recovery/">
                        <span class="tag">recovery</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/replication/">
                        <span class="tag">replication</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/savepoint/">
                        <span class="tag">savepoint</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/security/">
                        <span class="tag">security</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sequence/">
                        <span class="tag">sequence</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/snmp/">
                        <span class="tag">snmp</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/streaming-replication/">
                        <span class="tag">streaming replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/subtransaction/">
                        <span class="tag">subtransaction</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/table-access-method/">
                        <span class="tag">table access method</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tde/">
                        <span class="tag">tde</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/timeline-id/">
                        <span class="tag">timeline id</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tls/">
                        <span class="tag">tls</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trace/">
                        <span class="tag">trace</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trigger/">
                        <span class="tag">trigger</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility/">
                        <span class="tag">visibility</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wal2mongo/">
                        <span class="tag">wal2mongo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wire-protocol/">
                        <span class="tag">wire protocol</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2022 Cary Huang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://caryhuang.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>