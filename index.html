<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Cary&#39;s Blog</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="Cary&#39;s Blog">
<meta property="og:url" content="http://caryhuang.github.io/index.html">
<meta property="og:site_name" content="Cary&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://caryhuang.github.io/images/og_image.png">
<meta property="article:author" content="Cary Huang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://caryhuang.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Cary's Blog" type="application/atom+xml">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item is-active"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
                <a class="navbar-item"
                href="/about/me.html">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main">
    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/" class="image is-7by1">
            <img class="thumbnail" src="/images/fdw-foreign.png" alt="How to Implement Foreign Scan With FDW Interface API">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-09-03T16:47:45.000Z">2021-09-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1049 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/">How to Implement Foreign Scan With FDW Interface API</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>Recently I have been tasked to familiarize myself with the Foreign Data Wrapper (FDW) interface API to build a new FDW capable of doing vertical / columnar sharding, meaning that the FDW is capable of collecting column information from multiple sources and combine them together as a result query. I will document and blog about the vertical sharding in later posts. Now, in this blog, I would like to share some of the key findings and understanding of FDW interface related to foreign scan.</p>
<h3 id="2-Scan-related-API-Routines"><a href="#2-Scan-related-API-Routines" class="headerlink" title="2. Scan-related API Routines"></a>2. Scan-related API Routines</h3><p>FDW foreign scan API routines have some similarities to the table access method API’s sequential scan routines. You can learn more about it in the blog post <a href="https://www.highgo.ca/2021/01/15/how-postgresql-executes-sequential-scans-with-the-help-of-table-access-methods-apis/">here</a>. Most noticeable difference is that the FDW routines require us to take part during the planning stage, so we have to come out with a foreign plan for the exectuor so it knows what and how to perform the foreign scan.</p>
<p>In order to complete a foreign scan, the following FDW routines are invoked in order:</p>
<ul>
<li>IsForeignScanParallelSafe</li>
<li>GetForeignRelSize</li>
<li>GetForeignPaths</li>
<li>GetForeignPlan</li>
<li>BeginForeignScan</li>
<li>IterateForeignScan</li>
<li>…</li>
<li>IterateForeignScan</li>
<li>EndForeignScan</li>
</ul>
<h4 id="2-1-IsForeignScanParallelSafe"><a href="#2-1-IsForeignScanParallelSafe" class="headerlink" title="2.1 IsForeignScanParallelSafe"></a>2.1 IsForeignScanParallelSafe</h4><p>In this routine, you have to tell PG whether or not the foreign scan can support parallel Scan by returning true to indicate it is supported, or false otherwise. Parallel scan is invokved by the planner when a scan query involves retrieving a large amount of data. Depending on the foreign server and your implementation, you have to decide whether or not parallel scan is supported.</p>
<h4 id="2-2-GetForeignRelSize"><a href="#2-2-GetForeignRelSize" class="headerlink" title="2.2 GetForeignRelSize"></a>2.2 GetForeignRelSize</h4><p>Similar to the table access method’s <code>relation_estimate_size()</code> API, this routine requires you to provide an estimate of the amount of tuples/rows would be involved during this round of scanning. This information is very important because it directly affects the planner’s decision to execute the query. For example, if you say foreign relation has 1 million tuples to be fetched, then the planner is most likely to use parallel scan to complete the scan for performance reasons if you answer “true” in the <code>IsForeignScanParallelSafe()</code> function call.</p>
<h4 id="2-3-GetForeignPaths"><a href="#2-3-GetForeignPaths" class="headerlink" title="2.3 GetForeignPaths"></a>2.3 GetForeignPaths</h4><p>In this routine, we are required to provide a list of possible paths to complete the required foreign scan. Paths simply means ways to execute. For example, you can complete a foreign scan by doing a sequential scan by fetching 1 tuple at a time, or you can complete the same scan using index to look-up a target tuple if the table has an index defined and user gives specific <code>WHERE</code> clause to pinpoint a tuple. If user provides a <code>WHERE</code> clause to filter the result, you also have an option to estimate whether the <code>WHERE</code> can be executed by the foreign server or by the local server as it fetches a tuple.</p>
<p>All these are possible <code>pathnodes</code> are required by the planner to decide on the optimal path to execute the scan. Each <code>pathnode</code> requires you to provide the <code>startup cost</code>, <code>total cost</code>, <code>number of rows</code> and <code>path keys</code> if any. The official documentation suggests that you should use <code>add_path</code> and <code>create_foreignscan_path</code> routines to prepare a list of path nodes.</p>
<h4 id="2-4-GetForeignPlan"><a href="#2-4-GetForeignPlan" class="headerlink" title="2.4 GetForeignPlan"></a>2.4 GetForeignPlan</h4><p>Having provided all the possible <code>pathnodes</code>, planner will pick one that is the most optimal and pass that <code>pathnode</code> to this routine and ask you to make a foreign scan plan for the executor. This is a very important function because whatever plan that we provide here directly affects how the executor is going to function, so be cautious here.</p>
<p>In this function, the planner will give you everything about the query such as the target attribute list and the restricting clauses (<code>WHERE</code> clauses) and also the information about the foreign relation, such as its OID, and each column’s data types. Official PostgreSQL documentation suggests using <code>make_foreignscan()</code> routine with the desired arguments to create the foreign plan.</p>
<p>In here, you also will have an option to <code>push down</code> the restricting clauses or not. In other words, you can choose to send all the <code>WHERE</code> clauses to the foreign server to process if it can support it. This results in much less data communication. You can also choose having all the <code>WHERE</code> clauses to be processed locally, but this requires the FDW to fetch every single row from the foreign server, resulting in more data communication. This decision is controlled by the <code>List *qpqual</code> argument to the <code>make_foreignscan()</code> function. If this list contains the list of your restricting clauses, the local server will perform the <code>WHERE</code> evaluation locally; if this list is empty, then the local server assumes the FDW will do the <code>WHERE</code> evaluation on the foreign server</p>
<h4 id="2-5-BeginForeignScan"><a href="#2-5-BeginForeignScan" class="headerlink" title="2.5 BeginForeignScan"></a>2.5 BeginForeignScan</h4><p>This routine will be called before starting the foreign scan, giving you a chance to allocate all the necessary control information required for your foreign scan. You can define your own control information, for example, cursor location, remote connection structure, current offset…etc. and store in <code>node-&gt;fdw_state</code> and it will be passed down to the <code>IterateForeignScan</code> as the scan is begin completed.</p>
<h4 id="2-6-IterateForeignScan"><a href="#2-6-IterateForeignScan" class="headerlink" title="2.6 IterateForeignScan"></a>2.6 IterateForeignScan</h4><p>This is the main routine to perform the actual scan. You need to put the proper logic here depending on your use case to fetch one or more rows from the foreign server. When you have the row data, you will need to convert that to a <code>TupleTableSlot</code> strucutre in which the PG internals can understand. We normally use <code>ExecStoreHeapTuple()</code> routine to convert a HeapTuple into a <code>TupleTableSlot</code>. This routine will be continuously called by the PG executor as long as you still have data to fetch and it will only stop once you return an empty <code>TupleTableSlot</code>.</p>
<h4 id="2-7-EndForeignScan"><a href="#2-7-EndForeignScan" class="headerlink" title="2.7 EndForeignScan"></a>2.7 EndForeignScan</h4><p>This routine will be called at the end of foreign scan, giving you the opportunity to clean up the control information allocated in <code>BeginForeignScan()</code>. This marks the end of foreign scan via FDW.</p>
<h3 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3. Summary"></a>3. Summary</h3><p>There is a lot of information and articals out there related to PostgreSQL’s FDW API interface. This blog is merely a quick summary of what I have learned during the FDW evaluation and there is much more to what’s discussed here. For more detail, you can refer to the official documentation about the FDW callback functons <a href="https://www.postgresql.org/docs/current/fdw-callbacks.html">here</a> </p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-sec-banner.png" alt="Understanding the Security Around PostgreSQL">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-08-06T19:04:08.000Z">2021-08-06</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 670 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/">Understanding the Security Around PostgreSQL</a>
            
        </h1>
        <div class="content">
            <h3 id="1-What-Is-Security"><a href="#1-What-Is-Security" class="headerlink" title="1. What Is Security?"></a>1. What Is Security?</h3><p>The word “Security” is a very broad concept and could refer to completely different procedures and methodology to achieve. Knowing what security means to your application is very important, so you could execute proper security practices and procedures to ensure the safety of your company’s assets. Data compromises could often lead to financial loss, reputation damage, consumer confidence disintegration, brand erosion, and non-compliance of government and industry regulation. </p>
<p>For this reason, the security on infrastructure software such as PostgreSQL is even more important because any data compromises could have nation or city-wide impacts, which are often difficult to completely recover.</p>
<h3 id="2-Common-Database-Compromises"><a href="#2-Common-Database-Compromises" class="headerlink" title="2. Common Database Compromises"></a>2. Common Database Compromises</h3><p>User Compromises:</p>
<ul>
<li>Excessive privileges</li>
<li>Privilege abuse</li>
<li>Weak user authentication</li>
<li>Weak password</li>
<li>Default privilege too open</li>
</ul>
<p>Data Compromises:</p>
<ul>
<li>Unmanaged and unprotected sensitive data</li>
<li>Backup data exposure</li>
<li>Stolen hard disks</li>
<li>Unmanaged encryption keys</li>
</ul>
<p>Network Compromises:</p>
<ul>
<li>Firewall rules</li>
<li>Deep Packet Inspection (DPS)</li>
<li>Vulnerability prevention</li>
<li>Denial of Service (DOS) attack</li>
</ul>
<p>Vulnerability:</p>
<ul>
<li>Software bug</li>
<li>Buffer overflow</li>
<li>SQL injection</li>
<li>Privileged escalation</li>
</ul>
<h3 id="3-The-Big-Picture"><a href="#3-The-Big-Picture" class="headerlink" title="3. The Big Picture"></a>3. The Big Picture</h3><p><img src="/images/thebigpicture.png" alt="img"></p>
<p>This picture shows different types of “security” around a PostgreSQL server and there are roughly 5 types of security concepts involved here:</p>
<h4 id="3-1-Data-Security-Over-Network"><a href="#3-1-Data-Security-Over-Network" class="headerlink" title="3.1 Data Security (Over Network)"></a>3.1 Data Security (Over Network)</h4><p>This is the security in the communication between PostgreSQL client and server that we almost always want to use TLS to encrypt the data communication in a production environment. TLS guarantees the mutual trust between the client and the server so each side is sure that it is communicating with the right entity instead of a rogue server. SSH tunneling is also a common option to secure a psql connection when TLS is not fully set up. SSH tunneling is also very secure as each connection forces client and server to generate and agree on an encryption key that is valid only for that session. Furthermore, SSH tunneling can be made more secured by setting up the public and private key pair between client and server to ensure the authenticity of the two entities. </p>
<h4 id="3-2-Data-Security"><a href="#3-2-Data-Security" class="headerlink" title="3.2 Data Security"></a>3.2 Data Security</h4><p>This is the security between PostgreSQL and the disk in which it writes data to. This security type is often refereed as a “Cluster Data Encryption” or “Transparent Data Encryption”. Current version of PostgreSQL does not support this feature but there is a handful of talented people working on this feature right now. This security is designed to prevent data compromises directly done on the hard disk. By encrypting the data on the disk, hard disk theft will not be able to extract useful information from the hard disk. </p>
<h4 id="3-3-Network-Security"><a href="#3-3-Network-Security" class="headerlink" title="3.3 Network Security"></a>3.3 Network Security</h4><p>This is the security that most likely will involve a firewall in between a connecting client and a server. The purpose of a firewall is to block most of the malicious connections coming from the public network and prevent unauthorized access to the server. Most advanced firewalls such as an IPS can block DOS attacks and perform deep packet examination according to a database of known malicious packet and attacks. There are also firewalls such as an IDS that perform network monitoring only and will raise alert to the operator should it detects an attack attempt.</p>
<h4 id="3-4-Vulnerability"><a href="#3-4-Vulnerability" class="headerlink" title="3.4 Vulnerability"></a>3.4 Vulnerability</h4><p>This is the security that is mostly caused by a software bug that allows an attacker to take advantage of the server, steal data, or simply out a stop to the server and cause damage. The best way to prevent this is upgrade your PostgreSQL server to the latest version that has addressed most of the known vulnerabilities.</p>
<h4 id="3-5-User-Security"><a href="#3-5-User-Security" class="headerlink" title="3.5 User Security"></a>3.5 User Security</h4><p>This is the security that relates mostly to the user management, sometimes called a Role-Based Access Control (RBAC). This is where a database administrator is managing each database user and setting the right privileges for the right users. Excessive privileges, weak passwords and privilege abuses are very common if not done correctly. Make sure the right users get the right privileges and use a third party authentication servers such as LDAP or Kerberos instead of simple passwords can significantly increase the security ratings of your database infrastructure.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/" class="image is-7by1">
            <img class="thumbnail" src="/images/gdb-debug-banner.png" alt="Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-07-09T18:41:55.000Z">2021-07-09</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 minutes read (About 1372 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/">Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>I am working on a new PostgreSQL feature that redefines the way a tuple’s visibility status is determined. The feature is working very nicely until I start doing a large SELECT query, which triggers PostgreSQL to spawn multiple parallel workers to process the request. When this happens, the feature I am working on start to yield incorrect results. A good portion of the data tuples returned are missing because they are considered as invisible, while some portion of it remains visible. It immediately came to my attention that the new feature I am working on does not work in parallel worker mode and somehow I need to find a way to debug into a spawned parallel worker to examine how it is computing the visibility and what is missing inside.</p>
<p>In this blog, I would like to share with you how I use GDB to debug and trace into a new parallel worker spawned by Postmaster in order to fix the visibility issue.</p>
<h3 id="2-GDB-Basics"><a href="#2-GDB-Basics" class="headerlink" title="2. GDB Basics"></a>2. GDB Basics</h3><p>I wrote another blog previously that shows how to use GDB to trace and debug a PostgreSQL issues and share some of the most common commands that I use every day to resolve software issues. If you are new to GDB, I suggest giving this blog a read <a href="https://www.highgo.ca/2020/11/07/how-to-analyze-a-postgresql-crash-dump-file/">here</a></p>
<h3 id="3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker"><a href="#3-How-and-When-does-PG-Spawn-A-New-Parallel-Worker" class="headerlink" title="3. How and When does PG Spawn A New Parallel Worker"></a>3. How and When does PG Spawn A New Parallel Worker</h3><p>When you use <code>psql</code> to connect to a PostgreSQL database, it will spawn a new backend worker process to serve this connecting client. Most of the queries you provide will be processed by this backend process, includes SELECT, UPDATE, INSERT…etc. By default, if your SELECT query will require doing a sequential scan over 8MB of data, it will try to use a parallel worker to help speed up the processing. This 8MB threshold can be configured by the <code>min_parallel_table_scan_size</code> parameter in <code>postgresql.conf</code> . There is another configuration parameter <code>max_parallel_workers</code> that controls the maximum number of parallel workers is allowed to be spawned. The default is 8. </p>
<p>Technically, I can avoid my visibility issues simply by either setting <code>min_parallel_table_scan_size</code> to a huge number, or setting <code>max_parallel_workers</code> to 0. But this is really not my style, I would like to keep all these goodies that PG provides while being able to solve the problem. </p>
<p>To spawn a parallel worker, the psql backend will initialize a parallel worker context in the global process table and a message queue based on shared memory for communication with the backend. Then it sends a signal to postmaster to notify that the global process table has been updated. </p>
<p>When postmaster receives the signal, it will load the global process table and found that it needs to spawn a new parallel worker. It will proceed to <code>fork</code> a new parallel worker according to the context information supplied. This information determines the entry point for the parallel worker and what to do once spawned. During processing, the parallel worker and the psql backend use the message queue to communicate tuples back and forth and finally the psql backend will gather together all the data tuples and produce a final result back to the user.</p>
<h3 id="4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned"><a href="#4-Can-We-Use-GDB-to-attach-This-Parallel-Worker’s-PID-When-Spawned" class="headerlink" title="4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?"></a>4. Can We Use GDB to attach This Parallel Worker’s PID When Spawned?</h3><p>Technically yes, but the life time of this parallel worker may be very short, by the time you see its PID from the <code>ps -ef</code> command, the worker may have already done its job and exited. This means, it is too late for me to start GDB and attach to its PID. </p>
<p>Instead, the technique I am going to show you today will trace the parallel worker from the moment it starts. </p>
<h3 id="5-Tracing-the-Parallel-Worker"><a href="#5-Tracing-the-Parallel-Worker" class="headerlink" title="5. Tracing the Parallel Worker"></a>5. Tracing the Parallel Worker</h3><p>I will be using this instance of PostgreSQL server (version 12.5) as an example where PID 11976 is the psql backend process serving the psql client. </p>
<p><img src="/images/mypids.png" alt="img"></p>
<h4 id="Pre-Condition"><a href="#Pre-Condition" class="headerlink" title="Pre-Condition:"></a>Pre-Condition:</h4><p>Connect psql to the PostgreSQL server, create an example table and inserted about 2.5M rows of data. This will for sure trigger parallel workers.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ psql -d postgres -U postgres -p 6660</span><br><span class="line">psql (12.5)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create table test(a int, b int);</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;# insert into test values(generate_series(1,500000),1);</span><br><span class="line">INSERT 0 500000</span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>

<h4 id="Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point"><a href="#Step-1-Attach-GDB-to-the-psql-backend-having-PID-11976-and-Set-a-Break-Point" class="headerlink" title="Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point"></a>Step 1: Attach GDB to the psql backend having PID = 11976 and Set a Break Point</h4><p>I am setting a break point at the function <code>RegisterDynamicBackgroundWorker</code>. This is called when parallel worker is required to complete the query. Setting a breakpoint allows us more control as to when to proceed with a parallel worker spawn. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11976</span><br><span class="line">(gdb) b RegisterDynamicBackgroundWorker</span><br></pre></td></tr></table></figure>


<h4 id="Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points"><a href="#Step-2-Attach-GDB-to-the-Postmaster-having-PID-11959-and-Set-2-Break-Points" class="headerlink" title="Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points"></a>Step 2: Attach GDB to the Postmaster having PID = 11959 and Set 2 Break Points</h4><p>We are using a second GDB to attach to the postmaster and set 2 break points there. <code>fork_process</code> is the function before postmaster actually spawns a new parallel worker using the system <code>fork()</code> call.  <code>ParallelWorkerMain</code> is the main function for the parallel worker after it has been spawned. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb postgres</span><br><span class="line">(gdb) attach 11959</span><br><span class="line">(gdb) b fork_process</span><br><span class="line">(gdb) b ParallelWorkerMain</span><br></pre></td></tr></table></figure>

<h4 id="Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points"><a href="#Step-3-Execute-a-Large-SELECT-Query-On-psql-To-Trigger-the-Break-Points" class="headerlink" title="Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points"></a>Step 3: Execute a Large SELECT Query On psql To Trigger the Break Points</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postgres&#x3D;# select count(*) from test;</span><br></pre></td></tr></table></figure>

<p>The <code>RegisterDynamicBackgroundWorker</code> break point will be hit on the first GDB session having attached PID = 11959</p>
<p>Use the <code>continue</code> or <code>c</code> GDB command to continue to spawn the worker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, RegisterDynamicBackgroundWorker (worker&#x3D;0x7ffd867f3c80, handle&#x3D;0x55a009b77388) at bgworker.c:1002</span><br><span class="line">1002            bool            success &#x3D; false;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>

<p>As you continue the first GDB session, the second GDB session will pause due to receipt of a <code>SIGUSR1</code> signal. This signal tells postmaster to reload the global process table and then spawn a parallel worker. Using the <code>continue</code> command will hit the first break point at <code>fork_process</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Program received signal SIGUSR1, User defined signal 1.</span><br><span class="line">0x00007f301b97d0f7 in __GI___select (nfds&#x3D;5, readfds&#x3D;0x7ffd867f47d0, writefds&#x3D;0x0, exceptfds&#x3D;0x0, timeout&#x3D;0x7ffd867f4740)</span><br><span class="line">    at ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c:41</span><br><span class="line">41      in ..&#x2F;sysdeps&#x2F;unix&#x2F;sysv&#x2F;linux&#x2F;select.c</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, fork_process () at fork_process.c:47</span><br><span class="line">47              fflush(stdout);</span><br><span class="line"></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent"><a href="#Step-4-Tell-Postmaster-GDB-To-Follow-Child-Process-Instead-Of-Parent" class="headerlink" title="Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent"></a>Step 4: Tell Postmaster GDB To Follow Child Process Instead Of Parent</h4><p>At this point, the postmaster GDB is now waiting at the <code>fork_process</code> call, which is right before spawning a parallel worker. This is a good time now to tell GDB to follow the child process instead of staying at parent when the process calls <code>fork()</code>. The reason we want to set this late at this moment is because postmaster is occasionally  spawning other backend processes such as <code>walsender</code> and <code>walreceiver</code>. Setting to follow child process early may cause our GDB to follow to another backend process that we are not interested in.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) set follow-fork-mode child</span><br></pre></td></tr></table></figure>

<p>You may use the <code>continue</code> command after setting it to follow child. Then immediately the GDB will switch to the new child process having PID = 12198 below and hit our second break point <code>ParallelWorkerMain</code>. So, Now the GDB is debugging the parallel worker process instead of the original postmaster.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 12198]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">[Switching to Thread 0x7f301ca79740 (LWP 12198)]</span><br><span class="line"></span><br><span class="line">Thread 2.1 &quot;postgres&quot; hit Breakpoint 2, ParallelWorkerMain (main_arg&#x3D;1544458234) at parallel.c:1207</span><br><span class="line">1207    &#123;</span><br></pre></td></tr></table></figure>

<h4 id="Step-5-Continue-To-Debug-The-Parallel-Process"><a href="#Step-5-Continue-To-Debug-The-Parallel-Process" class="headerlink" title="Step 5: Continue To Debug The Parallel Process"></a>Step 5: Continue To Debug The Parallel Process</h4><p>Using the <code>ps -ef | grep postgres</code> command, we can see a new parallel worker being spawned having PID = 12198</p>
<p><img src="/images/mypids2.png" alt="img"></p>
<p>At this point, you are free to explore the process flow of the parallel worker. For me, I am debugging the visibility issues, so I will set additional break points at <code>HeapTupleSatisfiesMVCC</code> and <code>TransactionIdIsCurrentTransactionId</code>. In your case, you may be debugging some other functionalities. </p>
<p>Being able to debugging into a parallel worker with GDB allows me to see the problems I was having and being able to fix quickly.</p>
<p>If you are having trouble tracing into a parallel workers spawned by PostgreSQL during run time, I hope this blog will be helpful to you.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/" class="image is-7by1">
            <img class="thumbnail" src="/images/banner-2021-03-03.png" alt="How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-03-03T20:17:11.000Z">2021-03-03</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 minutes read (About 1846 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/">How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>As an experienced PostgreSQL user, you may have a lot of experience in setting up streaming replication in your database clusters to make multiple backups of your data. But have you wondered how the standby is able to correctly determine if a tuple sent from the primary should be visible to the user or not. In the case where a transaction contains multiple subtransactions, how does the standby determine the visibility in this case? You might say… well it is PostgreSQL so it will just work… This is true. If you are someone who is curious and interested in knowing how PostgreSQL does certain things internally, then this blog may be interesting for you as we will talk about normally transaction and subtransactions and how both affect the standby’s ability to determine tuple visibility.</p>
<h3 id="2-How-is-Tuple-Visibility-Determined"><a href="#2-How-is-Tuple-Visibility-Determined" class="headerlink" title="2. How is Tuple Visibility Determined?"></a>2. How is Tuple Visibility Determined?</h3><p>PostgreSQL determines a tuple’s visibility based on the concept of transaction ID (a.k.a <code>txid</code>) and it is normally stored in a tuple’s header as either <code>xmin</code> or <code>xmax</code> where <code>xmin</code> holds the <code>txid</code> of the transaction that inserted this tuple and <code>t_xmax</code> holds the <code>txid</code> of the transaction that deleted or updated this tuple. If a tuple has not been deleted, its <code>t_xmax</code> is 0. There is also another mechanism called commit log (a.k.a <code>clog</code>) where it has information of currently active transaction IDs. When an inserted tuple has a valid <code>t_xmin</code> and invalid <code>t_xmax</code>, PostgreSQL will have to consult the <code>clog</code> first to determine if the <code>txid</code> stored in <code>t_xmin</code> is visible or not, then the result will be stored in the tuple’s <code>hint_bit</code> field about the visibility information such that it does not always have to consult the <code>clog</code> which could be resource intensive. If a tuple has a valid <code>t_xmax</code>, then there is no need to consult the <code>clog</code> as the tuple must be invisible. </p>
<p>This is just the basic ideas of how visibility is determined but it is enough for me to continue with this blog. For more information about visibility, you could refer to this <a href="http://www.interdb.jp/pg/pgsql05.html#_5.7.">resource</a></p>
<h3 id="3-What-is-a-Subtransaction"><a href="#3-What-is-a-Subtransaction" class="headerlink" title="3. What is a Subtransaction?"></a>3. What is a Subtransaction?</h3><p>As the name suggests, it is a smaller transaction that exists within a regular transaction and it can be created using the <code>SAVEPOINT</code> keyword after your <code>BEGIN</code> statement. Normally, when you have issued a <code>BEGIN</code> statement, all the tuples created from the subsequent DML statements such as <code>INSERT</code> or <code>UPDATE</code> will have a <code>txid</code> associated with these tuples and they will all be the same. </p>
<p>When you issue a <code>SAVEPOINT</code> statement within this transaction, all the tuples created from the subsequent DML statements will have a different <code>txid</code> that is normally larger than the main transaction’s <code>txid</code>. When you issue the <code>SAVEPOINT</code> statement again, the <code>txid</code> changes again. </p>
<p>The advantage of Subtransaction is that in a very large transaction, the entire transaction will not be aborted due to an error. It allows you to rollback to the previously created <code>SAVEPOINT</code> and continue to execute the main transaction. </p>
<p>The biggest difference between a subtransaction and a regular transaction is that there is not a concept of <code>commit</code> associated with subtransactions and it will not be recorded in the WAL file. However, if subtransaction is aborted, it will be recorded in the WAL file and subsequently be sent to the standby.</p>
<h3 id="4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction"><a href="#4-How-Does-a-Standby-Determines-Visibility-Information-In-a-Regular-Transaction" class="headerlink" title="4. How Does a Standby Determines Visibility Information In a Regular Transaction?"></a>4. How Does a Standby Determines Visibility Information In a Regular Transaction?</h3><p>Here’s an example of a regular transaction without any subtransactions:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In a general case, the above queries will send at least 4 WAL records to the standby during streaming replication. First 3 contain the actual tuple information with <code>t_xmin</code> set to the current transaction ID which is 500 in the example. In other words, before the <code>COMMIT</code> is issued, the standby should have already received 3 WAL records from primary and completed the redo, meaning that the 3 tuples already exist in standby’s memory buffer. However, they are not visible yet because transaction ID 500 does not exist in the standby. It is until the <code>COMMIT</code> is issued in the primary that will subsequently generate a <code>XLOG_XACT_COMMIT</code> WAL record to be sent to standby to notify that transaction ID 500 is now committed and valid. When standby receives the <code>XLOG_XACT_COMMIT</code> WAL record, it will eventually update to its <code>clog</code> so the subsequent <code>SELECT</code> queries can do visibility check against. </p>
<h3 id="5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions"><a href="#5-How-Does-a-Standby-Process-Visibility-Information-In-a-Regular-Transaction-Containing-Subtransactions" class="headerlink" title="5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?"></a>5. How Does a Standby Process Visibility Information In a Regular Transaction Containing Subtransactions?</h3><p>Now, let’s use the same example but add some <code>SAVEPOINT</code> to create subtransactions</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>As you can see, after the creation of <code>SAVEPOINT</code>, the tuple’s <code>t_xmin</code> value will be changed and is no longer equal to the current transaction ID, which is 500 in the example. Before the <code>COMMIT</code> is issued, the standby should have received 9 WAL records, 3 having <code>t_xmin</code> = 500, 3 having <code>t_xmin</code> = 501 and 3 having <code>t_xmin</code> = 502. None of them is visible yet in the standby because these transaction IDs do not exist yet. When the primary issues the <code>COMMIT</code> statement, it will generate a <code>XLOG_XACT_COMMIT</code> WAL record and send to standby containing only the current transaction ID 500 without the 501 and 502. </p>
<p>After the commit, the standby is able to see all 9 tuples that are replicated from the primary. Now, you may be asking…. why? How come the standby knows that <code>txid</code> = 501 and 502 are also visible even though the primary never send a <code>XLOG_XACT_COMMIT</code> WAL record to tell the standby that 501 and 502 are also committed. Keep reading to find out.</p>
<p>Using the similar example, if we rollback to one of the SAVEPOINTs, the primary will send a XLOG_XACT_ABORT WAL record to notify the standby a transaction ID has become invalid.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">ROLLBACK TO SAVEPOINT B;  &#x3D;&gt; a XLOG_XACT_ABORT WAL record having t_xmin &#x3D; 502 is sent to standby</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby</span><br></pre></td></tr></table></figure>

<p>In this example, when doing a <code>ROLLBACK</code> to <code>SAVEPOINT</code> B, a XLOG_XACT_ABORT WAL record will be sent to the standby to invalidate that the transaction ID 502 is invalid. So when primary commits, records having <code>txid</code>=502 will not be visible as primary has notified.</p>
<h3 id="6-The-Secret-of-Standby’s-KnownAssignedTransactionIds"><a href="#6-The-Secret-of-Standby’s-KnownAssignedTransactionIds" class="headerlink" title="6. The Secret of Standby’s KnownAssignedTransactionIds"></a>6. The Secret of Standby’s KnownAssignedTransactionIds</h3><p>In addition to handling the XLOG_XACT_COMMIT and XLOG_XACT_ABORT WAL records to determine if a <code>txid</code> is valid or not, it actually manages a global <code>txid</code> list called <code>KnownAssignedTransactionIds</code>. Whenever a standby receives a heap_redo WAL record, it will save its <code>xmin</code> to <code>KnownAssignedTransactionIds</code>. Using the same example as above again here:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test VALUES(111,111111);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,222222);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,333333);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 500 is sent to standby, and standby puts 500 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT A;</span><br><span class="line">INSERT INTO test VALUES(111,444444);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,555555);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,666666);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 501 is sent to standby, and standby puts 501 in KnownAssignedTransactionIds</span><br><span class="line">SAVEPOINT B;</span><br><span class="line">INSERT INTO test VALUES(111,777777);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,888888);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">INSERT INTO test VALUES(111,999999);    &#x3D;&gt; a heap_redo WAL record having t_xmin &#x3D; 502 is sent to standby, and standby puts 502 in KnownAssignedTransactionIds</span><br><span class="line">COMMIT;   &#x3D;&gt; a XLOG_XACT_COMMIT WAL record having t_xmin &#x3D; 500 is sent to standby and standby submits 500, 501 and 502 to clog as valid.</span><br></pre></td></tr></table></figure>

<p>Before the <code>COMMIT</code> is issued on the primary, the standby already has <code>txid</code> 500, 501, and 502 present in the <code>KnownAssignedTransactionIds</code>. When the standby receives <code>XLOG_XACT_COMMIT WAL</code>, it will actually submit <code>txid</code> 500 from the WAL plus the 501 and 502 from <code>KnownAssignedTransactionIds</code> to the <code>clog</code>. So that the subsequent <code>SELECT</code> query consult the <code>clog</code> it will say <code>txid</code> 500, 501, and 502 are visible. If the primary sends <code>XLOG_XACT_ABORT</code> as a result of rolling back to a previous <code>SAVEPOINT</code>, that invalid <code>txid</code> will be removed from the <code>KnownAssignedTransactionIds</code>, so when the transaction commits, the invalid <code>txid</code> will not be submit to <code>clog</code>.</p>
<h3 id="7-Summary"><a href="#7-Summary" class="headerlink" title="7. Summary"></a>7. Summary</h3><p>So this is how PostgreSQL determines a tuple’s visibility within subtransactions in a streaming replication setup. Of course, there is more details to what is discussed here in this blog, but I hope today’s discussion can help you get a general understanding of how PostgreSQL determines the visibility and maybe it will help you in your current work on PostgreSQL.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/" class="image is-7by1">
            <img class="thumbnail" src="/images/tuple-insert-banner.png" alt="How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-02-02T19:35:31.000Z">2021-02-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1117 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/">How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>This blog talks about a high level description of the mechanism behind PostgreSQL to execute an <code>INSERT</code> query. This process involves many steps of processing before the data is put in the right place. These process normally involves several catalog cache lookup to determine if the destination table exists or several checking on the constraint violations..etc. This blog will mainly focus on the part where the processing handle is passed to the PostgreSQL’s table access method API and its interaction with buffer manager and WAL routines. This is also the core area where an <code>INSERT</code> query is actually executed. If you are a developer looking to understand how PostgreSQL works internally, this blog may be helpful to you…</p>
<h3 id="2-Table-Access-Method-APIs-in-PostgreSQL"><a href="#2-Table-Access-Method-APIs-in-PostgreSQL" class="headerlink" title="2. Table Access Method APIs in PostgreSQL"></a>2. Table Access Method APIs in PostgreSQL</h3><p>Pluggable table access method API has been made available since PostgreSQL 12, which allows a developer to redefine how PostgreSQL stores / retrieves table data. This API contains a total of 42 routines that need to be implemented in order to complete the implementation and honestly it is no easy task to understand all of them and to implement them. This API structure is defined in <code>tableam.h</code> under the name <code>typedef struct TableAmRoutine</code></p>
<p>Today I will describe the routines related to <code>INSERT</code>.</p>
<h3 id="3-INSERT-Query-Overall-Call-Flow"><a href="#3-INSERT-Query-Overall-Call-Flow" class="headerlink" title="3. INSERT Query Overall Call Flow"></a>3. INSERT Query Overall Call Flow</h3><p>A few of the 42 routines will be called by executor just to complete an <code>INSERT</code> query. This section will describe these routines in the order they are called.</p>
<h4 id="3-1-slot-callbacks"><a href="#3-1-slot-callbacks" class="headerlink" title="3.1 slot_callbacks"></a>3.1 slot_callbacks</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const TupleTableSlotOps *(*slot_callbacks) (Relation rel);</span><br></pre></td></tr></table></figure>
<p>The executor needs to find out which set of tuple table slot (TTS) callback operation this table access method is compatible with. TTS is a set of routines that ensures the tuple storage is compatible between the executor and your access method. The executor will execute the TTS callback to <code>translate</code> your tuple strucuture to <code>TupleTableSlot</code> format in which the executor will understand. The default <code>heap</code> access method uses <code>TTSOpsBufferHeapTuple</code> defined in <code>execTuples.c</code> to handle this operation</p>
<h4 id="3-2-heap-insert"><a href="#3-2-heap-insert" class="headerlink" title="3.2 heap_insert"></a>3.2 heap_insert</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void</span><br><span class="line">heap_insert(Relation relation, HeapTuple tup, CommandId cid,</span><br><span class="line">			int options, BulkInsertState bistate)</span><br></pre></td></tr></table></figure>
<p><code>heap_insert</code> is the entry point to perform the actual data insertion and it will undergo several other routines provided by <code>buffer manager</code> and <code>WAL module</code> in order to complete the insertion.</p>
<h5 id="heap-prepare-insert"><a href="#heap-prepare-insert" class="headerlink" title="heap_prepare_insert"></a>heap_prepare_insert</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static HeapTuple heap_prepare_insert(Relation relation, HeapTuple tup,</span><br><span class="line">									 TransactionId xid, CommandId cid, int options);</span><br></pre></td></tr></table></figure>
<p>This is a subroutine for <code>heap_insert</code> where it will initialize the tuple header contents such as relation OID, infomasks, xmin, xmax values. It will also determine if the tuple is too big that <code>TOAST</code> is required to complete the insertion. These terms and parameters are very technical in PostgreSQL. If you are not sure what exactly they are, you could refer to resources <a href="https://www.postgresql.org/docs/current/storage-toast.html">here</a> and <a href="https://www.postgresql.org/docs/current/ddl-system-columns.html">here</a>.</p>
<h5 id="RelationGetBufferForTuple"><a href="#RelationGetBufferForTuple" class="headerlink" title="RelationGetBufferForTuple"></a>RelationGetBufferForTuple</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern Buffer RelationGetBufferForTuple(Relation relation, Size len,</span><br><span class="line">										Buffer otherBuffer, int options,</span><br><span class="line">										BulkInsertStateData *bistate,</span><br><span class="line">										Buffer *vmbuffer, Buffer *vmbuffer_other);</span><br></pre></td></tr></table></figure>
<p>This is an entry function to access <code>buffer manager</code> resources and all it is doing is ask the <code>buffer manager</code> to return a <code>buffer ID</code> that can be used to store the target tuple. This may sound very straightforward, but there is quite a lot of processing on the buffer manager side to properly determine a desired buffer location. </p>
<p>First, it will do a quick size check. If the input tuple is larger than the size of each buffer block, it will return immediately with error as <code>TOAST</code> has to be used in this case. Then it will try to put the tuple on the same page the system last inserted the tuple on to see if it will fit there. If not, it will utilize the <code>free space map</code> to find another page that could fit tuple. If that does not work out, then buffer manage will allocate a new data page (also referred to as <code>extend</code>) to be used to hold this new tuple. As soon as we have a desired buffer page determined, buffer manager will cache this page in the <code>relation</code> structure such that next time the same relation visits the buffer manager, it knows immediately about the reference to the last inserted block. </p>
<h5 id="RelationPutHeapTuple"><a href="#RelationPutHeapTuple" class="headerlink" title="RelationPutHeapTuple"></a>RelationPutHeapTuple</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern void RelationPutHeapTuple(Relation relation, Buffer buffer,</span><br><span class="line">								 HeapTuple tuple, bool token);</span><br></pre></td></tr></table></figure>
<p>Once we have identified the location of the buffer to store the tuple, the insert routine will then call <code>RelationPutHeapTuple</code> to actually put the tuple in the specified buffer location. This routine will again ask the buffer manager to get a pointer reference to the data page using the buffer ID we obtained from <code>RelationGetBufferForTuple</code>, then add the tuple data using <code>PageAddItem()</code> routine. Internally in buffer manager, it manages the relationship between buffer ID, buffer descriptor and the actual pointer to the data page to help us correctly identify and write to a data page. After a successful write, the routine will save a <code>CTID</code> of the inserted tuple. This ID is the location of this tuple and it consists of the data page number and the offset. For more information about how buffer manager works, you can refer to the resource <a href="http://www.interdb.jp/pg/pgsql08.html">here</a></p>
<h5 id="Mark-buffer-dirty"><a href="#Mark-buffer-dirty" class="headerlink" title="Mark buffer dirty"></a>Mark buffer dirty</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern void MarkBufferDirty(Buffer buffer);</span><br></pre></td></tr></table></figure>
<p>At this point, the tuple data is already stored in the buffer manager referenced by a particular data page plus an offset, but it is not yet flushed to disk yet. In this case, we almost always will have to call <code>MarkBufferDirty</code> function to signal buffer manager that there are some tuples on the page that have not been flushed to disk and therefore in the next <code>checkpoint</code>, it will ensure the new tuples are flushed to disk.</p>
<h5 id="Insert-WAL-Record"><a href="#Insert-WAL-Record" class="headerlink" title="[Insert WAL Record]"></a>[Insert WAL Record]</h5><p>Last but not least, after doing all the hassle of finding a buffer location to put our tuple in and mark it as dirty, it is time for the <code>heap_insert</code> routine to populate a WAL record. This part is not the focus of this blog so I will skip the high level details of WAL writing.</p>
<h4 id="3-3-End-of-the-insertion"><a href="#3-3-End-of-the-insertion" class="headerlink" title="3.3 End of the insertion"></a>3.3 End of the insertion</h4><p>At this point the insertion of a new tuple data has finished and proper WAL record has been written. The routine will once again save the <code>CTID</code> value that we derived during the data insertion and save this value to the <code>TTS</code> structure so the executor also gets a copy of the location of the tuple. Then it will clean up the local resources before returning.</p>
<h3 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h3><p>What we have discussed here is the basic call flow of a simple sequential scan. If we were to visualize the process, it should look something like this:<br><img src="/images/tuple-insert.png" alt="tuple insert"></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2021/01/14/How-PostgreSQL-Executes-Sequential-Scans-with-the-Help-of-Table-Access-Methods-APIs/" class="image is-7by1">
            <img class="thumbnail" src="/images/seqscan.png" alt="How PostgreSQL Executes Sequential Scans with the Help of Table Access Methods APIs">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-01-14T22:27:59.000Z">2021-01-14</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1006 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/01/14/How-PostgreSQL-Executes-Sequential-Scans-with-the-Help-of-Table-Access-Methods-APIs/">How PostgreSQL Executes Sequential Scans with the Help of Table Access Methods APIs</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>There are many approaches for PostgreSQL to retrieve the data back to the user. Depending on the user’s input query, the planner module is responsible for selecting the most optimum approach to retrieve the requested data. Sequential scan is one of these approaches that is mostly selected when the user requests a large volume of data (for example, “SELECT * from tablename;”) or when a table has no index declared. Sequential scan is mostly handled by the table access method API within PostgreSQL and <code>heap</code> access method is the default one PostgreSQL uses today. In this short post, I will show you how sequential scan is done in the table access method API. </p>
<h3 id="2-Table-Access-Method-APIs-in-PostgreSQL"><a href="#2-Table-Access-Method-APIs-in-PostgreSQL" class="headerlink" title="2. Table Access Method APIs in PostgreSQL"></a>2. Table Access Method APIs in PostgreSQL</h3><p>Pluggable table access method API has been made available since PostgreSQL 12, which allows a developer to redefine how PostgreSQL stores / retrieves table data. This API contains a total of 42 routines that need to be implemented in order to complete the implementation and honestly it is no easy task to understand all of them and to implement them. This API structure is defined in <code>tableam.h</code> under the name <code>typedef struct TableAmRoutine</code></p>
<p>Today I will describe the routines related to sequential scan and I hope it could help you if you are someone looking to create your own table access method.</p>
<h3 id="3-Sequential-Scan-Overall-Call-Flow"><a href="#3-Sequential-Scan-Overall-Call-Flow" class="headerlink" title="3. Sequential Scan Overall Call Flow"></a>3. Sequential Scan Overall Call Flow</h3><p>Few of the 42 routines will be called by executor just to complete a sequential scan request. This section will describe these routines in the order they are called.</p>
<h4 id="3-1-relation-size"><a href="#3-1-relation-size" class="headerlink" title="3.1 relation_size"></a>3.1 relation_size</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uint64		(*relation_size) (Relation rel, ForkNumber forkNumber);</span><br></pre></td></tr></table></figure>
<p><code>relation_size</code> is the first routine to be called and it is relatively simple. The caller will expect the routine to return the total size of the relation described by <code>rel</code> and <code>forkNumber</code>. The default <code>heap</code> access method will simply invoke the storage manager <code>smgr</code> to find the number of data blocks this particular relation physically occupies on disk and multiplies that number with the size of each block <code>BLCKSZ</code> (default is 8k). If you are not sure about the relationship between relation and its fork number, you could refer to this <a href="https://www.highgo.ca/2020/10/23/free-space-mapping-file-in-details/">blog</a> to get more information. </p>
<p>The size returned by this routine basically sets the boundary of our sequential scan.</p>
<h4 id="3-2-slot-callbacks"><a href="#3-2-slot-callbacks" class="headerlink" title="3.2 slot_callbacks"></a>3.2 slot_callbacks</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const TupleTableSlotOps *(*slot_callbacks) (Relation rel);</span><br></pre></td></tr></table></figure>
<p>Next, the executor needs to find out which set of tuple table slot (TTS) callback operation this table access method is compatible with. TTS is a set of routines that ensures the tuple storage is compatible between the executor and your access method. The executor will execute the TTS callback to <code>translate</code> your tuple strucuture to <code>TupleTableSlot</code> format in which the executor will understand. The default <code>heap</code> access method uses <code>TTSOpsBufferHeapTuple</code> defined in <code>execTuples.c</code> to handle this operation</p>
<h4 id="3-3-scan-begin"><a href="#3-3-scan-begin" class="headerlink" title="3.3 scan_begin"></a>3.3 scan_begin</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TableScanDesc (*scan_begin) (Relation rel,</span><br><span class="line">							 Snapshot snapshot,</span><br><span class="line">							 int nkeys, struct ScanKeyData *key,</span><br><span class="line">							 ParallelTableScanDesc pscan,</span><br><span class="line">							 uint32 flags);</span><br></pre></td></tr></table></figure>
<p>Now the scan can officially begin. This is sequential scan’s initialization routine in which it will allocate a new scan descriptor using the parameters passed in by the executor. The purpose of scan descriptor structure is to keep track of the sequential scan while it is being executed. For example, to track where the scan should begin,; when was the block number of the last scan; which block should we resume scanning and how many blocks have been scanned…etc. scan descriptor will be destroyed once the sequential scan has completed.</p>
<p>The executor expects the routine to return a fully allocated and initialize pointer to <code>TableScanDesc</code> struct</p>
<h4 id="3-4-scan-getnextslot"><a href="#3-4-scan-getnextslot" class="headerlink" title="3.4 scan_getnextslot"></a>3.4 scan_getnextslot</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bool		(*scan_getnextslot) (TableScanDesc scan,</span><br><span class="line">								 ScanDirection direction,</span><br><span class="line">								 TupleTableSlot *slot);</span><br></pre></td></tr></table></figure>
<p>This is the main routine for sequential scan where the caller expects the routine to fetch one tuple from the buffer manager, converts it to the TTS format in which executor understands and save it in the input pointer called <code>slot</code>. Each call to this routine will results in one tuple to be returned. If a table contains 1000 tuples, this function will be called 1000 times. The boolean return code is the indication to the caller if the routine has more tuples to return, as soon as <code>false</code> is returned, it signals the executor that we have exhausted all the tuples and it should stop calling this function.</p>
<p>In normal sequential scan case, this routine works in per-page mode. This means it will read one full block from buffer manager and scan it to get all the tuple addresses and their offsets in the scan descriptor, so in the subsequent calls to the same function, it will not load the full page again from buffer manage all the time; it will only start to load the next block when all the tuples on the current block have been scanned and returned. </p>
<p>As you can see, the scan descriptor plays an important role here as most of the control information is saved there and is regularly updated whenever a call the <code>scan_getnextslot</code> is made.</p>
<h4 id="3-5-scan-end"><a href="#3-5-scan-end" class="headerlink" title="3.5 scan_end"></a>3.5 scan_end</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void		(*scan_end) (TableScanDesc scan);</span><br></pre></td></tr></table></figure>
<p>This is the last routine to be called to basically clean up the table scan descriptor, which was used heavily during the sequential scan. At this point, the executor should already have all the tuple information from the sequential scan methods. </p>
<h3 id="4-Prepare-the-Data-to-Return"><a href="#4-Prepare-the-Data-to-Return" class="headerlink" title="4. Prepare the Data to Return"></a>4. Prepare the Data to Return</h3><p>Now, the executor is finished with the table access method and has already had access to all the tuples for a particular relation. It then needs to go through another round of filtering to determine which of these tuples satisfy the condition set by the user, (for example, when user gives the WHERE clause to limit the scan results). This is done in another infinite <code>for</code> loop in <code>execScan.c</code> to perform <code>ExecQual</code> on each TTS. Finally, the end results will be sent to the end user.</p>
<h3 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h3><p>What we have discussed here is the basic call flow of a simple sequential scan. If we were to visualize the process, it should look something like this:<br><img src="/images/sequential-scan.png" alt="Sequential Scan"></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2020/11/27/2020%20PG%20Asia%20Conference%20Ended%20Successfully%20at%20an%20Unprecedented%20Scale!/" class="image is-7by1">
            <img class="thumbnail" src="/images/pgconf2020banner.webp" alt="2020 PG Asia Conference Ended Successfully at an Unprecedented Scale!">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-11-27T19:21:47.000Z">2020-11-27</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    17 minutes read (About 2480 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2020/11/27/2020%20PG%20Asia%20Conference%20Ended%20Successfully%20at%20an%20Unprecedented%20Scale!/">2020 PG Asia Conference Ended Successfully at an Unprecedented Scale!</a>
            
        </h1>
        <div class="content">
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>On November 17-20, 2020, PostgresConf.CN &amp; PGconf.Asia2020 (referred to as 2020 PG Asia Conference) was held online for the very first time! This conference was jointly organized by the PG China Open Source Software Promotion Alliance, PostgresConf International Conference Organization, and PGConf.Asia Asian Community. This conference was broadcast exclusively via the Modb Technology Community platform in China with a record-high number of viewers streaming the conference events. With the great support from these PostgreSQL communities, the conference was held with great success, which brought together the Chinese PG power, major Asian PG contributors and many PostgreSQL experts worldwide to build the largest PG ecosystem in Asia.</p>
<h2 id="About-the-Conference"><a href="#About-the-Conference" class="headerlink" title="About the Conference"></a>About the Conference</h2><p>Also known as the Asia’s largest open source relational database ecology conference</p>
<p>PostgresConf.CN and PGConf.Asia, for the very first time, were hosted together as one conference online accompanied by additional offline sessions hosted at several reputable university campuses in China. </p>
<p>PostgresConf.CN is an annual conference held by the China PostgreSQL Association for PostgreSQL users and developers. It is also one of the conference series held by PostgresConf Organization. PostgreConf.CN 2019 took place in Beijing, it was very well attended by PostgreSQL users and community members across the globe.</p>
<p>PGCONF.Asia is also an annual PostgreSQL event that took place in Bali Indonesia in 2019, it was a continuation of the PGCONF.Asia event that took place in Tokyo, Japan in 2018. The first PGCONG.Asia conference took place in 2016 in Tokyo, this conference acts as a hub of PostgreSQL related development and technical discussion among PostgreSQL users and developers in the region as well as experts from around the globe.</p>
<p>Learn more about these conferences and the organizers from these resources:</p>
<ul>
<li><a href="https://2020.postgresconf.cn/en">2020.postgresconf.cn</a></li>
<li><a href="https://2020.pgconf.asia">2020.pgconf.asia</a></li>
<li><a href="https://www.postgresconf.org">PostgresConf</a></li>
</ul>
<h2 id="Sponsors"><a href="#Sponsors" class="headerlink" title="Sponsors"></a>Sponsors</h2><p>This conference was sponsored by:</p>
<p><strong>Platinum</strong>:</p>
<ul>
<li><a href="https://www.aliyun.com/">Alibaba Cloud</a></li>
<li><a href="https://cloud.tencent.com/">Tencent Cloud</a></li>
<li><a href="https://www.enterprisedb.com/">EDB</a></li>
<li><a href="https://www.highgo.com/">HighGo Software</a></li>
</ul>
<p><strong>Golden</strong>:</p>
<ul>
<li><a href="http://www.inspurpower.com/">Inspur Power Systems</a></li>
</ul>
<p><strong>Silver</strong>:</p>
<ul>
<li><a href="https://equnix.asia/">Equnix Business Solutions</a></li>
</ul>
<h2 id="14-Conference-Channels-over-4-Days"><a href="#14-Conference-Channels-over-4-Days" class="headerlink" title="14 Conference Channels over 4 Days!"></a>14 Conference Channels over 4 Days!</h2><p>The conference lasted 4 days at an unprecedented scale. A total of 14 channels, including 5 technical training + 9 main/sub-forum training channels. </p>
<ul>
<li>Alibaba Cloud Database Training Session </li>
<li>Tencent Cloud Database Training Session</li>
<li>HighGo Software Training Session</li>
<li>PG Training Institution Charity Session </li>
<li>PostgresConf Orgnization English Training Session (1 Day)</li>
<li>the main forum (2 days)</li>
<li>Chinese sub-forum (2 days)</li>
<li>English sub-forum A (2 days)</li>
<li>English sub-forum B (2 days) </li>
<li>CCF advanced academic forum (1 day) </li>
</ul>
<h2 id="Over-100-Participating-Experts-and-Scholars-Around-the-World"><a href="#Over-100-Participating-Experts-and-Scholars-Around-the-World" class="headerlink" title="Over 100 Participating Experts and Scholars Around the World"></a>Over 100 Participating Experts and Scholars Around the World</h2><p> The number of invited speakers for this conference has set a new record. With the theme of “Born into the World”, the conference gathered 112 technical presentations and more than 100 well-known experts and scholars around the world to provide a grand technical feast for all the participating PGers.</p>
<ul>
<li>Guangnam Ni, Fellow of the Chinese Academy of Engineering</li>
<li>Peng Liu, Vice chairman of China Open Source Software Promotion Alliance and researcher of the Chinese Academy of Sciences</li>
<li>Zhiyong Peng, deputy director of the database committee of the Chinese Computer Society</li>
<li>Bruce Momjian, co-founder of PostgreSQL international community and vice president of EDB</li>
<li>Peter Zaitsev, Founder and CEO of Percona</li>
<li>Tatsuo Ishii, the original author of Pgpool-ll and founders of PGconf.asian and Japanese PG user association</li>
<li>Experts from from Alibaba, Tencent, Amazon, JD.com, Inspur, Ping An, Suning, ZTE, HornetLab, Equnix, VMware Greenplum, yMatrix, HighGo Software, Yunhe Enmo, Percona, EDB, NTT, Postgres Professional, Fujitsu, AsiaInfo, Giant Sequoia, Mechuang, Wenwu, Guoxin Sinan, Hytera, Airwallex, Ottertune and many others.</li>
<li>Professors from Wuhan University, East China Normal University, Harbin Institute of Technology, Shandong University, CCF (China Computer Society) database committee members of Tianjin University</li>
<li>Professional lecturers from 10 well-known authorized PG training service providers</li>
<li>And many, many more!</li>
</ul>
<h2 id="Record-High-LIVE-Streaming-Viewers"><a href="#Record-High-LIVE-Streaming-Viewers" class="headerlink" title="Record High LIVE Streaming Viewers"></a>Record High LIVE Streaming Viewers</h2><p>The number of LIVE streaming viewers at this conference has also hit a new record. Each channel accumulated over 30,000 active LIVE streams, the official conference blog views accumulated over 50,000+ views, and the news reports and articles from media exceeded over 3,000 entries. </p>
<h2 id="Conference-Highlights"><a href="#Conference-Highlights" class="headerlink" title="Conference Highlights"></a>Conference Highlights</h2><p>PostgresConf is an annual event for PostgreSQL developers and users worldwide. This conference attracted core members from the global PostgreSQL community, as well as corporate and individual users who use PostgreSQL.</p>
<p>The PGConf.Asia conference went smoothly for 4 days and it attracted many domestic and foreign audiences worldwide to join the LIVE streaming channels. The conference has 100+ subject sharing sessions, and each session on average accumulated 30,000+ active streams.</p>
<p>The first two days of the conference, several leading internet service vendors such as Alibaba Cloud, Tencent Cloud and database vendor HighGo Software brought a series of rich technical contents related to PostgreSQL, providing tremendous amount of values to the audiences who are willing to learn PostgreSQL database technology</p>
<p>The third and fourth days of the conference consist of numerous technical presentations covering wide range of area of technical interests.</p>
<p>Let’s take a look at some of the highlights of the conference!</p>
<h3 id="Opening-Speech-by-Fellow-Guangnam-Ni"><a href="#Opening-Speech-by-Fellow-Guangnam-Ni" class="headerlink" title="Opening Speech by Fellow Guangnam Ni"></a>Opening Speech by Fellow Guangnam Ni</h3><p><img src="/images/guangnan-li.webp" alt="Guangnam Ni"><br>The conference was kick-started by an opening speech by Guangnan Ni, fellow of the Chinese Academy of Engineering and the leader of China’s basic software industry. Fellow Ni first expressed his warm congratulations on the holding of the conference and sincere greetings to the representatives of the participating countries and open source experts. He pointed out that open source is an important trend in today’s world development, and it is profoundly changing the global digital economy and information industry. </p>
<p>This conference brings great value to the development of the open source industry, promotes the open source movement and popularization of open source culture in Chin and also strengthens international exchanges and cooperation. Fellow Ni hopes to use the PGConf Asia Conference platform to realize intellectual exchanges between Asia and the world, achieve higher and higher levels of global cooperation, and contribute to the development of global open source technology. Finally, Fellow Ni wished the conference a complete success, and wished the PG open source ecosystem more prosperity! *”I wish the Chinese PG branch and the Asian PG community prosper and get better and better!”*</p>
<h3 id="Peng-Liu"><a href="#Peng-Liu" class="headerlink" title="Peng Liu"></a>Peng Liu</h3><p>Peng Liu, executive vice chairman of China Open Source Software Promotion Alliance and researcher at the Institute of Software and Chinese Academy of Sciences, delivered a speech on behalf of COPU. He pointed out that based on the open BSD license + decentralized ecological architecture, PostgreSQL has a permanent security guarantee in the past, present and future. Following the spirit of free software &amp; complying with the BSD open source agreement, PostgreSQL meets the most stringent security compliance audits, and is not subject to US technology export control jurisdiction restrictions (Long Arm Jurisdiction Limitations/US Export Controls). PostgreSQL is a recognized global technology with public property rights and countless global PG contributors are committed to promoting the free and democratic software movement to protect the rights of anyone who obtain and use such software.<br><img src="/images/peng-liu.webp" alt="Peng Liu"></p>
<h3 id="Bruce-Momjian"><a href="#Bruce-Momjian" class="headerlink" title="Bruce Momjian"></a>Bruce Momjian</h3><p>Bruce Momjian, co-founder of the PostgreSQL international community and vice president of EDB, shared “Will Postgres Live Forever” speech. He said that any business has its life cycle, and open source PG is no exception, but compared to closed source commercial software, the life cycle of open source software will have more vitality. As long as the source code is valuable, it can always get a new life. In 1996, Postgres got a new life due to the introduction of the SQL standard and the improvement of its functions. The development trend continues to rise today.</p>
<p><img src="/images/bruce-momjian.webp" alt="Bruce Momjian"><br><img src="/images/bruce-momjian-2.webp" alt="Bruce Momjian"></p>
<h3 id="Tatuso-Ishii"><a href="#Tatuso-Ishii" class="headerlink" title="Tatuso Ishii"></a>Tatuso Ishii</h3><p>PGconf.Asia and Tatsuo Ishii, the founder of the Japanese PG User Association and the original author of Pgpool-ll, shared “Wonderful PostgreSQL!”. Tatsuo Ishii wrote the WAL system by himself based on Gray’s business thesis, and his creativity is admirable.<br><img src="/images/tatsuo-ishii.webp" alt="Tatsuo Ishii"></p>
<h3 id="Peter-Zaitsev"><a href="#Peter-Zaitsev" class="headerlink" title="Peter Zaitsev"></a>Peter Zaitsev</h3><p>Percona CEO Peter Zaitsev made a sharing of “The Changing Landscape of Open Source Databases”. He summarized several key points such as distributed, cloud native, storage and computing separation, and hardware acceleration, which basically covered the main focuses of the current database technology development.</p>
<p><img src="/images/peter-zaitsev.webp" alt="Peter Zaitsev"><br><img src="/images/peter-zaitsev-2.webp" alt="Peter Zaitsev"><br><img src="/images/peterz2.png" alt="Peter Zaitsev"></p>
<h3 id="Zhiyong-Peng"><a href="#Zhiyong-Peng" class="headerlink" title="Zhiyong Peng"></a>Zhiyong Peng</h3><p>Professor Peng Zhiyong, deputy director of the database committee of CCF China Computer Society, deputy dean of the School of Computer Science of Wuhan University, made a sharing of “My Way from PG to TOTEM”. Professor Peng talked about his 30-years of database research, from leading students to in-depth PG source code research database models, to compiling PG kernel analysis textbooks, to the development of the totem (TOTEM) database.<br><img src="/images/zhiyong-peng.webp" alt="Zhiyong Peng"></p>
<p>As we all know, PG originated from the University of California, Berkeley. This conference was also fortunate enough to have invited Professor Peng from Wuhan University. Professor Peng has been deeply involved in the PG database for more than 30 years and has led students to in-depth PG source code research database model, to write PG kernel and analysis book. Eventually created the totem (TOTEM) database based on PG. Peng has made outstanding contributions to PostgreSQL talent training and research!</p>
<p><img src="/images/zhiyong-peng-2.webp" alt="Zhiyong Peng"></p>
<h3 id="Guoqiang-Gai"><a href="#Guoqiang-Gai" class="headerlink" title="Guoqiang Gai"></a>Guoqiang Gai</h3><p>Guoqiang Gai, the founder of Enmotech, gave a speech on “Observing the elephant: the skills migration from Oracle to PostgreSQL DBA”. Gai gave a principle analysis from a source code perspective through a typical PG rollback problem, encouraging everyone to play with open source databases to learn the source code deeply, emphasizing that DBA is essential to enterprise data management, and every DBA must pass self-employment training to reflect personal value.<br><img src="/images/guoqiang-gai.webp" alt="Guoqiang Gai"></p>
<p>Whether it is PG or PG-related database products, its value must always be reflected by helping companies manage core data assets. Here, Gai said that the role of DBA is crucial for the last mile from database products to users. They are the closest partners of databases, whether in client companies, database cloud vendors or software suppliers or integrators. Gai encouraged DBAs to take advantage of open source and analyze in-depth source code to solve problems.</p>
<p><img src="/images/guoqiang-gai-2.webp" alt="Guoqiang Gai"></p>
<h3 id="Julyanto-SUTANDANG"><a href="#Julyanto-SUTANDANG" class="headerlink" title="Julyanto SUTANDANG"></a>Julyanto SUTANDANG</h3><p>Julyanto SUTANDANG, CEO of Equnix Business Solutions, gave a very detailed presentation about the professional PostgreSQL certifications and how these certifications can help an individual advance his or her career in PostgreSQL related fields. Certification is one of the best ways to tell your client, or your boss that you are the right person for the job. Whether you are a regular user, a government regulator, a professor or a subcontractor, there will always be a suitable level of PostgreSQL certification for your needs!</p>
<p><img src="/images/julyanto.png" alt="Julyanto SUTANDANG"></p>
<h3 id="Lei-Feng"><a href="#Lei-Feng" class="headerlink" title="Lei Feng"></a>Lei Feng</h3><p>Lei Feng, founder and general manager of Greenplum China founder shared “Greenplum’s open source journey: ecology and community leadership” speech.<br><img src="/images/lei-feng.webp" alt="Lei Feng"></p>
<p>the AI-enabled database is also leading the future development direction of the database. Lei shared the trilogy of their core team’s digital advancement in the cloud era and emphasized that the core competitiveness of database companies in the future will be the exploration and practice of AI models.</p>
<p><img src="/images/lei-feng-2.webp" alt="Lei Feng"></p>
<h3 id="Shuxin-Fang"><a href="#Shuxin-Fang" class="headerlink" title="Shuxin Fang"></a>Shuxin Fang</h3><p>Shuxin Fang, general manager of the technical support department of Inspur Business Machines, shared his presentation on “K1 power and PostgreSQL help enterprises to build new normal and new core”.<br><img src="/images/shuxin-fang.webp" alt="Shuxin Fang"></p>
<h3 id="Zhengsheng-Ye"><a href="#Zhengsheng-Ye" class="headerlink" title="Zhengsheng Ye"></a>Zhengsheng Ye</h3><p>Zhengsheng Ye, general manager of Alibaba Cloud Database Products and Head of Database Products and Operations, shared a speech of “Database Development Trend”.<br><img src="/images/zhengsheng-ye.webp" alt="Zhengsheng Ye"></p>
<h3 id="Yicheng-Wang"><a href="#Yicheng-Wang" class="headerlink" title="Yicheng Wang"></a>Yicheng Wang</h3><p>Yicheng Wang, Deputy General Manager of Tencent Cloud Database, shared the “Database Behind Every WeChat Payment”.<br><img src="/images/yicheng-wang.webp" alt="Yicheng Wang"></p>
<p>Tencent Cloud uses Tbase’s distributed solution to carry the WeChat payment business, and at the same time, it continues to enhance the core value of the product through cluster scalability, enhanced security, and efficient data compression, providing DBaaS for more enterprise users.</p>
<p><img src="/images/yicheng-wang-2.webp" alt="Yicheng Wang"></p>
<h3 id="Xiaojun-Zheng"><a href="#Xiaojun-Zheng" class="headerlink" title="Xiaojun Zheng"></a>Xiaojun Zheng</h3><p>Xiaojun Zheng, Chief Scientist of HighGo Software, shared the “Review of Commercial Database Technology Innovation”. With 30 years of senior management experience in several well-known database companies, he elaborated on major innovations in commercial databases in the past 30 years, which has important guiding significance for future database development.</p>
<p><img src="/images/xiaojun-zheng.webp" alt="Xiaojun Zheng"></p>
<p>HighGo database (HGDB) values data security with great importance when fulfilling the demands of enterprise users, and it has enhanced the security functions through a variety of technical means, including separation of powers, FDE full disk encryption, security auditing, security marking, etc. More features of the security version can be referred to The image below figure. Not only that, the HighGo enterprise cluster database also has flexible scalability, high availability, and effective load balancing.</p>
<p><img src="/images/xiaojun-zheng-2.webp" alt="Xiaojun Zheng"></p>
<h3 id="Chaoqun-Zhan"><a href="#Chaoqun-Zhan" class="headerlink" title="Chaoqun Zhan"></a>Chaoqun Zhan</h3><p>Chaoqun Zhan, a researcher of Alibaba Group and head of the OLAP product department of the database product division, shared “Opportunities and Challenges of Cloud Native Data Warehouse”.</p>
<p><img src="/images/chaoqun-zhan.webp" alt="Chaoqun Zhan"></p>
<p>The development of database technology is mainly affected by business scenario requirements and development factors of hardware technology. From the perspective of business scenario requirements, Alibaba Cloud, as a domestic leading cloud vendor, mainly integrates PolarDB+ADB full-line database products and integrates PG to respond to users’ various business scenarios.</p>
<p>Zhan shared a cloud-native integrated solution within Alibaba Group, which provides extreme performance and extremely fast and flexible expansion of cloud-native DBaaS.</p>
<p><img src="/images/chaoqun-zhan-2.webp" alt="Chaoqun Zhan"></p>
<h3 id="Bohan-Zhang"><a href="#Bohan-Zhang" class="headerlink" title="Bohan Zhang"></a>Bohan Zhang</h3><p>Bohan Zhang, the co-founder of Ottertune, shared effective solutions from the Carnegie Mellon University laboratory for the automatic tuning of PG parameters, and provided DBA recruitment information. If you are interested, please contact Zhang directly<br><img src="/images/bohan-zhang.webp" alt="Bohan Zhang"></p>
<h2 id="Closing-the-Conference"><a href="#Closing-the-Conference" class="headerlink" title="Closing the Conference"></a>Closing the Conference</h2><p>On the last day of the conference, Peter Zaitsev, CEO of Percona, shared the topic “17 Things Developers Need to Know About Databases” to help the database developers out there (including PG and non-PG developers) to increase their productivity, their quality of work, maintain a good relationship with DevOps and most importantly, avoid deadly and expensive mistakes!</p>
<p><img src="/images/peterz.jpg" alt="Peter Zaitsev"></p>
<h2 id="About-China-PostgreSQL-Assosication"><a href="#About-China-PostgreSQL-Assosication" class="headerlink" title="About China PostgreSQL Assosication"></a>About China PostgreSQL Assosication</h2><p>The China PostgreSQL Association is a legitimate and non-profit organization under the China Open Source Software Promotion Alliance.</p>
<p>The association’s main focus is to conduct activities around PostgreSQL, organize operations, promote PostgreSQL, host trainings, contribute to technological innovations and implementations. In addition, the association aims to promote the localization of the database development by bridging the PostgreSQL Chinese community with the International community.</p>
<p>Official Website <a href="http://www.postgresqlchina.com">http://www.postgresqlchina.com</a><br><img src="/images/chinapg.jpg" alt="China PostgreSQL Association"></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2020/11/06/How-to-Analyze-a-PostgreSQL-Crash-Dump-File/" class="image is-7by1">
            <img class="thumbnail" src="/images/gdb-core-debug-cover.png" alt="How to Analyze a PostgreSQL Crash Dump File">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-11-06T18:03:42.000Z">2020-11-06</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    17 minutes read (About 2560 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2020/11/06/How-to-Analyze-a-PostgreSQL-Crash-Dump-File/">How to Analyze a PostgreSQL Crash Dump File</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>In this blog post, I will talk about how to enable the generation of crash dump file (also known as core dump) and some common GDB commands to help a developer troubleshoot a crash-related issues within PostgreSQL and also other applications. Proper analysis of the issue normally will take time and certain degree of knowledge about the application source code. From experience, sometimes it may be better to look at the bigger environment instead of looking at the point of crash.</p>
<h3 id="2-What-is-a-Crash-Dump-File"><a href="#2-What-is-a-Crash-Dump-File" class="headerlink" title="2. What is a Crash Dump File?"></a>2. What is a Crash Dump File?</h3><p>A crash dump file is a file that consists of the recorded state of the working memory of an application when it crashes. This state is represented by stacks of memory addresses and CPU registers and normally it is extremely difficult to debug with only memory addresses and CPU registers because they tell you no information about the application logic. Considering the core dump contents below, which shows the back trace of memory addresses to the point of crash. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#1  0x00687a3d in ?? ()</span><br><span class="line">#2  0x00d37f06 in ?? ()</span><br><span class="line">#3  0x00bf0ba4 in ?? ()</span><br><span class="line">#4  0x00d3333b in ?? ()</span><br><span class="line">#5  0x00d3f682 in ?? ()</span><br><span class="line">#6  0x00d3407b in ?? ()</span><br><span class="line">#7  0x00d3f2f7 in ?? ()</span><br></pre></td></tr></table></figure>
<p>Not very useful is it? So, when we see a crash dump file that looks like this, it means the application is not built with debugging symbols, making this crash dump file useless. If this is the case, you will need to install the debug version of the application or re-build the application with debugging enabled.  </p>
<h3 id="3-How-to-Generate-a-Useful-Crash-Dump-File"><a href="#3-How-to-Generate-a-Useful-Crash-Dump-File" class="headerlink" title="3. How to Generate a Useful Crash Dump File"></a>3. How to Generate a Useful Crash Dump File</h3><p>Before the generation of crash dump file, we need to ensure the application is built with debugging symbols. This can be done by executing the <code>./configure</code> script like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;configure enable-debug</span><br></pre></td></tr></table></figure>
<p>This adds the <code>-g</code> argument to CFLAGS in <code>src/Makefile.global</code> with optimization level set to 2 (<code>-O2</code>). My preference is to also change the optimization to 0 (<code>-O0</code>) so when we are navigating the stack using GDB, the navigation will make much more sense rather than jumping around and we will be able to print out most variables values in memory instead of getting <code>optimized out</code> error in GDB.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CFLAGS &#x3D; -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror&#x3D;vla -Wendif-labels -Wmissing-format-attribute -Wimplicit-fallthrough&#x3D;3 -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision&#x3D;standard -Wno-format-truncation -g -O0</span><br></pre></td></tr></table></figure>

<p>Now, we can enable the crash dump generation. This can be done by the user limit command. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ulimit -c unlimited</span><br></pre></td></tr></table></figure>

<p>to disable:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ulimit -c 0</span><br></pre></td></tr></table></figure>

<p>Make sure there is enough disk space because crash dump file is normally very large as it records all the memory execution states from start to crash, and make sure the <code>ulimit</code> is set up in the shell before starting PostgreSQL. When PostgreSQL crashes, a core dump file named <code>core</code> will be generated in <code>$PGDATA</code></p>
<h3 id="4-Analyzing-the-Dump-File-using-GDB"><a href="#4-Analyzing-the-Dump-File-using-GDB" class="headerlink" title="4. Analyzing the Dump File using GDB"></a>4. Analyzing the Dump File using GDB</h3><p>GDB (GNU Debugger) is a portable debugger that runs on many Unix-like systems and can work with many programming languages and is my favorite tool to analyze a crash dump file. To demonstrate this, I will intentionally add a line in PostgreSQL source code that will result in <code>segmentation fault</code> crash type when a <code>CREATE TABLE</code> command is run. </p>
<p>Assuming the PostgreSQL has already crashed and generated a core dump file <code>core</code> in this location <code>~/highgo/git/postgres/postgresdb/core</code>. I would first use the <code>file</code> utility to understand more about the core file. Information such as the kernel info, and the program that generated it.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">caryh@HGPC01:~$ file &#x2F;home&#x2F;caryh&#x2F;highgo&#x2F;git&#x2F;postgres&#x2F;postgresdb&#x2F;core</span><br><span class="line">postgresdb&#x2F;core: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from &#39;postgres: cary cary [local] CREATE TABLE&#39;, real uid: 1000, effective uid: 1000, real gid: 1000, effective gid: 1000, execfn: &#39;&#x2F;home&#x2F;caryh&#x2F;highgo&#x2F;git&#x2F;postgres&#x2F;highgo&#x2F;bin&#x2F;postgres&#39;, platform: &#39;x86_64&#39;</span><br><span class="line">caryh@HGPC01:~$</span><br></pre></td></tr></table></figure>

<p>The <code>file</code> utility tells me that the core file is generated by this application <code>/home/caryh/highgo/git/postgres/highgo/bin/postgres</code>, so I would execute <code>gdb</code> like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb &#x2F;home&#x2F;caryh&#x2F;highgo&#x2F;git&#x2F;postgres&#x2F;highgo&#x2F;bin&#x2F;postgres -c  &#x2F;home&#x2F;caryh&#x2F;highgo&#x2F;git&#x2F;postgres&#x2F;postgresdb&#x2F;core</span><br><span class="line"></span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;bugs&#x2F;&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;documentation&#x2F;&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from &#x2F;home&#x2F;caryh&#x2F;highgo&#x2F;git&#x2F;postgres&#x2F;highgo&#x2F;bin&#x2F;postgres...done.</span><br><span class="line">[New LWP 27417]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.</span><br><span class="line">Core was generated by &#96;postgres: cary cary [local] CREATE TABLE                                 &#39;.</span><br><span class="line">Program terminated with signal SIGSEGV, Segmentation fault.</span><br><span class="line">#0  heap_insert (relation&#x3D;relation@entry&#x3D;0x7f872f532228, tup&#x3D;tup@entry&#x3D;0x55ba8290f778, cid&#x3D;0, options&#x3D;options@entry&#x3D;0,</span><br><span class="line">    bistate&#x3D;bistate@entry&#x3D;0x0) at heapam.c:1840</span><br><span class="line">1840            ereport(LOG,(errmsg(&quot;heap tuple len &#x3D; %d&quot;, heaptup-&gt;t_len)));</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>Immediately after running <code>gdb</code> on the <code>core</code> file, it shows the location of the crash at <code>heapam.c:1840</code> and that is exactly the line I have intentionally added to cause a crash.</p>
<h3 id="5-Useful-GDB-Commands"><a href="#5-Useful-GDB-Commands" class="headerlink" title="5. Useful GDB Commands"></a>5. Useful GDB Commands</h3><p>With <code>gdb</code>, it is very easy to identify the location of a crash, because it tells you immediately after running <code>gdb</code> on the <code>core</code> file. Unfortunately, 95% of the time, the location of the crash is not the real cause of the problem. This is why I mentioned earlier that sometimes it may be better to look at the bigger environment instead of looking at the point of crash. The crash is likely caused by a mistake in the application logic some where else in the application before it hits the point of crash. Even if you fix the crash, the mistake in application logic still exists and most likely, the application will crash somewhere else later or yield unsatisfactory results. Therefore, it is worth awhile to understand some of the powerful GDB commands that could help us understand the call stacks better to identify the real root cause.</p>
<h4 id="5-1-The-bt-Back-Trace-command"><a href="#5-1-The-bt-Back-Trace-command" class="headerlink" title="5.1 The bt (Back Trace) command"></a>5.1 The <code>bt</code> (Back Trace) command</h4><p>The <code>bt</code> command shows a series of call stacks since the beginning of the application all the way to the point of crash. With full debugging enabled, you will be able to see the function arguments and values being passed in to each function calls as well as the source file and line numbers where they were called. This allows developer to travel backwards to check for any potential application logic mistake in the earlier processing. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(gdb) bt</span><br><span class="line">#0  heap_insert (relation&#x3D;relation@entry&#x3D;0x7f872f532228, tup&#x3D;tup@entry&#x3D;0x55ba8290f778, cid&#x3D;0, options&#x3D;options@entry&#x3D;0,</span><br><span class="line">    bistate&#x3D;bistate@entry&#x3D;0x0) at heapam.c:1840</span><br><span class="line">#1  0x000055ba81ccde3e in simple_heap_insert (relation&#x3D;relation@entry&#x3D;0x7f872f532228, tup&#x3D;tup@entry&#x3D;0x55ba8290f778)</span><br><span class="line">    at heapam.c:2356</span><br><span class="line">#2  0x000055ba81d7826d in CatalogTupleInsert (heapRel&#x3D;0x7f872f532228, tup&#x3D;0x55ba8290f778) at indexing.c:228</span><br><span class="line">#3  0x000055ba81d946ea in TypeCreate (newTypeOid&#x3D;newTypeOid@entry&#x3D;0, typeName&#x3D;typeName@entry&#x3D;0x7ffcf56ef820 &quot;test&quot;,</span><br><span class="line">    typeNamespace&#x3D;typeNamespace@entry&#x3D;2200, relationOid&#x3D;relationOid@entry&#x3D;16392, relationKind&#x3D;relationKind@entry&#x3D;114 &#39;r&#39;,</span><br><span class="line">    ownerId&#x3D;ownerId@entry&#x3D;16385, internalSize&#x3D;-1, typeType&#x3D;99 &#39;c&#39;, typeCategory&#x3D;67 &#39;C&#39;, typePreferred&#x3D;false,</span><br><span class="line">    typDelim&#x3D;44 &#39;,&#39;, inputProcedure&#x3D;2290, outputProcedure&#x3D;2291, receiveProcedure&#x3D;2402, sendProcedure&#x3D;2403,</span><br><span class="line">    typmodinProcedure&#x3D;0, typmodoutProcedure&#x3D;0, analyzeProcedure&#x3D;0, elementType&#x3D;0, isImplicitArray&#x3D;false, arrayType&#x3D;16393,</span><br><span class="line">    baseType&#x3D;0, defaultTypeValue&#x3D;0x0, defaultTypeBin&#x3D;0x0, passedByValue&#x3D;false, alignment&#x3D;100 &#39;d&#39;, storage&#x3D;120 &#39;x&#39;,</span><br><span class="line">    typeMod&#x3D;-1, typNDims&#x3D;0, typeNotNull&#x3D;false, typeCollation&#x3D;0) at pg_type.c:484</span><br><span class="line">#4  0x000055ba81d710bc in AddNewRelationType (new_array_type&#x3D;16393, new_row_type&#x3D;&lt;optimized out&gt;, ownerid&#x3D;&lt;optimized out&gt;,</span><br><span class="line">    new_rel_kind&#x3D;&lt;optimized out&gt;, new_rel_oid&#x3D;&lt;optimized out&gt;, typeNamespace&#x3D;2200, typeName&#x3D;0x7ffcf56ef820 &quot;test&quot;)</span><br><span class="line">    at heap.c:1033</span><br><span class="line">#5  heap_create_with_catalog (relname&#x3D;relname@entry&#x3D;0x7ffcf56ef820 &quot;test&quot;, relnamespace&#x3D;relnamespace@entry&#x3D;2200,</span><br><span class="line">    reltablespace&#x3D;reltablespace@entry&#x3D;0, relid&#x3D;16392, relid@entry&#x3D;0, reltypeid&#x3D;reltypeid@entry&#x3D;0,</span><br><span class="line">    reloftypeid&#x3D;reloftypeid@entry&#x3D;0, ownerid&#x3D;16385, accessmtd&#x3D;2, tupdesc&#x3D;0x55ba8287c620, cooked_constraints&#x3D;0x0,</span><br><span class="line">    relkind&#x3D;114 &#39;r&#39;, relpersistence&#x3D;112 &#39;p&#39;, shared_relation&#x3D;false, mapped_relation&#x3D;false, oncommit&#x3D;ONCOMMIT_NOOP,</span><br><span class="line">    reloptions&#x3D;0, use_user_acl&#x3D;true, allow_system_table_mods&#x3D;false, is_internal&#x3D;false, relrewrite&#x3D;0, typaddress&#x3D;0x0)</span><br><span class="line">    at heap.c:1294</span><br><span class="line">#6  0x000055ba81e3782a in DefineRelation (stmt&#x3D;stmt@entry&#x3D;0x55ba82876658, relkind&#x3D;relkind@entry&#x3D;114 &#39;r&#39;, ownerId&#x3D;16385,</span><br><span class="line">    ownerId@entry&#x3D;0, typaddress&#x3D;typaddress@entry&#x3D;0x0,</span><br><span class="line">    queryString&#x3D;queryString@entry&#x3D;0x55ba82855648 &quot;create table test (a int, b char(10)) using heap;&quot;) at tablecmds.c:885</span><br><span class="line">#7  0x000055ba81fd5b2f in ProcessUtilitySlow (pstate&#x3D;pstate@entry&#x3D;0x55ba82876548, pstmt&#x3D;pstmt@entry&#x3D;0x55ba828565a0,</span><br><span class="line">    queryString&#x3D;queryString@entry&#x3D;0x55ba82855648 &quot;create table test (a int, b char(10)) using heap;&quot;,</span><br><span class="line">    context&#x3D;context@entry&#x3D;PROCESS_UTILITY_TOPLEVEL, params&#x3D;params@entry&#x3D;0x0, queryEnv&#x3D;queryEnv@entry&#x3D;0x0, qc&#x3D;0x7ffcf56efe50,</span><br><span class="line">    dest&#x3D;0x55ba82856860) at utility.c:1161</span><br><span class="line">#8  0x000055ba81fd4120 in standard_ProcessUtility (pstmt&#x3D;0x55ba828565a0,</span><br><span class="line">    queryString&#x3D;0x55ba82855648 &quot;create table test (a int, b char(10)) using heap;&quot;, context&#x3D;PROCESS_UTILITY_TOPLEVEL,</span><br><span class="line">    params&#x3D;0x0, queryEnv&#x3D;0x0, dest&#x3D;0x55ba82856860, qc&#x3D;0x7ffcf56efe50) at utility.c:1069</span><br><span class="line">#9  0x000055ba81fd1962 in PortalRunUtility (portal&#x3D;0x55ba828b7dd8, pstmt&#x3D;0x55ba828565a0, isTopLevel&#x3D;&lt;optimized out&gt;,</span><br><span class="line">    setHoldSnapshot&#x3D;&lt;optimized out&gt;, dest&#x3D;&lt;optimized out&gt;, qc&#x3D;0x7ffcf56efe50) at pquery.c:1157</span><br><span class="line">#10 0x000055ba81fd23e3 in PortalRunMulti (portal&#x3D;portal@entry&#x3D;0x55ba828b7dd8, isTopLevel&#x3D;isTopLevel@entry&#x3D;true,</span><br><span class="line">    setHoldSnapshot&#x3D;setHoldSnapshot@entry&#x3D;false, dest&#x3D;dest@entry&#x3D;0x55ba82856860, altdest&#x3D;altdest@entry&#x3D;0x55ba82856860,</span><br><span class="line">    qc&#x3D;qc@entry&#x3D;0x7ffcf56efe50) at pquery.c:1310</span><br><span class="line">#11 0x000055ba81fd2f51 in PortalRun (portal&#x3D;portal@entry&#x3D;0x55ba828b7dd8, count&#x3D;count@entry&#x3D;9223372036854775807,</span><br><span class="line">    isTopLevel&#x3D;isTopLevel@entry&#x3D;true, run_once&#x3D;run_once@entry&#x3D;true, dest&#x3D;dest@entry&#x3D;0x55ba82856860,</span><br><span class="line">    altdest&#x3D;altdest@entry&#x3D;0x55ba82856860, qc&#x3D;0x7ffcf56efe50) at pquery.c:779</span><br><span class="line">#12 0x000055ba81fce967 in exec_simple_query (query_string&#x3D;0x55ba82855648 &quot;create table test (a int, b char(10)) using heap;&quot;)</span><br><span class="line">    at postgres.c:1239</span><br><span class="line">#13 0x000055ba81fd0d7e in PostgresMain (argc&#x3D;&lt;optimized out&gt;, argv&#x3D;argv@entry&#x3D;0x55ba8287fdb0, dbname&#x3D;&lt;optimized out&gt;,</span><br><span class="line">    username&#x3D;&lt;optimized out&gt;) at postgres.c:4315</span><br><span class="line">#14 0x000055ba81f4f52a in BackendRun (port&#x3D;0x55ba82877110, port&#x3D;0x55ba82877110) at postmaster.c:4536</span><br><span class="line">#15 BackendStartup (port&#x3D;0x55ba82877110) at postmaster.c:4220</span><br><span class="line">#16 ServerLoop () at postmaster.c:1739</span><br><span class="line">#17 0x000055ba81f5063f in PostmasterMain (argc&#x3D;3, argv&#x3D;0x55ba8284fee0) at postmaster.c:1412</span><br><span class="line">#18 0x000055ba81c91c04 in main (argc&#x3D;3, argv&#x3D;0x55ba8284fee0) at main.c:210</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h4 id="5-1-The-f-Fly-command"><a href="#5-1-The-f-Fly-command" class="headerlink" title="5.1 The f (Fly) command"></a>5.1 The <code>f</code> (Fly) command</h4><p>The <code>f</code> command followed by a stack number allows gdb to jump to a particular call stack listed by the <code>bt</code> command and allows you to print other variable in that particular stack. For example:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) f 3</span><br><span class="line">#3  0x000055ba81d946ea in TypeCreate (newTypeOid&#x3D;newTypeOid@entry&#x3D;0, typeName&#x3D;typeName@entry&#x3D;0x7ffcf56ef820 &quot;test&quot;,</span><br><span class="line">    typeNamespace&#x3D;typeNamespace@entry&#x3D;2200, relationOid&#x3D;relationOid@entry&#x3D;16392, relationKind&#x3D;relationKind@entry&#x3D;114 &#39;r&#39;,</span><br><span class="line">    ownerId&#x3D;ownerId@entry&#x3D;16385, internalSize&#x3D;-1, typeType&#x3D;99 &#39;c&#39;, typeCategory&#x3D;67 &#39;C&#39;, typePreferred&#x3D;false,</span><br><span class="line">    typDelim&#x3D;44 &#39;,&#39;, inputProcedure&#x3D;2290, outputProcedure&#x3D;2291, receiveProcedure&#x3D;2402, sendProcedure&#x3D;2403,</span><br><span class="line">    typmodinProcedure&#x3D;0, typmodoutProcedure&#x3D;0, analyzeProcedure&#x3D;0, elementType&#x3D;0, isImplicitArray&#x3D;false, arrayType&#x3D;16393,</span><br><span class="line">    baseType&#x3D;0, defaultTypeValue&#x3D;0x0, defaultTypeBin&#x3D;0x0, passedByValue&#x3D;false, alignment&#x3D;100 &#39;d&#39;, storage&#x3D;120 &#39;x&#39;,</span><br><span class="line">    typeMod&#x3D;-1, typNDims&#x3D;0, typeNotNull&#x3D;false, typeCollation&#x3D;0) at pg_type.c:484</span><br><span class="line">484                     CatalogTupleInsert(pg_type_desc, tup);</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>This forces <code>gdb</code> to jump to stack number 3, which is at pg_type.c:484. In here, you can examine all other variables in this frame (in function TypeCreate).</p>
<h4 id="5-2-The-p-Print-command"><a href="#5-2-The-p-Print-command" class="headerlink" title="5.2 The p (Print) command"></a>5.2 The <code>p</code> (Print) command</h4><p>The most popular command in <code>gdb</code>, which can be used to print variable addresses and values</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) p tup</span><br><span class="line">$1 &#x3D; (HeapTuple) 0x55ba8290f778</span><br><span class="line">(gdb) p pg_type_desc</span><br><span class="line">$2 &#x3D; (Relation) 0x7f872f532228</span><br><span class="line"></span><br><span class="line">(gdb)  p * tup</span><br><span class="line">$3 &#x3D; &#123;t_len &#x3D; 176, t_self &#x3D; &#123;ip_blkid &#x3D; &#123;bi_hi &#x3D; 65535, bi_lo &#x3D; 65535&#125;, ip_posid &#x3D; 0&#125;, t_tableOid &#x3D; 0,</span><br><span class="line">  t_data &#x3D; 0x55ba8290f790&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p * pg_type_desc</span><br><span class="line">$4 &#x3D; &#123;rd_node &#x3D; &#123;spcNode &#x3D; 1663, dbNode &#x3D; 16384, relNode &#x3D; 1247&#125;, rd_smgr &#x3D; 0x55ba828e2a38, rd_refcnt &#x3D; 2, rd_backend &#x3D; -1,</span><br><span class="line">  rd_islocaltemp &#x3D; false, rd_isnailed &#x3D; true, rd_isvalid &#x3D; true, rd_indexvalid &#x3D; true, rd_statvalid &#x3D; false,</span><br><span class="line">  rd_createSubid &#x3D; 0, rd_newRelfilenodeSubid &#x3D; 0, rd_firstRelfilenodeSubid &#x3D; 0, rd_droppedSubid &#x3D; 0,</span><br><span class="line">  rd_rel &#x3D; 0x7f872f532438, rd_att &#x3D; 0x7f872f532548, rd_id &#x3D; 1247, rd_lockInfo &#x3D; &#123;lockRelId &#x3D; &#123;relId &#x3D; 1247, dbId &#x3D; 16384&#125;&#125;,</span><br><span class="line">  rd_rules &#x3D; 0x0, rd_rulescxt &#x3D; 0x0, trigdesc &#x3D; 0x0, rd_rsdesc &#x3D; 0x0, rd_fkeylist &#x3D; 0x0, rd_fkeyvalid &#x3D; false,</span><br><span class="line">  rd_partkey &#x3D; 0x0, rd_partkeycxt &#x3D; 0x0, rd_partdesc &#x3D; 0x0, rd_pdcxt &#x3D; 0x0, rd_partcheck &#x3D; 0x0, rd_partcheckvalid &#x3D; false,</span><br><span class="line">  rd_partcheckcxt &#x3D; 0x0, rd_indexlist &#x3D; 0x7f872f477d00, rd_pkindex &#x3D; 0, rd_replidindex &#x3D; 0, rd_statlist &#x3D; 0x0,</span><br><span class="line">  rd_indexattr &#x3D; 0x0, rd_keyattr &#x3D; 0x0, rd_pkattr &#x3D; 0x0, rd_idattr &#x3D; 0x0, rd_pubactions &#x3D; 0x0, rd_options &#x3D; 0x0,</span><br><span class="line">  rd_amhandler &#x3D; 0, rd_tableam &#x3D; 0x55ba82562c20 &lt;heapam_methods&gt;, rd_index &#x3D; 0x0, rd_indextuple &#x3D; 0x0, rd_indexcxt &#x3D; 0x0,</span><br><span class="line">  rd_indam &#x3D; 0x0, rd_opfamily &#x3D; 0x0, rd_opcintype &#x3D; 0x0, rd_support &#x3D; 0x0, rd_supportinfo &#x3D; 0x0, rd_indoption &#x3D; 0x0,</span><br><span class="line">  rd_indexprs &#x3D; 0x0, rd_indpred &#x3D; 0x0, rd_exclops &#x3D; 0x0, rd_exclprocs &#x3D; 0x0, rd_exclstrats &#x3D; 0x0, rd_indcollation &#x3D; 0x0,</span><br><span class="line">  rd_opcoptions &#x3D; 0x0, rd_amcache &#x3D; 0x0, rd_fdwroutine &#x3D; 0x0, rd_toastoid &#x3D; 0, pgstat_info &#x3D; 0x55ba828d5cb0&#125;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>With the asteroid, you can tell the <code>p</code> command to either print the address of a pointer or the values pointed by the pointer.</p>
<h4 id="5-3-The-x-examine-command"><a href="#5-3-The-x-examine-command" class="headerlink" title="5.3 The x (examine) command"></a>5.3 The <code>x</code> (examine) command</h4><p>The <code>x</code> command is used to examine a memory block contents with specified size and format. The following example tries to examine the <code>t_data</code> values inside a <code>HeapTuple</code> structure. Note that we first print the <code>*tup</code> pointer to learn the size of <code>t_data</code> is 176, then we use the <code>x</code> command to examine the first 176 bytes pointed by <code>t_data</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb)  p *tup</span><br><span class="line">$6 &#x3D; &#123;t_len &#x3D; 176, t_self &#x3D; &#123;ip_blkid &#x3D; &#123;bi_hi &#x3D; 65535, bi_lo &#x3D; 65535&#125;, ip_posid &#x3D; 0&#125;, t_tableOid &#x3D; 0,</span><br><span class="line">  t_data &#x3D; 0x55ba8290f790&#125;</span><br><span class="line"></span><br><span class="line">(gdb)  p tup-&gt;t_data</span><br><span class="line">$7 &#x3D; (HeapTupleHeader) 0x55ba8290f790</span><br><span class="line">(gdb) x&#x2F;176bx  tup-&gt;t_data</span><br><span class="line">0x55ba8290f790: 0xc0    0x02    0x00    0x00    0xff    0xff    0xff    0xff</span><br><span class="line">0x55ba8290f798: 0x47    0x00    0x00    0x00    0xff    0xff    0xff    0xff</span><br><span class="line">0x55ba8290f7a0: 0x00    0x00    0x1f    0x00    0x01    0x00    0x20    0xff</span><br><span class="line">0x55ba8290f7a8: 0xff    0xff    0x0f    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7b0: 0x0a    0x40    0x00    0x00    0x74    0x65    0x73    0x74</span><br><span class="line">0x55ba8290f7b8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7c0: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7c8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7d0: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7d8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7e0: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7e8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f7f0: 0x00    0x00    0x00    0x00    0x98    0x08    0x00    0x00</span><br><span class="line">0x55ba8290f7f8: 0x01    0x40    0x00    0x00    0xff    0xff    0x00    0x63</span><br><span class="line">0x55ba8290f800: 0x43    0x00    0x01    0x2c    0x08    0x40    0x00    0x00</span><br><span class="line">0x55ba8290f808: 0x00    0x00    0x00    0x00    0x09    0x40    0x00    0x00</span><br><span class="line">0x55ba8290f810: 0xf2    0x08    0x00    0x00    0xf3    0x08    0x00    0x00</span><br><span class="line">0x55ba8290f818: 0x62    0x09    0x00    0x00    0x63    0x09    0x00    0x00</span><br><span class="line">0x55ba8290f820: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x55ba8290f828: 0x00    0x00    0x00    0x00    0x64    0x78    0x00    0x00</span><br><span class="line">0x55ba8290f830: 0x00    0x00    0x00    0x00    0xff    0xff    0xff    0xff</span><br><span class="line">0x55ba8290f838: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<h3 id="7-Conclusion"><a href="#7-Conclusion" class="headerlink" title="7. Conclusion"></a>7. Conclusion</h3><p>In this blog, we have discussed about how to generate a useful crash dump file with sufficient debug symbols to help developers troubleshoot a crash issue in PostgreSQL and also in other applications. We have also discussed about a very powerful and useful debugger <code>gdb</code> and shared some of the most common commands that can be utilized to troubleshoot a crash issue from a core file. I hope the information here can help some developers out there to troubleshoot issues better.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2020/09/23/In-memory-Table-with-Pluggable-Storage-API/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg-mem-table-cover.png" alt="In-Memory Table with Pluggable Storage API">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-09-23T21:02:38.000Z">2020-09-23</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 minutes read (About 861 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2020/09/23/In-memory-Table-with-Pluggable-Storage-API/">In-Memory Table with Pluggable Storage API</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>This blog is to follow up on the post I published back in July, 2020 about achieving an in-memory table storage using PostgreSQL’s pluggable storage API. In the past few months, my team and I have made some progress and did a few POC patches to prove some of the unknowns and hypothesis and today I would like to share our progress.</p>
<h3 id="2-The-PostgreSQL-Buffer-Manager"><a href="#2-The-PostgreSQL-Buffer-Manager" class="headerlink" title="2. The PostgreSQL Buffer Manager"></a>2. The PostgreSQL Buffer Manager</h3><p>In the previous post, I mentioned that we would like to build a new in-memory based storage that is based on the existing buffer manager and its related component and hooked it up with the pluggable storage API. To achieve this, my team and I underwent an in-depth study to understand how the current buffer manager works in PostgreSQL and this chapter at <a href="http://www.interdb.jp/pg/pgsql08.html">interdb.jp</a> is a good starting point for us to gain a general understanding of the buffer manager design in good details.</p>
<p>The current PostgreSQL buffer manager follows a 3-layer buffer design to manage the data pages as illustrated by this image below:</p>
<p><img src="/images/bufmgr-3layer.png" alt="bufmgr"></p>
<p>where it consists of </p>
<ul>
<li>Buffer Table (hash table)</li>
<li>Buffer Descriptors (Array)</li>
<li>Buffer Pool (Array)</li>
</ul>
<h4 id="2-1-Page-Table"><a href="#2-1-Page-Table" class="headerlink" title="2.1 Page Table"></a>2.1 Page Table</h4><p>Buffer Table is used like a routing table between PostgreSQL Core and the buffer manager. It is managed using the existing hash table utilities and uses <code>buffer_tag</code> to look up the page descriptor and buffer id. Buffer_tag is a structure that contains the table space, database, table name.</p>
<h4 id="2-2-Buffer-Descriptor"><a href="#2-2-Buffer-Descriptor" class="headerlink" title="2.2 Buffer Descriptor"></a>2.2 Buffer Descriptor</h4><p>Buffer Descriptor is used to store the status of a buffer block and also the content lock. Refcount is a part of the buffer state, will be used to indicate the insert and delete operation. it will be increased by one when there is an insertion, and decreased by one when there is a deletion. The Vacuum process will reclaim this page once refcount reaches to 0.</p>
<h4 id="2-3-Buffer-Pool"><a href="#2-3-Buffer-Pool" class="headerlink" title="2.3 Buffer Pool"></a>2.3 Buffer Pool</h4><p>Buffer Pool has a one to one relationship with buffer descriptor. it can be treated a simple pointer pointing to the beginning of the buffer pool, each buffer pool slot is defined as 8KB for now. This is the lowest layer in the buffer manager structure before a page is flushed to disk. The <code>BM_DIRTY</code> status flag is used to indicate if a page in the buffer pool is to be flushed to disk</p>
<p>In addition to buffer pool, buffer manager also utilizes a ring buffer for reading and writing a huge table whose size exceeds 1/4 of the buffer pool size. <code>Clock Sweep</code> algorithm is used to find a victim page in the ring buffer to eject and flush to disk so new page can enter, thus the name, ring buffer.</p>
<h3 id="3-The-In-Memory-Only-Buffer-Manager"><a href="#3-The-In-Memory-Only-Buffer-Manager" class="headerlink" title="3. The In-Memory Only Buffer Manager"></a>3. The In-Memory Only Buffer Manager</h3><p>Having a general understanding of the existing buffer manager’s strucutre, we hypothesize that we could potentially improve its IO performance by eliminating the need to flush any buffer data to disk. This means that the in-memory only version of buffer manager itself is the storage media. For this reason, its strucutre can be simplified as:</p>
<p><img src="/images/bufmgr-2layer.png" alt="bufmgr"></p>
<p>where the buffer descriptor points to a dedicated memory storage that contains the actual page and tuple. This memory space can be allocated to a certain size at initlaization and there will not be a need to flush a page to disk. All data page and tuple will reside in this memory space. In the case where there is a huge reading and writing load, the ring buffer will not be allocated as the logic to find a victim page to evict and flush to disk will be removed since everything will reside in a dedicated memory space. For this reason, if the memory space is not sufficiently allocated, the user will get “no unpin buffer” is available, which basically means “your disk is full” and you need to do delete and vacuum. </p>
<p>Using this approach, when the server shuts down or restarts, the data in this memory space is of course lost. So, data persistence to disk would be a topic of interest next, but right now, we already see some useful business case with this in-memory based table where data processing speed is more important than data persistence</p>
<h3 id="4-Initial-Results"><a href="#4-Initial-Results" class="headerlink" title="4. Initial Results"></a>4. Initial Results</h3><p>Using the same tuple structure and logic as the current heap plus the memory based buffer manager with 1GB of memory allocated, we observe some interesting increase in performance comparing to PostgreSQL with default settings. For 20 million row, we observe about 50% increase for insert, 70% increase for update, 60% increase for delete and 30% increase in vacuum. This result is not too bad considering we are still at the early stages and I am sure there are many other ways to make it even faster</p>
<h3 id="5-Next-Step"><a href="#5-Next-Step" class="headerlink" title="5. Next Step"></a>5. Next Step</h3><p>Having some solid results from the initial test, it would make sense for us to also be looking into having the index tuples as in-memory storage only. In addition, free space map and visibility map files that are stored in the PG cluster directory could potentially also be made as in-memory to possibly further increase the DML performance.</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-image">
        <a href="/2020/08/21/TLS-Related-Updates-in-PostgreSQL-13/" class="image is-7by1">
            <img class="thumbnail" src="/images/pg13-tls-cover.png" alt="TLS Related Updates in PostgreSQL 13">
        </a>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-08-21T18:30:21.000Z">2020-08-21</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 minutes read (About 1027 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2020/08/21/TLS-Related-Updates-in-PostgreSQL-13/">TLS Related Updates in PostgreSQL 13</a>
            
        </h1>
        <div class="content">
            <h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><p>The upcoming major release of PostgreSQL 13 has several important behavioral updates related to the TLS implementation. These updates may have some to your current PostgreSQL security deployment if you were considering to upgrade to 13 when it officially releases. Today I would like to do a quick summary of these updates.</p>
<h3 id="2-Minimum-TLS-Version-Changed-to-TLSv1-2"><a href="#2-Minimum-TLS-Version-Changed-to-TLSv1-2" class="headerlink" title="2. Minimum TLS Version Changed to TLSv1.2"></a>2. Minimum TLS Version Changed to TLSv1.2</h3><p>There are 2 server parameters in <code>postgresql.conf</code> that influence the desired TLS versions to use during communication, <code>ssl_min_protocol_version</code> and <code>ssl_max_protocol_version</code>. In previous PG versions, the default value for <code>ssl_min_protocol_version</code> was <code>TLSv1</code>, in which many older versions of OpenSSL could support. In PG13, this default has been raised to TLSv1.2, which satisfies current industry’s best practice. This means that if your psql client is built using older version of OpenSSL, such as 1.0.0., the PG13 server by default will deny this TLS connection, until either you rebuild the psql client with newer version of OpenSSL, or you lower the <code>ssl_min_protocol_version</code> back to <code>TLSv1</code>. Lowering this default is strongly discouraged as older versions of TLS are not as secured and many industrial applications are communicating using <code>TLSv1.2</code> as a standard requirement now.</p>
<h3 id="3-New-libpq-connection-parameters"><a href="#3-New-libpq-connection-parameters" class="headerlink" title="3. New libpq connection parameters"></a>3. New libpq connection parameters</h3><p>There are also several updates to the libpq client side connection parameters related to TLS. See sub sections below:</p>
<h4 id="3-1-ssl-min-protocol-version-and-ssl-max-protocol-version"><a href="#3-1-ssl-min-protocol-version-and-ssl-max-protocol-version" class="headerlink" title="3.1 ssl_min_protocol_version and ssl_max_protocol_version"></a>3.1 ssl_min_protocol_version and ssl_max_protocol_version</h4><p>The <code>ssl_min_protocol_version</code> and <code>ssl_max_protocol_version</code> parameters defined in the <code>postgresql.conf</code> on the server side were not available in the libpq client side in the previous PG versions. This means that in previous versions, it was not possible for client to influence the desired version of TLS to used as it would always want to used the newest TLS versions to communicate with the server. This may not be ideal in some cases. In PG13, the same sets of parameters are added to the libpq client side as well such that the client can also play a part in determining the ideal TLS version for communication. These parameters can be specified to <code>psql</code> like so:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U user -d &quot;sslmode&#x3D;require dbname&#x3D;postgres ssl_max_protocol_version&#x3D;TLSv1.2&quot;</span><br><span class="line">psql -U user -d &quot;sslmode&#x3D;require dbname&#x3D;postgres ssl_min_protocol_version&#x3D;TLSv1.3&quot;</span><br></pre></td></tr></table></figure>

<p>The second command in the above example sets minimum TLS protocol to <code>TLSv1.3</code>, which means that this client would only want to communicate with a server that could support TLSv1.3 as minimum version requirement. TLSv1.3 is fairly new and not every PostgreSQL servers are built with this support. In this case, the client simply refuses to communicate. These parameters are great additions to the current libpq as they give the client the ability to enforce the desired TLS version to use rather than simply letting the server to decide, resulting in a much more secured environment.</p>
<h4 id="3-2-channel-binding"><a href="#3-2-channel-binding" class="headerlink" title="3.2 channel_binding"></a>3.2 channel_binding</h4><p>Channel binding is a new feature introduced in PG13, in which the libpq client can optionally enable to further increase the security of the TLS connection. The <code>channel_binding</code> parameter can be set to <code>require</code> to enforce the channel binding feature, <code>prefer</code> to only use channel binding if it is available or <code>disable</code> to not use channel binding at all. <code>prefer</code> is the default value for the new <code>channel_binding</code> parameter.</p>
<p>The channel binding feature enforces trust between client and server so that Client informs the server whom it thinks it speaks to, and Server validates whether it is correct or not. This prevents an attacker who is able to capture users’ authentication credentials (e.g. OAuth tokens, session identifiers, etc) from reusing those credentials in another TLS sessions. In PG13, the channel binding is done by tying the user’s <code>scram-sha-256</code> credentials to a unique fingerprint of the TLS session in which they are used (channel binding), so they cannot be reused in another TLS sessions initiated by the attacker.</p>
<p>To use this feature, we need to define a rule in <code>pg_hba.conf</code> that uses <code>scram-sha-256</code> as authentication method. Ex:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hostssl    all    all    127.0.0.1&#x2F;32    scram-sha-256</span><br></pre></td></tr></table></figure>

<p>also set the default password authentication method to <code>scram-sha-256</code> in <code>postgresql.conf</code>. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">password_encryption &#x3D; scram-sha-256</span><br></pre></td></tr></table></figure>

<p>and then sets a scram-sha-256 password for the current user or another user in a existing psql connection</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\password</span><br><span class="line"></span><br><span class="line">or \password [username]</span><br></pre></td></tr></table></figure>

<p>then finally, we can use psql with channel binding to connect to the server. Ex:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U user -d &quot;sslmode&#x3D;require dbname&#x3D;postgres channel_binding&#x3D;require ssl_min_protocol_version&#x3D;TLSv1.2&quot;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-sslpassword"><a href="#3-3-sslpassword" class="headerlink" title="3.3 sslpassword"></a>3.3 sslpassword</h4><p>In previous version of PG, in a <code>sslmode=verify-full</code> case, the client will need to specify its X509 certificate, private key and CA cert to complete the entire TLS authentication. In the case where the private key supplied by the client is encrypted with a password, the psql will prompt the user to enter it before proceeding with the TLS authentication. The new <code>sslpassword</code> parameter allows the user to specify the password to the connection parameters without prompting the user to enter it. This is a useful addition, as the psql command could basically completes without having a human or a bot to enter the passphrase to unlock the private key. This parameter can be used like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U user -d &quot;sslmode&#x3D;verify-full dbname&#x3D;postgres sslrootcert&#x3D;cacert.pem sslcert&#x3D;client.pem sslkey&#x3D;client.key sslpassword&#x3D;mypass&quot;</span><br></pre></td></tr></table></figure>

<h3 id="4-Remove-support-for-OpenSSL-0-9-8-and-1-0-0"><a href="#4-Remove-support-for-OpenSSL-0-9-8-and-1-0-0" class="headerlink" title="4. Remove support for OpenSSL 0.9.8 and 1.0.0"></a>4. Remove support for OpenSSL 0.9.8 and 1.0.0</h3><p>Another major change is that PG13 will refuse to be built with OpenSSL versions 1.0.0 and 0.9.8 as these are very old and are no longer considered secured in today’s standard. If you are still using these OpenSSL versions, you will need to upgrade to newer or recent versions to be compatible with PG13.</p>
<h3 id="5-Conclusion"><a href="#5-Conclusion" class="headerlink" title="5. Conclusion"></a>5. Conclusion</h3><p>PG13 brings many exciting new features and enhancements to PostgreSQL and many of these new changes need to be carefully assessed for potential incompatibility with the previous PG versions. Today, our focus is mainly on new updates related to TLS, which may have behavioral impacts to the existing deployment and the way existing client and server communicates using TLS. For the full changes and potential incompatibilities, visit the official change log <a href="https://www.postgresql.org/docs/release/13.0/">here</a></p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/page/0/">Previous</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/page/2/">Next</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/3/">3</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/prof-img.jpg" alt="Cary Huang">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Cary Huang
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Multi-Displined Software Developer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Vancouver</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            24
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            40
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/caryhuang" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/caryhuang">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://www.facebook.com/cary.huang.35">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.etsy.com/ca/shop/ShokuninDesignCo" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Etsy Shop</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.etsy.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.highgo.ca/" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">HighGo Software Canada</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.highgo.ca</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Netsnmp/">
            <span class="level-start">
                <span class="level-item">Netsnmp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/PostgreSQL/">
            <span class="level-start">
                <span class="level-item">PostgreSQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">22</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Tag Cloud
        </h3>
        <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/backend/" style="font-size: 10px;">backend</a> <a href="/tags/buffer-manager/" style="font-size: 10px;">buffer manager</a> <a href="/tags/extension/" style="font-size: 10px;">extension</a> <a href="/tags/external-key-management-system/" style="font-size: 10px;">external key management system</a> <a href="/tags/failover/" style="font-size: 10px;">failover</a> <a href="/tags/fdw/" style="font-size: 10px;">fdw</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/in-memory/" style="font-size: 10px;">in-memory</a> <a href="/tags/in-memory-table/" style="font-size: 10px;">in-memory table</a> <a href="/tags/key-management-system/" style="font-size: 10px;">key management system</a> <a href="/tags/logical-decoding/" style="font-size: 10px;">logical decoding</a> <a href="/tags/logical-replication/" style="font-size: 10px;">logical replication</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/networking/" style="font-size: 17.5px;">networking</a> <a href="/tags/oid/" style="font-size: 10px;">oid</a> <a href="/tags/parallel-worker/" style="font-size: 10px;">parallel worker</a> <a href="/tags/partition/" style="font-size: 10px;">partition</a> <a href="/tags/pg13/" style="font-size: 10px;">pg13</a> <a href="/tags/pg-rewind/" style="font-size: 10px;">pg_rewind</a> <a href="/tags/pluggable-api/" style="font-size: 10px;">pluggable api</a> <a href="/tags/pluggable-storage/" style="font-size: 15px;">pluggable storage</a> <a href="/tags/postgres/" style="font-size: 10px;">postgres</a> <a href="/tags/postgresql/" style="font-size: 20px;">postgresql</a> <a href="/tags/postmaster/" style="font-size: 12.5px;">postmaster</a> <a href="/tags/query-processing/" style="font-size: 10px;">query processing</a> <a href="/tags/replication/" style="font-size: 15px;">replication</a> <a href="/tags/savepoint/" style="font-size: 10px;">savepoint</a> <a href="/tags/security/" style="font-size: 17.5px;">security</a> <a href="/tags/sequence/" style="font-size: 10px;">sequence</a> <a href="/tags/snmp/" style="font-size: 10px;">snmp</a> <a href="/tags/streaming-replication/" style="font-size: 10px;">streaming replication</a> <a href="/tags/subtransaction/" style="font-size: 10px;">subtransaction</a> <a href="/tags/table-access-method/" style="font-size: 12.5px;">table access method</a> <a href="/tags/tde/" style="font-size: 10px;">tde</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/trace/" style="font-size: 10px;">trace</a> <a href="/tags/trigger/" style="font-size: 10px;">trigger</a> <a href="/tags/visibility/" style="font-size: 10px;">visibility</a> <a href="/tags/wal2mongo/" style="font-size: 10px;">wal2mongo</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <a href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/fdw-foreign.png" alt="How to Implement Foreign Scan With FDW Interface API">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-09-03T16:47:45.000Z">2021-09-03</time></div>
                    <a href="/2021/09/03/How-to-Implement-Foreign-Scan-With-FDW-Interface-API/" class="title has-link-black-ter is-size-6 has-text-weight-normal">How to Implement Foreign Scan With FDW Interface API</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/pg-sec-banner.png" alt="Understanding the Security Around PostgreSQL">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-08-06T19:04:08.000Z">2021-08-06</time></div>
                    <a href="/2021/08/06/Understanding-the-Security-Around-PostgreSQL/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Understanding the Security Around PostgreSQL</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/gdb-debug-banner.png" alt="Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-07-09T18:41:55.000Z">2021-07-09</time></div>
                    <a href="/2021/07/09/Using-GDB-To-Trace-Into-a-Parallel-Worker-Spawned-By-Postmaster-During-A-Large-Query/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Using GDB To Trace Into a Parallel Worker Spawned By Postmaster During a Large Query</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/banner-2021-03-03.png" alt="How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-03T20:17:11.000Z">2021-03-03</time></div>
                    <a href="/2021/03/03/How-PostgreSQL-Handles-Sub-Transaction-Visibility-In-Streaming-Replication-Setup/" class="title has-link-black-ter is-size-6 has-text-weight-normal">How PostgreSQL Handles Sub Transaction Visibility In Streaming Replication Setup?</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/tuple-insert-banner.png" alt="How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-02-02T19:35:31.000Z">2021-02-02</time></div>
                    <a href="/2021/02/02/How-PostgreSQL-Inserts-A-New-Record-With-The-help-of-Table-Access-Method-API-and-Buffer-Manager/" class="title has-link-black-ter is-size-6 has-text-weight-normal">How PostgreSQL Inserts A New Record With The help of Table Access Method API and Buffer Manager</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/PostgreSQL/">PostgreSQL</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">September 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/08/">
                <span class="level-start">
                    <span class="level-item">August 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/07/">
                <span class="level-start">
                    <span class="level-item">July 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">March 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/02/">
                <span class="level-start">
                    <span class="level-item">February 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">January 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">November 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">September 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">August 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">July 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">June 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">May 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">April 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">March 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">January 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">October 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">September 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">July 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/architecture/">
                        <span class="tag">architecture</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/backend/">
                        <span class="tag">backend</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/buffer-manager/">
                        <span class="tag">buffer manager</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/extension/">
                        <span class="tag">extension</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/external-key-management-system/">
                        <span class="tag">external key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/failover/">
                        <span class="tag">failover</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/fdw/">
                        <span class="tag">fdw</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/gdb/">
                        <span class="tag">gdb</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory/">
                        <span class="tag">in-memory</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/in-memory-table/">
                        <span class="tag">in-memory table</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/key-management-system/">
                        <span class="tag">key management system</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-decoding/">
                        <span class="tag">logical decoding</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/logical-replication/">
                        <span class="tag">logical replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mongodb/">
                        <span class="tag">mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/networking/">
                        <span class="tag">networking</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/oid/">
                        <span class="tag">oid</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/parallel-worker/">
                        <span class="tag">parallel worker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/partition/">
                        <span class="tag">partition</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg13/">
                        <span class="tag">pg13</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pg-rewind/">
                        <span class="tag">pg_rewind</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-api/">
                        <span class="tag">pluggable api</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pluggable-storage/">
                        <span class="tag">pluggable storage</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgres/">
                        <span class="tag">postgres</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postgresql/">
                        <span class="tag">postgresql</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/postmaster/">
                        <span class="tag">postmaster</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/query-processing/">
                        <span class="tag">query processing</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/replication/">
                        <span class="tag">replication</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/savepoint/">
                        <span class="tag">savepoint</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/security/">
                        <span class="tag">security</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sequence/">
                        <span class="tag">sequence</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/snmp/">
                        <span class="tag">snmp</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/streaming-replication/">
                        <span class="tag">streaming replication</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/subtransaction/">
                        <span class="tag">subtransaction</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/table-access-method/">
                        <span class="tag">table access method</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tde/">
                        <span class="tag">tde</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tls/">
                        <span class="tag">tls</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trace/">
                        <span class="tag">trace</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/trigger/">
                        <span class="tag">trigger</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/visibility/">
                        <span class="tag">visibility</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/wal2mongo/">
                        <span class="tag">wal2mongo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/Simplicity-design-logo.jpg" alt="Cary&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2021 Cary Huang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://caryhuang.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>